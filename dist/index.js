"use strict";(self.webpackChunkbilliards=self.webpackChunkbilliards||[]).push([[57],{"./src/container/container.ts"(e,t,n){n.d(t,{m:()=>J});var r=n("./src/events/stationaryevent.ts"),i=n("./node_modules/three/build/three.core.js"),o=n("./src/utils/utils.ts"),s=n("./src/view/cameratop.ts"),a=n("./src/model/physics/constants.ts");function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");l(this,"camera",void 0),l(this,"mode",this.topView),l(this,"mainMode",this.aimView),l(this,"height",8*a.R),l(this,"elapsed",void 0),this.camera=new i.ubm(45,e,a.R,1e3*a.R)}return e=[{key:"update",value:function(e,t){this.elapsed=e,this.mode(t)}},{key:"topView",value:function(e){this.camera.fov=s.v.fov,this.camera.position.lerp(s.v.viewPoint(this.camera.aspect,this.camera.fov),.9),this.camera.up=o.up,this.camera.lookAt(o.v_)}},{key:"aimView",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.08,n=this.height,r=this.camera.aspect<.8;if(this.camera.fov=r?60:40,n<10*a.R){var i=100*(10*a.R-n);this.camera.fov-=i*(r?3:1)}this.camera.position.lerp(e.pos.clone().addScaledVector((0,o.Dz)(e.angle),-(18*a.R)),t),this.camera.position.z=n,this.camera.up=o.up,this.camera.lookAt(e.pos.clone().addScaledVector(o.up,n/2))}},{key:"adjustHeight",value:function(e){e=this.height<10*a.R?e/8:e,this.height=i.cj9.clamp(this.height+e,6*a.R,120*a.R),this.height>110*a.R&&this.suggestMode(this.topView),this.height<105*a.R&&this.suggestMode(this.aimView)}},{key:"adjustPan",value:function(e,t){this.camera.position.x+=e,this.camera.position.y+=t}},{key:"suggestMode",value:function(e){this.mainMode===this.aimView&&(this.mode=e)}},{key:"forceMode",value:function(e){this.mode=e,this.mainMode=e}},{key:"forceMove",value:function(e){this.mode===this.aimView&&this.aimView(e,1)}},{key:"toggleMode",value:function(){this.mode===this.topView?this.mode=this.aimView:this.mode=this.topView,this.mainMode=this.mode}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),u=n("./src/view/tablegeometry.ts"),h=function(){var e;function t(){var e,n;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");e="material",n=new i.mrM({color:132,opacity:.15,transparent:!0}),e in this?Object.defineProperty(this,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[e]=n}return e=[{key:"generateLineSegments",value:function(){var e=this,t=[this.point(0,-11.13*a.R/.5),this.point(0,11.13*a.R/.5)],n=u.P.X/4,r=u.P.tableY+a.R;[1,2,3,-1,-2,-3].forEach(function(i){t.push(e.point(i*n,-r)),t.push(e.point(i*n,r))});var o=(u.P.Y+a.R)/2,s=u.P.tableX+a.R;[-1,0,1].forEach(function(n){t.push(e.point(-s,n*o)),t.push(e.point(s,n*o))});var l=new i.LoY().setFromPoints(t);return new i.DXC(l,this.material)}},{key:"point",value:function(e,t){var n=-(.485*a.R)/.5;return new i.Pq0(e,t,n)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),p=n("./node_modules/three/build/three.module.js"),f=n("./src/controller/rules/snooker.ts");function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var m=function(){var e;function t(e,n,r){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");d(this,"scene",new i.Z58),d(this,"renderer",void 0),d(this,"camera",void 0),d(this,"windowWidth",1),d(this,"windowHeight",1),d(this,"element",void 0),d(this,"table",void 0),d(this,"loadAssets",!0),d(this,"assets",void 0),d(this,"ballToCheck",0),this.element=e,this.table=n,this.assets=r,this.renderer=function(e){if("u"<typeof process){var t=new p.JeP({antialias:!1});return t.shadowMap.enabled=!1,t.autoClear=!1,t.setSize(e.offsetWidth,e.offsetHeight),t.setPixelRatio(.75*window.devicePixelRatio),e.appendChild(t.domElement),t}}(e),this.camera=new c(e?e.offsetWidth/e.offsetHeight:1),this.initialiseScene()}return e=[{key:"update",value:function(e,t){this.camera.update(e,t)}},{key:"sizeChanged",value:function(){var e,t;return this.windowWidth!=(null==(e=this.element)?void 0:e.offsetWidth)||this.windowHeight!=(null==(t=this.element)?void 0:t.offsetHeight)}},{key:"updateSize",value:function(){var e,t,n=this.sizeChanged();return n&&(this.windowWidth=null==(e=this.element)?void 0:e.offsetWidth,this.windowHeight=null==(t=this.element)?void 0:t.offsetHeight),n}},{key:"render",value:function(){this.isInMotionNotVisible()&&this.camera.suggestMode(this.camera.topView),this.renderCamera(this.camera)}},{key:"renderCamera",value:function(e){var t;if(this.updateSize()){var n,r,i,o,s=this.windowWidth,a=this.windowHeight;null==(n=this.renderer)||n.setSize(s,a),null==(r=this.renderer)||r.setViewport(0,0,s,a),null==(i=this.renderer)||i.setScissor(0,0,s,a),null==(o=this.renderer)||o.setScissorTest(!0),e.camera.aspect=s/a}e.camera.updateProjectionMatrix(),null==(t=this.renderer)||t.render(this.scene,e.camera)}},{key:"initialiseScene",value:function(){this.scene.add(new i.$p8(39202,.3)),this.assets.background&&this.scene.add(this.assets.background),this.scene.add(this.assets.table),this.table.mesh=this.assets.table,this.assets.rules.asset()!==f.c.tablemodel&&this.scene.add(new h().generateLineSegments())}},{key:"isInMotionNotVisible",value:function(){var e=this.viewFrustrum(),t=this.table.balls[this.ballToCheck++%this.table.balls.length];return t.inMotion()&&!e.intersectsObject(t.ballmesh.mesh)}},{key:"viewFrustrum",value:function(){var e=this.camera.camera,t=new i.PPD;return t.setFromProjectionMatrix(new i.kn4().multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),t}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),v=n("./src/controller/init.ts"),y=n("./src/events/input.ts");function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var g=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");b(this,"line",new i.cZY),b(this,"balls",void 0),this.balls=e}return e=[{key:"getFirst",value:function(e,t){var n=this;this.line.set(e.pos,(0,o.xb)(t).multiplyScalar(4*u.P.X).add(e.pos));var r=new i.Pq0,s=this.balls.map(function(t){return n.line.closestPointToPoint(t.pos,!0,r),{ball:t,perpendicular:r.distanceTo(t.pos),distance:r.distanceTo(e.pos)}}).filter(function(e){return e.perpendicular<2*a.R}).filter(function(t){return t.ball!==e});return s.reduce(function(e,t){return e.distance<t.distance?e:t},s[0])}},{key:"getOverlapOffset",value:function(e,t){var n=this.getFirst(e,t);if(n){var r=n.ball.pos.clone().sub(e.pos),i=n.perpendicular*Math.sign(r.cross(t).z)/a.R;return{ball:n.ball,overlap:i}}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var k=function(){var e;function t(e){var n,r=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");w(this,"cueBallElement",void 0),w(this,"cueTipElement",void 0),w(this,"cuePowerElement",void 0),w(this,"cueHitElement",void 0),w(this,"objectBallStyle",void 0),w(this,"container",void 0),w(this,"overlap",void 0),w(this,"ballWidth",void 0),w(this,"ballHeight",void 0),w(this,"tipRadius",void 0),w(this,"mousemove",function(e){1===e.buttons&&r.adjustSpin(e)}),w(this,"powerChanged",function(e){r.container.table.cue.setPower(r.cuePowerElement.value)}),w(this,"hit",function(e){var t;r.container.table.cue.setPower(null==(t=r.cuePowerElement)?void 0:t.value),r.container.inputQueue.push(new y.p(0,"SpaceUp"))}),w(this,"mousewheel",function(e){r.cuePowerElement&&(r.cuePowerElement.value-=Math.sign(e.deltaY)/10,r.container.table.cue.setPower(r.cuePowerElement.value),r.container.lastEventTime=performance.now())}),this.container=e,this.cueBallElement=document.getElementById("cueBall"),this.cueTipElement=document.getElementById("cueTip"),this.cuePowerElement=document.getElementById("cuePower"),this.cueHitElement=document.getElementById("cueHit"),this.objectBallStyle=null==(n=document.getElementById("objectBall"))?void 0:n.style,this.overlap=new g(this.container.table.balls),this.addListeners()}return e=[{key:"addListeners",value:function(){var e,t,n,r,i,o=this;null==(e=this.cueBallElement)||e.addEventListener("pointermove",this.mousemove),null==(t=this.cueBallElement)||t.addEventListener("click",function(e){o.adjustSpin(e)}),null==(n=this.cueHitElement)||n.addEventListener("click",this.hit),null==(r=this.cuePowerElement)||r.addEventListener("change",this.powerChanged),"ontouchstart"in window||null==(i=document.getElementById("viewP1"))||i.addEventListener("dblclick",this.hit),document.addEventListener("wheel",this.mousewheel)}},{key:"setButtonText",value:function(e){this.cueHitElement&&(this.cueHitElement.innerText=e)}},{key:"readDimensions",value:function(){var e,t,n;this.ballWidth=null==(e=this.cueBallElement)?void 0:e.offsetWidth,this.ballHeight=null==(t=this.cueBallElement)?void 0:t.offsetHeight,this.tipRadius=(null==(n=this.cueTipElement)?void 0:n.offsetWidth)/2}},{key:"adjustSpin",value:function(e){this.readDimensions(),this.container.table.cue.setSpin(new i.Pq0(-(e.offsetX-this.ballWidth/2)/this.ballWidth,-(e.offsetY-this.ballHeight/2)/this.ballHeight),this.container.table),this.container.lastEventTime=performance.now()}},{key:"updateVisualState",value:function(e,t){this.readDimensions();var n,r=null==(n=this.cueTipElement)?void 0:n.style;r&&(r.left=(-e+.5)*this.ballWidth-this.tipRadius+"px",r.top=(-t+.5)*this.ballHeight-this.tipRadius+"px"),this.showOverlap()}},{key:"showOverlap",value:function(){if(this.objectBallStyle){var e=this.container.table,t=(0,o.Dz)(e.cue.aim.angle),n=this.overlap.getOverlapOffset(e.cueball,t);n?(this.readDimensions(),this.objectBallStyle.visibility="visible",this.objectBallStyle.left=5+n.overlap*this.ballWidth/2+"px",this.objectBallStyle.backgroundColor=new i.Q1f(0,0,0).lerp(n.ball.ballmesh.color,.5).getStyle()):this.objectBallStyle.visibility="hidden"}}},{key:"updatePowerSlider",value:function(e){var t;e>0&&(null==(t=this.cuePowerElement)?void 0:t.value)&&(this.cuePowerElement.value=e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),x=n("./src/controller/aim.ts"),S=n("./src/controller/watchaim.ts"),P=n("./src/controller/playshot.ts"),T=n("./src/controller/watchshot.ts"),E=n("./src/controller/end.ts"),R=n("./src/controller/placeball.ts"),O=n("./src/controller/playshotauthoritative.ts");function A(e,t){return null!=t&&"u">typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function M(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var C=function(){var e;function t(e){var n,r=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");M(this,"chatoutput",void 0),M(this,"chatInput",void 0),M(this,"chatSend",void 0),M(this,"chatInputText",void 0),M(this,"send",void 0),M(this,"sendClicked",function(e){var t,n;r.send(null==(t=r.chatInputText)?void 0:t.value),r.showMessage(null==(n=r.chatInputText)?void 0:n.value)}),this.chatoutput=document.getElementById("chatoutput"),this.chatInputText=document.getElementById("chatinputtext"),this.chatSend=document.getElementById("chatsend"),null==(n=this.chatSend)||n.addEventListener("click",this.sendClicked),this.send=e}return e=[{key:"showMessage",value:function(e){this.chatoutput&&(this.chatoutput.innerHTML+=e),this.updateScroll()}},{key:"updateScroll",value:function(){this.chatoutput&&(this.chatoutput.scrollTop=this.chatoutput.scrollHeight)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),I=n("./src/events/chatevent.ts"),_=n("./src/events/eventtype.ts");function j(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var B=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");j(this,"period",void 0),j(this,"pending",null),j(this,"sentTime",0),j(this,"apply",function(e){}),this.period=e,this.apply=n}return e=[{key:"flush",value:function(){this.pending&&(this.apply(this.pending),this.pending=null)}},{key:"send",value:function(e){if(performance.now()>this.sentTime+this.period||e.type!==_.B.AIM){this.flush(),this.apply(e),this.sentTime=performance.now();return}this.pending=e}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),L=n("./src/view/sliders.ts"),N=n("./src/model/outcome.ts"),H=n("./node_modules/jsoncrush/JSONCrush.js");function F(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function U(e){return(U=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function z(e,t){return(z=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function D(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(D=function(){return!!e})()}var G=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t,n,i;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return t=U(t=r),e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,D()?Reflect.construct(t,[],U(this).constructor):t.apply(this,void 0)),i=void 0,(n="ballinfo")in e?Object.defineProperty(e,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[n]=i,e.type=_.B.RERACK,e}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&z(r,e),t=[{key:"applyToController",value:function(e){return e.container.table.updateFromSerialised(this.ballinfo),e}}],n=[{key:"fromJson",value:function(e){var t=new r;return t.ballinfo=e,t}}],t&&F(r.prototype,t),n&&F(r,n),r}(n("./src/events/gameevent.ts").F);function q(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var V=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");q(this,"container",void 0),q(this,"shots",[]),q(this,"states",[]),q(this,"start",Date.now()),q(this,"breakStart",void 0),q(this,"breakStartTime",void 0),q(this,"replayUrl",void 0),q(this,"hiScoreUrl","https://scoreboard-tailuge.vercel.app/hiscore.html"),this.container=e}return e=[{key:"record",value:function(e){e.type===_.B.WATCHAIM&&"rerack"in e.json&&(this.states.push(this.container.table.shortSerialise()),this.shots.push(G.fromJson({balls:e.json.balls}))),e.type===_.B.HIT&&(this.states.push(this.container.table.shortSerialise()),this.shots.push(e.tablejson.aim))}},{key:"wholeGame",value:function(){return this.state(this.states[0],this.shots,this.start,this.container.rules.score,!0)}},{key:"last",value:function(){var e=this.states.length-1;return e>0&&"RERACK"===this.shots[e].type&&e--,e}},{key:"lastShot",value:function(){var e=this.last();return this.state(this.states[e],[this.shots[e]])}},{key:"currentBreak",value:function(){if(void 0!==this.breakStart)return this.state(this.states[this.breakStart],this.shots.slice(this.breakStart),this.breakStartTime,this.container.rules.previousBreak)}},{key:"state",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return{init:e,shots:t,start:n,now:Date.now(),score:r,wholeGame:i,v:1}}},{key:"updateBreak",value:function(e){var t=this.container.rules.isPartOfBreak(e),n=this.container.rules.isEndOfGame(e),r=N.P.potCount(e);if(t||this.breakLink(n),this.lastShotLink(t||n,r,N.P.pots(e)),n&&this.breakLink(n),!t){this.breakStart=void 0;return}void 0===this.breakStart&&(this.breakStart=this.last(),this.breakStartTime=Date.now())}},{key:"lastShotLink",value:function(e,t,n){var r="#000000";n.length>0&&n.forEach(function(e){r="#"+e.ballmesh.color.getHexString()});var i="‚öà".repeat(t>1?t-1:0)+(e?"‚öà":"‚öÜ"),o=JSON.stringify(this.lastShot());this.generateLink(i,o,r)}},{key:"breakLink",value:function(e){var t=this.currentBreak();if(t&&(e||t.shots.pop(),1!==t.shots.length)){var n=0===this.container.rules.currentBreak?this.container.rules.previousBreak:this.container.rules.currentBreak;t.score=n;var r=JSON.stringify(t),i=H.A.crush(r);this.generateLink("break(".concat(n,")"),i,"black"),n>=2&&this.generateHiScoreLink(i)}}},{key:"wholeGameLink",value:function(){var e=this.wholeGame(),t="frame(".concat(this.shotCount(e.shots)," shots)"),n=JSON.stringify(e),r=H.A.crush(n);this.generateLink(t,r,"black")}},{key:"shotCount",value:function(e){return e.filter(function(e){return"RERACK"!==e.type}).length}},{key:"generateLink",value:function(e,t,n){var r="".concat(this.replayUrl).concat(this.fullyEncodeURI(t)),i='<a class="pill" style="color: '.concat(n,'" target="_blank" href="').concat(r,'">').concat(e,"</a>");this.container.eventQueue.push(new I.b(null,"".concat(i)))}},{key:"generateHiScoreLink",value:function(e){var t="".concat(this.hiScoreUrl,"?ruletype=").concat(this.container.rules.rulename,"&state=").concat(this.fullyEncodeURI(e)),n='<a class="pill" target="_blank" href="'.concat(t,'">').concat("hi score üèÜ","</a>");this.container.eventQueue.push(new I.b(null,"".concat(n)))}},{key:"fullyEncodeURI",value:function(e){return encodeURIComponent(e).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\!/g,"%21").replace(/\*/g,"%2A")}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),X=n("./src/controller/rules/rulefactory.ts"),W=n("./src/events/breakevent.ts");function K(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Y=function(){var e;function t(e){var n=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");K(this,"container",void 0),K(this,"redo",void 0),K(this,"share",void 0),K(this,"replay",void 0),K(this,"camera",void 0),K(this,"disabled",!0),this.container=e,this.replay=this.getElement("replay"),this.redo=this.getElement("redo"),this.share=this.getElement("share"),this.camera=this.getElement("camera"),this.camera&&(this.setMenu(!0),this.camera.onclick=function(e){n.adjustCamera()})}return e=[{key:"setMenu",value:function(e){this.replay.disabled=e,this.redo.disabled=e,this.share.disabled=e}},{key:"adjustCamera",value:function(){this.container.view.camera.toggleMode(),this.container.lastEventTime=performance.now()}},{key:"replayMode",value:function(e,t){var n=this;if(this.replay){this.setMenu(!1);var r=this.container.eventQueue;this.share.onclick=function(t){!function(e,t){var n;if(("u"<typeof process?"undefined":(n=process)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)=="object")return t(e);fetch("https://scoreboard-tailuge.vercel.app/api/shorten",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:new URL(e.replaceAll("(","%28").replaceAll(")","%29").replaceAll("!","%21").replaceAll("*","%2A")).search})}).then(function(e){return e.json()}).then(function(n){"shortUrl"in n?t(n.shortUrl):(console.log("Could not shorten url:"),console.log(n),t(e))})}(e,function(e){var t,n,i,o,s=(o={title:"Billiards",text:"Replay break",url:e},(null==(t=(n=navigator).canShare)?void 0:t.call(n,o))?(navigator.share(o).then(function(){return console.log("shared successfully")}).catch(function(e){console.log("Error: "+e)}),"link shared"):(null==(i=navigator.clipboard)||i.writeText(e),'link copied to clipboard <a href="'.concat(e,'">').concat(e,"</a>")));r.push(new I.b(null,s))})},this.redo.onclick=function(e){var r=new W.W(t.init,t.shots);r.retry=!0,n.interuptEventQueue(r)},this.replay.onclick=function(e){n.interuptEventQueue(t)}}}},{key:"interuptEventQueue",value:function(e){this.container.table.halt();var t=this.container.eventQueue;t.length=0,t.push(new r.T),t.push(e)}},{key:"getElement",value:function(e){return document.getElementById(e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),Q=n("./src/view/ballmesh.ts");function Z(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var J=function(){var e;function t(e,r,i,o,s,a){var l=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");Z(this,"table",void 0),Z(this,"view",void 0),Z(this,"controller",void 0),Z(this,"inputQueue",[]),Z(this,"eventQueue",[]),Z(this,"keyboard",void 0),Z(this,"sound",void 0),Z(this,"chat",void 0),Z(this,"sliders",void 0),Z(this,"recorder",void 0),Z(this,"id",""),Z(this,"isSinglePlayer",!0),Z(this,"rules",void 0),Z(this,"menu",void 0),Z(this,"frame",void 0),Z(this,"hud",void 0),Z(this,"last",performance.now()),Z(this,"step",.001953125),Z(this,"broadcast",function(){}),Z(this,"reportShotComplete",function(){}),Z(this,"log",void 0),Z(this,"useServerAuthoritative",!1),Z(this,"submitAuthoritativeShot",function(){}),Z(this,"submitPlaceBall",function(){}),Z(this,"isMyTurn",!0),Z(this,"ballInHand",!1),Z(this,"behindHeadString",!1),Z(this,"sendChat",function(e){l.sendEvent(new I.b(l.id,e))}),Z(this,"throttle",new B(0,function(e){l.broadcast(e)})),Z(this,"lastEventTime",performance.now()),Z(this,"sendAimUpdate",void 0),Z(this,"sendBallPosUpdate",void 0),this.log=r,this.rules=X.V.create(o,this),i.ballModels&&i.ballModels.size>0&&(Q.J.ballModels=i.ballModels),this.table=this.rules.table(),this.view=new m(e,this.table,i),this.table.cue.aimInputs=new k(this),this.keyboard=s,this.sound=i.sound,this.chat=new C(this.sendChat),this.sliders=new L.r,this.recorder=new V(this),this.id=a,this.menu=new Y(this);try{var c=n("./src/view/hud.ts"),u=c.SnookerHud,h=c.EightBallHud,p=c.Hud;"snooker"===o?this.hud=new u:"eightball"===o?this.hud=new h:this.hud=new p}catch(e){var f=n("./src/view/hud.ts").Hud;this.hud=new f}this.table.addToScene(this.view.scene),this.updateController(new v.J(this))}return e=[{key:"sendEvent",value:function(e){this.throttle.send(e)}},{key:"advance",value:function(e){null==(t=this.frame)||t.call(this,e);for(var t,n=Math.floor(e/this.step),i=n*this.step,o=this.table.allStationary(),s=0;s<n;s++)this.table.advance(this.step);this.table.updateBallMesh(i),this.view.update(i,this.table.cue.aim),this.table.cue.update(i),!o&&this.table.allStationary()&&this.eventQueue.push(new r.T),this.sound.processOutcomes(this.table.outcome)}},{key:"processEvents",value:function(){var e=this;for(this.keyboard&&this.keyboard.getEvents().forEach(function(t){return e.inputQueue.push(t)});this.inputQueue.length>0;){this.lastEventTime=this.last;var t=this.inputQueue.shift();t&&this.updateController(this.controller.handleInput(t))}if(this.table.allStationary()){var n=this.eventQueue.shift();n&&(console.log("[ProcessEvents] Processing event:",n.constructor.name,"Controller:",this.controller.constructor.name),this.lastEventTime=performance.now(),this.updateController(n.applyToController(this.controller)))}else this.eventQueue.length>0&&console.log("[ProcessEvents] Waiting for table to be stationary. Queue:",this.eventQueue.length,"events")}},{key:"animate",value:function(e){var t=this;this.advance((e-this.last)/1e3),this.last=e,this.processEvents(),(e<this.lastEventTime+12e3||!this.table.allStationary()||this.view.sizeChanged())&&this.view.render(),requestAnimationFrame(function(e){t.animate(e)})}},{key:"updateController",value:function(e){e!==this.controller&&(this.log("Transition to "+(A(e,v.J)?"Init":A(e,R.x)?"PlaceBall":A(e,x.m)?"Aim":A(e,S.r)?"WatchAim":A(e,P.H)?"PlayShot":A(e,O.G)?"PlayShotAuthoritative":A(e,T.O)?"WatchShot":A(e,E.o)?"End":"UNKNOWN")),this.controller=e,this.controller.onFirst())}},{key:"setTurnState",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.isMyTurn=e,this.ballInHand=n,this.behindHeadString=r,(null==(t=this.hud)?void 0:t.updateTurn)&&this.hud.updateTurn(e),this.useServerAuthoritative&&(this.table.cue.mesh.visible=e,this.table.cue.helperMesh.visible=e&&this.table.cue.helperMesh.visible,this.table.cue.placerMesh.visible=e&&n),console.log("Turn state updated: myTurn=".concat(e,", ballInHand=").concat(n,", behindHeadString=").concat(r))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/aim.ts"(e,t,n){n.d(t,{m:()=>u});var r=n("./src/controller/controller.ts"),i=n("./src/controller/controllerbase.ts"),o=n("./src/controller/playshot.ts"),s=n("./src/controller/playshotauthoritative.ts");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");t=n,r=[e],t=a(t);var t,r,i,o=(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(t,r||[],a(this).constructor):t.apply(this,r))).container.table;return o.cue.aimMode(),o.cue.showHelper(!0),o.cue.mesh.visible=!0,o.cueball=i.container.rules.cueball,o.cue.moveTo(o.cueball.pos),i.container.view.camera.forceMode(i.container.view.camera.aimView),o.cue.aimInputs.showOverlap(),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"handleInput",value:function(e){if(this.container.useServerAuthoritative&&!this.container.isMyTurn){switch(e.key){case"Space":case"SpaceUp":this.container.chat.showMessage("Not your turn!");break;default:!this.commonKeyHandler(e)}return this}switch(e.key){case"Space":this.container.table.cue.adjustPower(e.t*this.scale*.7);break;case"SpaceUp":return this.playShot();default:if(!this.commonKeyHandler(e))return this}if(this.container.sendAimUpdate){var t=this.container.table.cue.aim;this.container.sendAimUpdate(t.angle,{x:t.pos.x,y:t.pos.y,z:t.pos.z})}return this.container.sendEvent(this.container.table.cue.aim),this}},{key:"handleBreak",value:function(e){return this}},{key:"playShot",value:function(){if(this.container.useServerAuthoritative){var e=this.container.table.cue.aim;this.container.submitAuthoritativeShot(e);var t=new r.Qe(this.container.table.serialise());return this.container.recorder.record(t),new s.G(this.container)}var n=new r.Qe(this.container.table.serialise());return this.container.sendEvent(n),this.container.recorder.record(n),new o.H(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/controller.ts"(e,t,n){n.d(t,{xI:()=>h,Qe:()=>c,pd:()=>u.p}),n("./src/events/beginevent.ts"),n("./src/events/aimevent.ts");var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e){var t,n,o,a;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return n=s(n=r),t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(n,[],s(this).constructor):n.apply(this,void 0)),a=void 0,(o="tablejson")in t?Object.defineProperty(t,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[o]=a,t.type=i.B.HIT,t.tablejson=e,t}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleHit(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.tablejson)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F),u=n("./src/events/input.ts");n("./src/events/abortevent.ts"),n("./src/events/stationaryevent.ts");var h=function(){var e;function t(e){var n,r;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r=void 0,(n="container")in this?Object.defineProperty(this,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):this[n]=r,this.container=e}return e=[{key:"handleInput",value:function(e){return this}},{key:"handleBegin",value:function(e){return this}},{key:"handleBreak",value:function(e){return this}},{key:"handleStartAim",value:function(e){return this}},{key:"handleAim",value:function(e){return this}},{key:"handleHit",value:function(e){return this}},{key:"handleAbort",value:function(e){return this}},{key:"handleWatch",value:function(e){return this}},{key:"handlePlaceBall",value:function(e){return this}},{key:"handleStationary",value:function(e){return this}},{key:"handleChat",value:function(e){return this}},{key:"handleRejoin",value:function(e){return this}},{key:"onFirst",value:function(){}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/controllerbase.ts"(e,t,n){n.d(t,{y:()=>h});var r=n("./src/controller/controller.ts"),i=n("./src/utils/gltf.ts"),o=n("./src/model/outcome.ts"),s=n("./node_modules/three/build/three.core.js");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){return e&&"u">typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(u=function(){return!!e})()}var h=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=n,r=arguments,t=a(t),e=function(e,t){if(t&&("object"===c(t)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,u()?Reflect.construct(t,r||[],a(this).constructor):t.apply(this,r)),(i="scale")in e?Object.defineProperty(e,i,{value:.001,enumerable:!0,configurable:!0,writable:!0}):e[i]=.001,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"hit",value:function(){this.container.table.outcome=[o.P.hit(this.container.table.cueball,this.container.table.cue.aim.power)],this.container.table.hit(),this.container.view.camera.suggestMode(this.container.view.camera.topView),this.container.table.cue.showHelper(!1)}},{key:"commonKeyHandler",value:function(e){var t=this.container.table.cue,n=e.t*this.scale;switch(e.key){case"ArrowLeft":return t.rotateAim(-n,this.container.table),!0;case"ArrowRight":return t.rotateAim(n,this.container.table),!0;case"ArrowDown":return t.adjustSpin(new s.Pq0(0,-n),this.container.table),!0;case"ArrowUp":return t.adjustSpin(new s.Pq0(0,n),this.container.table),!0;case"ShiftArrowLeft":return t.adjustSpin(new s.Pq0(n,0),this.container.table),!0;case"ShiftArrowRight":return t.adjustSpin(new s.Pq0(-n,0),this.container.table),!0;case"KeyPUp":return(0,i.KP)(this.container.view.scene),!0;case"KeyHUp":return t.toggleHelper(),!0;case"movementXUp":return t.rotateAim(-(2*n),this.container.table),!0;case"movementYUp":case"NumpadSubtract":case"NumpadAdd":return this.container.view.camera.adjustHeight(-(8*n)),!0;case"KeyOUp":return this.container.view.camera.toggleMode(),!0;case"KeyDUp":return this.togglePanel(),!0;case"KeyFUp":return this.toggleFullscreen(),!0;default:return!1}}},{key:"togglePanel",value:function(){this.container.sliders.toggleVisibility(),this.container.table.showSpin(!0),this.container.table.showTraces(!0),("u"<typeof process?"undefined":c(process))!=="object"&&console.log(this.container.table.serialise())}},{key:"toggleFullscreen",value:function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/end.ts"(e,t,n){n.d(t,{o:()=>l});var r=n("./src/controller/controller.ts"),i=n("./src/controller/init.ts");function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return e=n,t=arguments,e=o(e),function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(e,t||[],o(this).constructor):e.apply(this,t))}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&s(n,e),t=[{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleBegin",value:function(e){return new i.J(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/init.ts"(e,t,n){n.d(t,{J:()=>m});var r=n("./src/events/watchevent.ts"),i=n("./src/controller/watchaim.ts"),o=n("./src/controller/controllerbase.ts"),s=n("./src/controller/placeball.ts");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i,o,s;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=a(r),t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(r,i||[],a(this).constructor):r.apply(this,i)),s=[],(o="messages")in t?Object.defineProperty(t,o,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[o]=s,console.log("Spectate mode"),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return console.log("Spectate Hit"),this.container.table.updateFromSerialised(e.tablejson),this.container.table.outcome=[],this.container.table.hit(),this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(o.y),h=n("./src/network/client/session.ts");function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function d(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(d=function(){return!!e})()}var m=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function o(){var e,t;if(!(this instanceof o))throw TypeError("Cannot call a class as a function");return e=o,t=arguments,e=p(e),function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,d()?Reflect.construct(e,t||[],p(this).constructor):e.apply(this,t))}return o.prototype=Object.create(e&&e.prototype,{constructor:{value:o,writable:!0,configurable:!0}}),e&&f(o,e),t=[{key:"handleBegin",value:function(e){return h.N.isSpectator()?(this.container.chat.showMessage("Spectator mode"),new u(this.container)):(this.container.chat.showMessage("Start"),this.container.sendEvent(new r.Q(this.container.table.serialise())),new s.x(this.container))}},{key:"handleWatch",value:function(e){return this.container.chat.showMessage("Opponent to break"),this.container.rules.secondToPlay(),this.container.table.updateFromSerialised(e.json),new i.r(this.container)}},{key:"handleBreak",value:function(e){if(this.container.useServerAuthoritative&&!this.container.isMyTurn)return new i.r(this.container);return new s.x(this.container)}},{key:"handlePlaceBall",value:function(e){return console.log("[Init] handlePlaceBall - transitioning to PlaceBall"),new s.x(this.container)}},{key:"handleStartAim",value:function(e){return console.log("[Init] handleStartAim - transitioning to Aim"),new(n("./src/controller/aim.ts")).m(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(o.prototype,t),o}(o.y)},"./src/controller/placeball.ts"(e,t,n){n.d(t,{x:()=>f});var r=n("./src/controller/controllerbase.ts"),i=n("./src/controller/controller.ts"),o=n("./src/controller/aim.ts"),s=n("./src/events/breakevent.ts"),a=n("./src/model/physics/constants.ts"),l=n("./node_modules/three/build/three.core.js"),c=n("./src/view/cuemesh.ts");function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var f=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i,o,s,l;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=u(r),o=t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(r,i||[],u(this).constructor):r.apply(this,i)),s="placescale",l=.02*a.R,s in o?Object.defineProperty(o,s,{value:l,enumerable:!0,configurable:!0,writable:!0}):o[s]=l,t.container.table.cue.moveTo(t.container.table.cueball.pos),t.container.table.cue.aim.power=0,t.container.view.camera.forceMode(t.container.view.camera.topView),t.container.table.cue.placerMesh.visible=!0,t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&h(n,e),t=[{key:"onFirst",value:function(){var e=this.container.table.cueball;this.container.rules.allowsPlaceBall()&&e.pos.copy(this.container.rules.placeBall()),e.setStationary(),e.updateMesh(0),this.container.table.cue.placeBallMode(),this.container.table.cue.showHelper(!1),this.container.table.cue.moveTo(this.container.table.cueball.pos),this.container.table.cue.aimInputs.setButtonText(`Place
Ball`),this.container.rules.allowsPlaceBall()||this.container.inputQueue.push(new i.pd(1,"SpaceUp"))}},{key:"handleInput",value:function(e){if(this.container.useServerAuthoritative&&!this.container.isMyTurn)return this;var t=this.container.table.cueball.pos;switch(e.key){case"ArrowLeft":case"KeyI":this.moveTo(0,e.t*this.placescale);break;case"ArrowRight":case"KeyK":this.moveTo(0,-e.t*this.placescale);break;case"movementXUp":this.moveTo(e.t*this.placescale*2,0);break;case"movementYUp":this.moveTo(0,-e.t*this.placescale*2);break;case"KeyJ":this.moveTo(-e.t*this.placescale,0);break;case"KeyL":this.moveTo(e.t*this.placescale,0);break;case"SpaceUp":return this.placed();default:this.commonKeyHandler(e)}return this.container.table.cue.moveTo(t),this.container.sendEvent(this.container.table.cue.aim),this.container.sendBallPosUpdate&&this.container.sendBallPosUpdate({x:t.x,y:t.y,z:t.z}),this}},{key:"moveTo",value:function(e,t){var n=new l.Pq0(e,t),r=this.container.table.cueball.pos.add(n);r.copy(this.container.rules.placeBall(r)),c.l.indicateValid(!this.container.table.overlapsAny(r))}},{key:"placed",value:function(){if(this.container.table.overlapsAny(this.container.table.cueball.pos))return this;if(this.container.table.cue.aimInputs.setButtonText("Hit"),this.container.sound.playNotify(),!this.container.useServerAuthoritative)return this.container.sendEvent(new s.W(this.container.table.shortSerialise())),new o.m(this.container);var e=this.container.table.cueball.pos;return console.log("[PlaceBall] Sending ball placement to server:",e),this.container.submitPlaceBall({x:e.x,y:e.y,z:e.z}),this}},{key:"handleStartAim",value:function(e){return console.log("[PlaceBall] handleStartAim - server confirmed ball placement, transitioning to Aim"),new o.m(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.y)},"./src/controller/playshot.ts"(e,t,n){n.d(t,{H:()=>a});var r=n("./src/controller/controllerbase.ts");function i(e){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function s(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(s=function(){return!!e})()}var a=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,o=[e],r=i(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,s()?Reflect.construct(r,o||[],i(this).constructor):r.apply(this,o))).hit(),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&o(n,e),t=[{key:"handleStationary",value:function(e){var t=this.container.table,n=t.outcome,r=this.container.rules.update(n);return this.container.recorder.updateBreak(n),t.cue.aimAtNext(t.cueball,this.container.rules.nextCandidateBall()),r}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.y)},"./src/controller/playshotauthoritative.ts"(e,t,n){n.d(t,{G:()=>p});var r=n("./src/controller/controllerbase.ts"),i=n("./src/model/outcome.ts"),o=n("./src/controller/aim.ts"),s=n("./src/controller/placeball.ts"),a=n("./src/controller/watchaim.ts"),l=n("./src/controller/end.ts");function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(h=function(){return!!e})()}var p=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,o=[e],r=c(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,h()?Reflect.construct(r,o||[],c(this).constructor):r.apply(this,o))).container.table.cue.mesh.visible=!1,t.container.table.cue.showHelper(!1),t.container.view.camera.suggestMode(t.container.view.camera.topView),t.container.table.outcome=[i.P.hit(t.container.table.cueball,t.container.table.cue.aim.power)],console.log("[PlayShotAuthoritative] Waiting for server physics"),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&u(n,e),t=[{key:"handleStationary",value:function(e){console.log("[PlayShotAuthoritative] Server reported stationary - waiting for turnChange");var t=this.container.table;return this.container.recorder.updateBreak(t.outcome),t.cue.aimAtNext(t.cueball,this.container.rules.nextCandidateBall()),this}},{key:"handleStartAim",value:function(e){return console.log("[PlayShotAuthoritative] handleStartAim - my turn to shoot"),new o.m(this.container)}},{key:"handlePlaceBall",value:function(e){return console.log("[PlayShotAuthoritative] handlePlaceBall - ball in hand"),new s.x(this.container)}},{key:"handleWatch",value:function(e){return console.log("[PlayShotAuthoritative] handleWatch - opponent's turn"),new a.r(this.container)}},{key:"handleAbort",value:function(e){return console.log("[PlayShotAuthoritative] Game over"),new l.o(this.container)}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.y)},"./src/controller/rules/rulefactory.ts"(e,t,n){n.d(t,{V:()=>I});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/controller/aim.ts"),o=n("./src/controller/placeball.ts"),s=n("./src/controller/watchaim.ts"),a=n("./src/events/chatevent.ts"),l=n("./src/events/placeballevent.ts"),c=n("./src/events/watchevent.ts"),u=n("./src/model/outcome.ts"),h=n("./src/model/table.ts"),p=n("./src/utils/rack.ts"),f=n("./src/utils/utils.ts"),d=n("./src/controller/end.ts"),m=n("./src/model/physics/constants.ts"),v=n("./src/view/tablegeometry.ts"),y=n("./src/events/startaimevent.ts");function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var g=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");b(this,"container",void 0),b(this,"cueball",void 0),b(this,"currentBreak",0),b(this,"previousBreak",0),b(this,"score",0),b(this,"rulename","eightball"),b(this,"playerGroup",null),b(this,"opponentGroup",null),b(this,"isBreakShot",!0),b(this,"ballInHandBehindHeadString",!1),this.container=e}return e=[{key:"startTurn",value:function(){var e,t;this.previousBreak=this.currentBreak,this.currentBreak=0,null==(t=this.container)||null==(e=t.hud)||e.updateBreak(this.currentBreak)}},{key:"nextCandidateBall",value:function(){var e=this.container.table;if(null===this.playerGroup)return e.balls.find(function(e){return 1===e.id&&e.onTable()})||e.balls[0];var t=this.getPlayerBalls();return 0===t.length?e.balls.find(function(e){return 8===e.id&&e.onTable()})||e.balls[0]:t[0]}},{key:"placeBall",value:function(e){if(e){if((null==(n=this.container)?void 0:n.useServerAuthoritative)?this.container.behindHeadString:this.isBreakShot||this.ballInHandBehindHeadString){var t,n,i=new r.Pq0(-v.P.X/2,v.P.tableY),o=new r.Pq0(-v.P.tableX,-v.P.tableY);return e.clamp(o,i)}var s=new r.Pq0(v.P.tableX,v.P.tableY),a=new r.Pq0(-v.P.tableX,-v.P.tableY);return e.clamp(a,s)}return((null==(t=this.container)?void 0:t.useServerAuthoritative)?this.container.behindHeadString:this.isBreakShot)?new r.Pq0(-(11*m.R)/.5,0,0):this.container.table?this.container.table.cueball.pos.clone():new r.Pq0(0,0,0)}},{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"tableGeometry",value:function(){v.P.hasPockets=!0}},{key:"table",value:function(){var e=new h.X(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return p.m.eightBall()}},{key:"getPlayerBalls",value:function(){var e=this.container.table;return null===this.playerGroup?[]:"solids"===this.playerGroup?e.balls.filter(function(e){return e.id>=1&&e.id<=7&&e.onTable()}):e.balls.filter(function(e){return e.id>=9&&e.id<=15&&e.onTable()})}},{key:"getOpponentBalls",value:function(){var e=this.container.table;return null===this.opponentGroup?[]:"solids"===this.opponentGroup?e.balls.filter(function(e){return e.id>=1&&e.id<=7&&e.onTable()}):e.balls.filter(function(e){return e.id>=9&&e.id<=15&&e.onTable()})}},{key:"assignGroups",value:function(e){if(null===this.playerGroup){var t,n,r,i,o,s,l=null!=(t=null==(n=e.ballmesh)?void 0:n.ballNumber)?t:e.id;l>=1&&l<=7?(this.playerGroup="solids",this.opponentGroup="stripes",this.container.eventQueue.push(new a.b(null,"You are solids")),null==(i=this.container)||null==(r=i.hud)||r.updateGroups(this.playerGroup)):l>=9&&l<=15&&(this.playerGroup="stripes",this.opponentGroup="solids",this.container.eventQueue.push(new a.b(null,"You are stripes")),null==(s=this.container)||null==(o=s.hud)||o.updateGroups(this.playerGroup))}}},{key:"isLegalBreak",value:function(e){return u.P.pots(e).length>0||e.filter(function(e){return e.type===u.$.Cushion}).length>=4}},{key:"isLegalShot",value:function(e){var t=this.container.table,n=e.find(function(e){return e.type===u.$.Collision});if(!n)return!1;if(this.isBreakShot)return!0;if(null===this.playerGroup){var r=n.ballB;return(null==r?void 0:r.id)!==8}if(0===this.getPlayerBalls().length){var i=t.balls.find(function(e){return 8===e.id});if(n.ballB!==i)return!1}else{var o=n.ballB;if("solids"===this.playerGroup){if(!o||o.id<1||o.id>7)return!1}else if(!o||o.id<9||o.id>15)return!1}var s=u.P.pots(e),a=e.some(function(e){return e.type===u.$.Cushion});return s.length>0||a}},{key:"update",value:function(e){var t=this,n=this.container.table,r=u.P.pots(e),h=r.some(function(e){return 8===e.id}),m=u.P.isCueBallPotted(n.cueball,e);if(this.isBreakShot&&h)if(!m)return this.container.eventQueue.push(new a.b(null,"8-ball pocketed on break - spotted")),this.isBreakShot=!1,this.container.sendEvent(new c.Q(n.serialise())),new i.m(this.container);else return(this.container.eventQueue.push(new a.b(null,"8-ball pocketed with scratch on break. Opponent's option: re-rack or spot 8-ball")),this.isBreakShot=!1,this.ballInHandBehindHeadString=!0,this.startTurn(),this.container.table.cueball.pos.copy(p.m.spot),this.container.isSinglePlayer)?new o.x(this.container):(this.container.sendEvent(new l.z(f.v_,!0)),new s.r(this.container));if(this.isBreakShot){if(this.isBreakShot=!1,m)return this.isLegalBreak(e)?(this.container.eventQueue.push(new a.b(null,"Scratch on break. Ball in hand behind head string")),this.ballInHandBehindHeadString=!0,this.startTurn(),this.container.table.cueball.pos.copy(p.m.spot),null==(g=this.container)||null==(b=g.hud)||b.updateBreak(this.currentBreak),this.container.isSinglePlayer)?new o.x(this.container):(this.container.reportShotComplete(!1,!0,!1),this.container.sendEvent(new l.z(f.v_,!0)),new s.r(this.container)):(this.container.eventQueue.push(new a.b(null,"Illegal break. Opponent may re-rack or shoot")),this.ballInHandBehindHeadString=!0,this.startTurn(),this.container.table.cueball.pos.copy(p.m.spot),null==(k=this.container)||null==(w=k.hud)||w.updateBreak(this.currentBreak),this.container.isSinglePlayer)?new o.x(this.container):(this.container.reportShotComplete(!1,!0,!1),this.container.sendEvent(new l.z(f.v_,!0)),new s.r(this.container));return this.isLegalBreak(e)?r.length>0?((this.container.sound.playSuccess(n.inPockets()),this.container.isSinglePlayer)?this.container.sendEvent(new c.Q(n.serialise())):this.container.reportShotComplete(!0,!1,!0),new i.m(this.container)):(this.startTurn(),this.container.sendEvent(new y.M),this.container.isSinglePlayer)?(this.container.sendEvent(new c.Q(n.serialise())),new i.m(this.container)):(this.container.reportShotComplete(!1,!1,!1),new s.r(this.container)):(this.container.eventQueue.push(new a.b(null,"Illegal break. Opponent may re-rack or shoot")),this.startTurn(),this.container.sendEvent(new y.M),this.container.isSinglePlayer)?(this.container.sendEvent(new c.Q(n.serialise())),new i.m(this.container)):(this.container.reportShotComplete(!1,!0,!1),new s.r(this.container))}if(h){var v=this.getPlayerBalls();return m?this.container.eventQueue.push(new a.b(null,"You lose! Scratched while pocketing 8-ball")):v.length>0?this.container.eventQueue.push(new a.b(null,"You lose! 8-ball potted early")):r.filter(function(e){return"solids"===t.playerGroup?e.id>=1&&e.id<=7:e.id>=9&&e.id<=15}).length>0?this.container.eventQueue.push(new a.b(null,"You lose! 8-ball and own ball pocketed on same shot")):this.isLegalShot(e)?this.container.eventQueue.push(new a.b(null,"You win! 8-ball legally pocketed")):this.container.eventQueue.push(new a.b(null,"You lose! 8-ball potted on illegal shot")),this.container.recorder.wholeGameLink(),new d.o(this.container)}if(m)return(this.container.eventQueue.push(new a.b(null,"Foul: Scratch. Opponent gets ball in hand")),this.ballInHandBehindHeadString=!1,this.startTurn(),this.container.table.cueball.pos.copy(p.m.spot),null==(S=this.container)||null==(x=S.hud)||x.updateBreak(this.currentBreak),this.container.isSinglePlayer)?new o.x(this.container):(this.container.reportShotComplete(!1,!0,!1),this.container.sendEvent(new l.z(f.v_,!0)),new s.r(this.container));if(!this.isLegalShot(e))return(this.container.eventQueue.push(new a.b(null,"Foul: Illegal shot. Opponent gets ball in hand")),this.ballInHandBehindHeadString=!1,this.startTurn(),this.container.sendEvent(new y.M),this.container.table.cueball.pos.copy(p.m.spot),this.container.isSinglePlayer)?(this.container.sendEvent(new c.Q(n.serialise())),new o.x(this.container)):(this.container.reportShotComplete(!1,!0,!1),this.container.sendEvent(new l.z(f.v_,!0)),new s.r(this.container));if(null===this.playerGroup&&r.length>0){var b,g,w,k,x,S,P,T,E,R,O=r[0];O.id>=1&&O.id<=7?(this.playerGroup="solids",this.opponentGroup="stripes",this.container.eventQueue.push(new a.b(null,"You are solids")),null==(T=this.container)||null==(P=T.hud)||P.updateGroups(this.playerGroup)):O.id>=9&&O.id<=15&&(this.playerGroup="stripes",this.opponentGroup="solids",this.container.eventQueue.push(new a.b(null,"You are stripes")),null==(R=this.container)||null==(E=R.hud)||E.updateGroups(this.playerGroup))}var A=r.filter(function(e){return 8!==e.id&&(null===t.playerGroup||("solids"===t.playerGroup?e.id>=1&&e.id<=7:e.id>=9&&e.id<=15))});return A.length>0?((this.currentBreak+=A.length,this.score+=A.length,this.container.sound.playSuccess(n.inPockets()),this.container.isSinglePlayer)?this.container.sendEvent(new c.Q(n.serialise())):this.container.reportShotComplete(!0,!1,!0),new i.m(this.container)):(this.startTurn(),this.container.sendEvent(new y.M),this.container.isSinglePlayer)?(this.container.sendEvent(new c.Q(n.serialise())),new i.m(this.container)):(this.container.reportShotComplete(!1,!1,!1),new s.r(this.container))}},{key:"isPartOfBreak",value:function(e){var t=this,n=u.P.pots(e);return 0!==n.length&&n.filter(function(e){return 8!==e.id&&(null===t.playerGroup||("solids"===t.playerGroup?e.id>=1&&e.id<=7:e.id>=9&&e.id<=15))}).length>0&&this.isLegalShot(e)}},{key:"isEndOfGame",value:function(e){var t=this.container.table.balls.find(function(e){return 8===e.id});return!!t&&!t.onTable()}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"allowsPlaceBall",value:function(){return!0}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),w=n("./src/utils/respot.ts");function k(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var x=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");k(this,"container",void 0),k(this,"cueball",void 0),k(this,"currentBreak",0),k(this,"previousBreak",0),k(this,"score",0),k(this,"rulename","nineball"),this.container=e}return e=[{key:"startTurn",value:function(){this.previousBreak=this.currentBreak,this.currentBreak=0}},{key:"nextCandidateBall",value:function(){return w.k.closest(this.container.table.cueball,this.container.table.balls)}},{key:"placeBall",value:function(e){if(e){var t=new r.Pq0(-v.P.X/2,v.P.tableY),n=new r.Pq0(-v.P.tableX,-v.P.tableY);return e.clamp(n,t)}return new r.Pq0(-(11*m.R)/.5,0,0)}},{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"tableGeometry",value:function(){v.P.hasPockets=!0}},{key:"table",value:function(){var e=new h.X(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return p.m.diamond()}},{key:"update",value:function(e){var t=this.container.table;if(u.P.isCueBallPotted(t.cueball,e))return(this.startTurn(),this.container.isSinglePlayer)?new o.x(this.container):(this.container.reportShotComplete(!1,!0,!1),new s.r(this.container));if(u.P.isBallPottedNoFoul(t.cueball,e)){var n=u.P.potCount(e);return(this.currentBreak+=n,this.score+=n,this.container.sound.playSuccess(t.inPockets()),this.isEndOfGame(e))?(this.container.eventQueue.push(new a.b(null,"game over")),this.container.recorder.wholeGameLink(),new d.o(this.container)):(this.container.isSinglePlayer?this.container.sendEvent(new c.Q(t.serialise())):this.container.reportShotComplete(!0,!1,!0),new i.m(this.container))}return this.container.isSinglePlayer?(this.container.sendEvent(new y.M),this.container.sendEvent(new c.Q(t.serialise())),this.startTurn(),new i.m(this.container)):(this.container.reportShotComplete(!1,!1,!1),new s.r(this.container))}},{key:"isPartOfBreak",value:function(e){return u.P.isBallPottedNoFoul(this.container.table.cueball,e)}},{key:"isEndOfGame",value:function(e){var t=this.container.table.balls.filter(function(e){return e.onTable()});return 1===t.length&&t[0]===this.cueball}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"allowsPlaceBall",value:function(){return!0}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function S(e,t,n){return(S="u">typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=P(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n||e):i.value}})(e,t,n||e)}function P(e){return(P=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function T(e,t){return(T=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function E(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(E=function(){return!!e})()}var R=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=P(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,E()?Reflect.construct(r,i||[],P(this).constructor):r.apply(this,i))).rulename="fourteenone",t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&T(n,e),t=[{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"rack",value:function(){return p.m.triangle()}},{key:"update",value:function(e){var t=this.container.table;return this.checkRerack(t),S(P(n.prototype),"update",this).call(this,e)}},{key:"checkRerack",value:function(e){var t=e.balls.filter(function(e){return e.onTable()}).filter(function(t){return t!==e.cueball});if(1===t.length){p.m.rerack(t[0],e),this.container.sound.playSuccess(e.inPockets());var n,r,i=e.serialise(),o=new c.Q((n=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){var r;r=n[t],t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r})}return e}({},i),r=r={rerack:!0},Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)):(function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n.push.apply(n,r)}return n})(Object(r)).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(r,e))}),n));this.container.sendEvent(o),this.container.recorder.record(o),this.container.recorder.wholeGameLink()}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(x),O=n("./src/controller/rules/snooker.ts"),A=n("./src/view/cameratop.ts");function M(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var C=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");M(this,"container",void 0),M(this,"cueball",void 0),M(this,"currentBreak",0),M(this,"previousBreak",0),M(this,"score",0),M(this,"rulename","threecushion"),this.container=e}return e=[{key:"startTurn",value:function(){}},{key:"nextCandidateBall",value:function(){return w.k.closest(this.container.table.cueball,this.container.table.balls)}},{key:"placeBall",value:function(e){return f.v_}},{key:"asset",value:function(){return"models/threecushion.min.gltf"}},{key:"secondToPlay",value:function(){this.cueball=this.container.table.balls[1]}},{key:"tableGeometry",value:function(){v.P.tableX=49*m.R,v.P.tableY=24*m.R,v.P.X=v.P.tableX+m.R,v.P.Y=v.P.tableY+m.R,v.P.hasPockets=!1}},{key:"table",value:function(){this.tableGeometry(),A.v.zoomFactor=.92;var e=new h.X(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return p.m.three()}},{key:"update",value:function(e){return u.P.isThreeCushionPoint(this.cueball,e)?(this.container.sound.playSuccess(e.length/3),this.container.sendEvent(new c.Q(this.container.table.serialise())),this.currentBreak++,this.score++,new i.m(this.container)):(this.previousBreak=this.currentBreak,this.currentBreak=0,this.container.isSinglePlayer)?(this.cueball=this.otherPlayersCueBall(),this.container.table.cue.aim.i=this.container.table.balls.indexOf(this.cueball),new i.m(this.container)):(this.container.sendEvent(new y.M),new s.r(this.container))}},{key:"otherPlayersCueBall",value:function(){var e=this.container.table.balls;return this.cueball===e[0]?e[1]:e[0]}},{key:"isPartOfBreak",value:function(e){return u.P.isThreeCushionPoint(this.cueball,e)}},{key:"isEndOfGame",value:function(e){return!1}},{key:"allowsPlaceBall",value:function(){return!1}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),I=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"create",value:function(e,t){switch(e){case"eightball":return new g(t);case"threecushion":return new C(t);case"fourteenone":return new R(t);case"snooker":return new O.c(t);default:return new x(t)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/controller/rules/snooker.ts"(e,t,n){n.d(t,{c:()=>k});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/events/watchevent.ts"),o=n("./src/model/outcome.ts"),s=n("./src/utils/rack.ts"),a=n("./src/utils/respot.ts"),l=n("./src/controller/aim.ts"),c=n("./src/controller/watchaim.ts"),u=n("./src/events/chatevent.ts"),h=n("./src/controller/end.ts"),p=n("./src/model/table.ts"),f=n("./src/view/tablegeometry.ts"),d=n("./src/controller/placeball.ts"),m=n("./src/events/placeballevent.ts"),v=n("./src/utils/utils.ts"),y=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"shotInfo",value:function(e,n,r){var i=o.P.firstCollision(n);return{pots:o.P.potCount(n),firstCollision:i,legalFirstCollision:t.isLegalFirstCollision(e,r,i),whitePotted:o.P.isCueBallPotted(e.cueball,n)}}},{key:"isLegalFirstCollision",value:function(e,n,r){if(!r)return!1;var i=r.ballB.id;return n?i>=7:!(t.coloursOnTable(e).filter(function(e){return e.id<i}).length>0)}},{key:"respotAllPottedColours",value:function(e,t){return o.P.pots(t).filter(function(e){return e.id<7}).filter(function(e){return 0!==e.id}).map(function(t){return a.k.respot(t,e)})}},{key:"redsOnTable",value:function(e){return e.balls.slice(7).filter(function(e){return e.onTable()})}},{key:"coloursOnTable",value:function(e){return e.balls.slice(1,7).filter(function(e){return e.onTable()})}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),b=n("./src/events/startaimevent.ts");function g(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var k=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");w(this,"cueball",void 0),w(this,"previousPotRed",!1),w(this,"targetIsRed",!0),w(this,"currentBreak",0),w(this,"previousBreak",0),w(this,"foulPoints",0),w(this,"score",0),w(this,"rulename","snooker"),w(this,"container",void 0),this.container=e}return e=[{key:"snookerrule",value:function(e){this.foulPoints=0;var t=y.shotInfo(this.container.table,e,this.targetIsRed);if(0===t.pots){if(!t.legalFirstCollision){var n,r,i,o=null!=(n=null==(i=t.firstCollision)||null==(r=i.ballB)?void 0:r.id)?n:0;this.foulPoints=Math.max(4,o+1)}return this.currentBreak,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.switchPlayer()}return this.targetIsRed?this.targetRedRule(e,t):this.targetColourRule(e,t)}},{key:"targetRedRule",value:function(e,t){return(console.log("applying target red rule"),t.legalFirstCollision&&o.P.onlyRedsPotted(e))?(this.currentBreak+=t.pots,this.targetIsRed=!1,this.previousPotRed=!0,this.container.hud.updateBreak(this.currentBreak),this.continueBreak()):(this.foulPoints=this.foulCalculation(e,t),this.respot(e),t.whitePotted)?this.whiteInHand():this.switchPlayer()}},{key:"targetColourRule",value:function(e,t){if(console.log("applying target colour rule"),t.whitePotted)return this.respot(e),this.whiteInHand();if(t.pots>1)return this.foulPoints=this.foulCalculation(e,t),this.respot(e),this.switchPlayer();if(o.P.pots(e)[0].id>6)return this.foulPoints=this.foulCalculation(e,t),this.switchPlayer();this.targetIsRed=y.redsOnTable(this.container.table).length>0;var n=o.P.pots(e)[0].id;return n!==t.firstCollision.ballB.id?this.foul(e,t):this.previousPotRed?(this.respot(e),this.currentBreak+=n+1,this.previousPotRed=!1,this.continueBreak()):y.coloursOnTable(this.container.table).filter(function(e){return e.id<n}).length>0?this.foul(e,t):(this.currentBreak+=n+1,this.previousPotRed=!1,this.continueBreak())}},{key:"foul",value:function(e,t){return this.foulPoints=this.foulCalculation(e,t),this.respot(e),this.switchPlayer()}},{key:"foulCalculation",value:function(e,t){var n,r,i,s,a=o.P.pots(e).map(function(e){return e.id}).filter(function(e){return e<7}),l=null!=(r=null==(s=t.firstCollision)||null==(i=s.ballB)?void 0:i.id)?r:0;return l>6&&(l=0),(n=Math).max.apply(n,[3,l].concat(function(e){if(Array.isArray(e))return g(e)}(a)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(a)||function(e,t){if(e){if("string"==typeof e)return g(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return g(e,void 0)}}(a)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()))+1}},{key:"tableGeometry",value:function(){f.P.hasPockets=!0}},{key:"table",value:function(){var e=new p.X(this.rack());return this.cueball=e.cueball,e}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"isPartOfBreak",value:function(e){return this.currentBreak>0}},{key:"isEndOfGame",value:function(e){return o.P.isClearTable(this.container.table)&&this.currentBreak>0}},{key:"allowsPlaceBall",value:function(){return!0}},{key:"asset",value:function(){return t.tablemodel}},{key:"startTurn",value:function(){this.previousPotRed=!1,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.previousBreak=this.currentBreak,this.score+=this.currentBreak,this.currentBreak=0,this.container.hud.updateBreak(this.currentBreak)}},{key:"rack",value:function(){return s.m.snooker()}},{key:"nextCandidateBall",value:function(){var e=this.container.table,t=y.redsOnTable(e),n=y.coloursOnTable(e);return this.previousPotRed?a.k.closest(e.cueball,n):t.length>0?a.k.closest(e.cueball,t):n.length>0?n[0]:void 0}},{key:"placeBall",value:function(e){if(e){var t=new r.Pq0(s.m.baulk,0,0),n=s.m.sixth,i=e.distanceTo(t);if(e.x>=s.m.baulk&&(e.x=s.m.baulk),!(i>n))return e;var o=e.clone().sub(t).normalize();return t.add(o.multiplyScalar(n))}return new r.Pq0(s.m.baulk,-s.m.sixth/2.6,0)}},{key:"switchPlayer",value:function(){this.foulPoints>0&&console.log("foul, ".concat(this.foulPoints," to opponent")),console.log("end of break, switch player");var e=this.container.table;return(console.log(e.cue.aim),this.container.sendEvent(new b.M(this.foulPoints)),this.container.isSinglePlayer)?(this.container.sendEvent(new i.Q(e.serialise())),this.startTurn(),new l.m(this.container)):new c.r(this.container)}},{key:"continueBreak",value:function(){this.container.hud.updateBreak(this.currentBreak);var e=this.container.table;return(this.container.sound.playSuccess(e.inPockets()),o.P.isClearTable(e))?(this.container.eventQueue.push(new u.b(null,"game over")),this.container.recorder.wholeGameLink(),new h.o(this.container)):(this.container.sendEvent(new i.Q(e.serialise())),new l.m(this.container))}},{key:"whiteInHand",value:function(){return(this.foulPoints>0&&console.log("foul, ".concat(this.foulPoints," to opponent")),this.startTurn(),this.container.isSinglePlayer)?new d.x(this.container):(this.container.sendEvent(new m.z(v.v_,!0)),new c.r(this.container))}},{key:"update",value:function(e){return this.snookerrule(e)}},{key:"respot",value:function(e){var t=y.respotAllPottedColours(this.container.table,e);if(t.length>0){var n={balls:t.map(function(e){return e.serialise()}),rerack:!0},r=new i.Q(n);this.container.sendEvent(r),this.container.recorder.record(r)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();w(k,"tablemodel","models/d-snooker.min.gltf")},"./src/controller/watchaim.ts"(e,t,n){n.d(t,{r:()=>u});var r=n("./src/controller/watchshot.ts"),i=n("./src/controller/controllerbase.ts"),o=n("./src/controller/aim.ts"),s=n("./src/controller/placeball.ts");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=a(r),t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(r,i||[],a(this).constructor):r.apply(this,i)),console.log("[WatchAim] Entered WatchAim state - watching opponent aim"),t.container.table.cueball=t.container.rules.otherPlayersCueBall(),t.container.table.cue.moveTo(t.container.table.cueball.pos),t.container.view.camera.forceMode(t.container.view.camera.topView),t.container.table.cue.mesh.visible=!0,t.container.table.cue.helperMesh.visible=!1,t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"handleAim",value:function(e){return console.log("[WatchAim] Received aim update from opponent"),this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return console.log("[WatchAim] Received hit event from opponent - transitioning to WatchShot"),this.container.table.applyAuthoritativeState(e.tablejson),new r.O(this.container)}},{key:"handleStartAim",value:function(e){return console.log("[WatchAim] handleStartAim - transitioning to Aim (my turn now)"),new o.m(this.container)}},{key:"handlePlaceBall",value:function(e){return console.log("[WatchAim] handlePlaceBall - transitioning to PlaceBall (my turn, ball in hand)"),new s.x(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/watchshot.ts"(e,t,n){n.d(t,{O:()=>u});var r=n("./src/controller/aim.ts"),i=n("./src/controller/watchaim.ts"),o=n("./src/controller/controllerbase.ts"),s=n("./src/controller/placeball.ts");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=a(r),t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(r,i||[],a(this).constructor):r.apply(this,i)),console.log("[WatchShot] Entered WatchShot state - watching opponent shot play out"),t.container.table.outcome=[],t.container.table.hit(),t.container.view.camera.forceMode(t.container.view.camera.topView),t.container.table.cue.mesh.visible=!1,t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"handleStationary",value:function(e){return console.log("[WatchShot] Balls stopped - waiting for server turn-change event"),this}},{key:"handleStartAim",value:function(e){return console.log("[WatchShot] handleStartAim - transitioning to Aim (my turn)"),new r.m(this.container)}},{key:"handlePlaceBall",value:function(e){return console.log("[WatchShot] handlePlaceBall - transitioning to PlaceBall (my turn)"),new s.x(this.container)}},{key:"handleWatch",value:function(e){return"rerack"in e.json?(console.log("[WatchShot] Respot detected"),this.container.table.applyAuthoritativeState(e.json,0),this):(console.log("[WatchShot] handleWatch - continuing to watch (opponent continues)"),new i.r(this.container))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(o.y)},"./src/events/abortevent.ts"(e,t,n){n.d(t,{h:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=o(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],o(this).constructor):t.apply(this,void 0))).type=i.B.ABORT,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&s(n,e),t=[{key:"applyToController",value:function(e){return e.handleAbort(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/aimevent.ts"(e,t,n){n.d(t,{w:()=>p});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts"),o=n("./src/utils/utils.ts"),s=n("./node_modules/three/build/three.core.js");function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(h=function(){return!!e})()}var p=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return t=c(t=r),l(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,h()?Reflect.construct(t,[],c(this).constructor):t.apply(this,void 0)),"offset",new s.Pq0(0,0,0)),l(e,"angle",0),l(e,"power",0),l(e,"pos",new s.Pq0(0,0,0)),l(e,"i",0),e.type=i.B.AIM,e}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&u(r,e),t=[{key:"applyToController",value:function(e){return e.handleAim(this)}},{key:"copy",value:function(){return r.fromJson(this)}}],n=[{key:"fromJson",value:function(e){var t=new r;return t.pos=(0,o.t6)(e.pos),t.angle=e.angle,t.offset=(0,o.t6)(e.offset),t.power=e.power,e.i&&(t.i=e.i),t}}],t&&a(r.prototype,t),n&&a(r,n),r}(r.F)},"./src/events/beginevent.ts"(e,t,n){n.d(t,{u:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=o(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],o(this).constructor):t.apply(this,void 0))).type=i.B.BEGIN,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&s(n,e),t=[{key:"applyToController",value:function(e){return e.handleBegin(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/breakevent.ts"(e,t,n){n.d(t,{W:()=>u});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return o=a(o=r),s(n=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(o,[],a(this).constructor):o.apply(this,void 0)),"init",void 0),s(n,"shots",void 0),s(n,"retry",void 0),n.init=e,n.shots=t,n.type=i.B.BREAK,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&l(r,e),t=[{key:"applyToController",value:function(e){return e.handleBreak(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.init,e.shots)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/chatevent.ts"(e,t,n){n.d(t,{b:()=>u});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return o=a(o=r),s(n=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(o,[],a(this).constructor):o.apply(this,void 0)),"sender",void 0),s(n,"message",void 0),n.sender=e,n.message=t,n.type=i.B.CHAT,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&l(r,e),t=[{key:"applyToController",value:function(e){return e.handleChat(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.sender,e.message)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/eventtype.ts"(e,t,n){n.d(t,{B:()=>i});var r,i=((r={}).BEGIN="BEGIN",r.BREAK="BREAK",r.WATCHAIM="WATCHAIM",r.AIM="AIM",r.HIT="HIT",r.STATIONARY="STATIONARY",r.CHAT="CHAT",r.ABORT="ABORT",r.PLACEBALL="PLACEBALL",r.REJOIN="REJOIN",r.RERACK="RERACK",r.STARTAIM="STARTAIM",r)},"./src/events/gameevent.ts"(e,t,n){function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{F:()=>i});var i=function e(){if(!(this instanceof e))throw TypeError("Cannot call a class as a function");r(this,"type",void 0),r(this,"sequence",void 0),r(this,"clientId",void 0)}},"./src/events/input.ts"(e,t,n){function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{p:()=>i});var i=function e(t,n){if(!(this instanceof e))throw TypeError("Cannot call a class as a function");r(this,"t",void 0),r(this,"key",void 0),this.t=t,this.key=n}},"./src/events/keyboard.ts"(e,t,n){n.d(t,{s:()=>a});var r=n("./src/events/input.ts"),i=n("./node_modules/interactjs/dist/interact.min.js"),o=n.n(i);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(e){var n=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");s(this,"pressed",{}),s(this,"released",{}),s(this,"keydown",function(e){null==n.pressed[e.code]&&(n.pressed[e.code]=performance.now()),e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()}),s(this,"keyup",function(e){n.released[e.code]=performance.now()-n.pressed[e.code],delete n.pressed[e.code],e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()}),s(this,"mousetouch",function(e){var t,r,i=n.released,o=e.client.y<e.rect.height/2||e.ctrlKey?.5:1,s=e.dx*o,a=.8*e.dy;i.movementY=(null!=(t=i.movementY)?t:0)+a,i.movementX=(null!=(r=i.movementX)?r:0)+s,Math.abs(i.movementX)>Math.abs(i.movementY)&&(i.movementY=0)}),this.addHandlers(e),/Android|iPhone/i.test(navigator.userAgent)||(e.contentEditable="true")}return e=[{key:"getEvents",value:function(){var e=this,t=Object.keys(this.pressed).filter(function(e){return!/Shift/.test(e)}).filter(function(e){return!/Control/.test(e)}),n=Object.keys(this.pressed).some(function(e){return/Shift/.test(e)}),i=Object.keys(this.pressed).some(function(e){return/Control/.test(e)}),o=[];return t.forEach(function(t){var s=performance.now()-e.pressed[t];o.push(new r.p(i?s/3:s,n?"Shift"+t:t)),"Space"!=t&&(e.pressed[t]=performance.now())}),Object.keys(this.released).forEach(function(t){return o.push(new r.p(e.released[t],t+"Up"))}),this.released={},o}},{key:"addHandlers",value:function(e){var t=this;e.addEventListener("keydown",this.keydown),e.addEventListener("keyup",this.keyup),e.focus(),o()(e).draggable({listeners:{move:function(e){t.mousetouch(e)}}}),o()(e).gesturable({onmove:function(e){e.dx/=3,t.mousetouch(e)}})}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/events/placeballevent.ts"(e,t,n){n.d(t,{z:()=>h});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts"),o=n("./src/utils/utils.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(u=function(){return!!e})()}var h=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return o=l(o=r),a(n=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,u()?Reflect.construct(o,[],l(this).constructor):o.apply(this,void 0)),"pos",void 0),a(n,"allTable",void 0),n.pos=e,n.allTable=t,n.type=i.B.PLACEBALL,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&c(r,e),t=[{key:"applyToController",value:function(e){return e.handlePlaceBall(this)}}],n=[{key:"fromJson",value:function(e){return new r((0,o.t6)(e.pos),e.allTable)}}],t&&s(r.prototype,t),n&&s(r,n),r}(r.F)},"./src/events/startaimevent.ts"(e,t,n){n.d(t,{M:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t,n,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return e=s(e=r),n=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(e,[],s(this).constructor):e.apply(this,void 0)),(t="foul")in n?Object.defineProperty(n,t,{value:0,enumerable:!0,configurable:!0,writable:!0}):n[t]=0,n.type=i.B.STARTAIM,n.foul=o,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleStartAim(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.foul)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/stationaryevent.ts"(e,t,n){n.d(t,{T:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=o(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],o(this).constructor):t.apply(this,void 0))).type=i.B.STATIONARY,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&s(n,e),t=[{key:"applyToController",value:function(e){return e.handleStationary(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/watchevent.ts"(e,t,n){n.d(t,{Q:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e){var t,n,o,a;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return n=s(n=r),t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(n,[],s(this).constructor):n.apply(this,void 0)),a=void 0,(o="json")in t?Object.defineProperty(t,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[o]=a,t.type=i.B.WATCHAIM,t.json=e,t}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleWatch(this)}}],n=[{key:"fromJson",value:function(e){return new r(e)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/index.ts"(e,t,n){var r=n("./src/container/container.ts"),i=n("./src/events/keyboard.ts"),o=n("./src/events/breakevent.ts"),s=n("./src/model/physics/physics.ts"),a=n("./src/view/assets.ts"),l=n("./src/network/client/session.ts"),c=n("./src/events/beginevent.ts"),u=n("./node_modules/socket.io-client/build/esm/index.js"),h=n("./node_modules/three/build/three.core.js");function p(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){f(e,t,n[t])})}return e}function m(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):(function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n.push.apply(n,r)}return n})(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}),e}function v(e){return function(e){if(Array.isArray(e))return p(e)}(e)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return p(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return p(e,void 0)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var y=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");f(this,"snapshots",[]),f(this,"BUFFER_TIME_MS",50),f(this,"MAX_BUFFER_SIZE",60),f(this,"SNAPSHOT_INTERVAL_MS",50),f(this,"serverTimeOffset",0),f(this,"lastServerTime",0),f(this,"rttSamples",[]),f(this,"MAX_RTT_SAMPLES",10),f(this,"renderTime",0),f(this,"lastRenderTime",0),f(this,"pendingOutcomes",[]),f(this,"stats",{snapshotsReceived:0,snapshotsDropped:0,interpolations:0,extrapolations:0}),this.reset()}return e=[{key:"reset",value:function(){this.snapshots=[],this.pendingOutcomes=[],this.renderTime=0,this.lastRenderTime=0}},{key:"clear",value:function(){this.reset()}},{key:"syncClock",value:function(e,t){var n=t/2,r=Date.now();this.serverTimeOffset=r-(e+n),this.rttSamples.push(t),this.rttSamples.length>this.MAX_RTT_SAMPLES&&this.rttSamples.shift()}},{key:"getRttJitter",value:function(){if(this.rttSamples.length<2)return 20;var e=this.rttSamples.reduce(function(e,t){return e+t},0)/this.rttSamples.length;return Math.sqrt(this.rttSamples.reduce(function(t,n){return t+Math.pow(n-e,2)},0)/this.rttSamples.length)}},{key:"addSnapshot",value:function(e){if(this.stats.snapshotsReceived++,e.outcomes&&e.outcomes.length>0){var t;(t=this.pendingOutcomes).push.apply(t,v(e.outcomes))}for(var n=e.timestamp+this.serverTimeOffset,r=m(d({},e),{timestamp:n}),i=this.snapshots.length,o=this.snapshots.length-1;o>=0;o--){if(this.snapshots[o].timestamp<=r.timestamp){i=o+1;break}0===o&&(i=0)}for(this.snapshots.splice(i,0,r);this.snapshots.length>this.MAX_BUFFER_SIZE;)this.snapshots.shift(),this.stats.snapshotsDropped++;1===this.snapshots.length&&(this.renderTime=r.timestamp-this.BUFFER_TIME_MS,this.lastRenderTime=Date.now())}},{key:"getInterpolatedState",value:function(e){if(0===this.snapshots.length)return null;var t=Date.now(),n=t-this.lastRenderTime;this.lastRenderTime=t;var r=this.snapshots[this.snapshots.length-1].timestamp-this.BUFFER_TIME_MS-this.renderTime;this.renderTime+=n+.1*r;for(var i=null,o=null,s=0;s<this.snapshots.length;s++)if(this.snapshots[s].timestamp>this.renderTime){o=this.snapshots[s],i=s>0?this.snapshots[s-1]:null;break}!o&&(o=this.snapshots[this.snapshots.length-1],i=this.snapshots.length>1?this.snapshots[this.snapshots.length-2]:null,this.stats.extrapolations++),i||(i=o),this.stats.interpolations++;var a=o.timestamp-i.timestamp,l=Math.max(0,Math.min(1,a>0?(this.renderTime-i.timestamp)/a:0)),c=this.smoothstep(l),u=this.interpolateBalls(i.balls,o.balls,c),h=Math.ceil(this.BUFFER_TIME_MS/this.SNAPSHOT_INTERVAL_MS),p=Math.min(1,this.snapshots.length/h),f=v(this.pendingOutcomes);return this.pendingOutcomes=[],{balls:u,isStationary:o.isStationary,outcomes:f,renderTime:this.renderTime,bufferHealth:p}}},{key:"interpolateBalls",value:function(e,t,n){var r=[],i=!0,o=!1,s=void 0;try{for(var a,l,c=t[Symbol.iterator]();!(i=(l=c.next()).done);i=!0)a=this,function(){var t=l.value,i=e.find(function(e){return e.id===t.id});if(i){var o=new h.Pq0(a.lerp(i.pos.x,t.pos.x,n),a.lerp(i.pos.y,t.pos.y,n),a.lerp(i.pos.z,t.pos.z,n)),s=new h.Pq0(a.lerp(i.vel.x,t.vel.x,n),a.lerp(i.vel.y,t.vel.y,n),a.lerp(i.vel.z,t.vel.z,n)),c=new h.Pq0(t.rvel.x,t.rvel.y,t.rvel.z);r.push({id:t.id,pos:o,vel:s,rvel:c,state:t.state})}else r.push({id:t.id,pos:new h.Pq0(t.pos.x,t.pos.y,t.pos.z),vel:new h.Pq0(t.vel.x,t.vel.y,t.vel.z),rvel:new h.Pq0(t.rvel.x,t.rvel.y,t.rvel.z),state:t.state})}()}catch(e){o=!0,s=e}finally{try{i||null==c.return||c.return()}finally{if(o)throw s}}return r}},{key:"lerp",value:function(e,t,n){return e+(t-e)*n}},{key:"smoothstep",value:function(e){return e*e*(3-2*e)}},{key:"getLatestSnapshot",value:function(){return this.snapshots.length>0?this.snapshots[this.snapshots.length-1]:null}},{key:"getStats",value:function(){return m(d({},this.stats),{bufferSize:this.snapshots.length,renderDelay:this.snapshots.length>0?this.snapshots[this.snapshots.length-1].timestamp-this.renderTime:0,rttJitter:this.getRttJitter()})}},{key:"isReady",value:function(){return this.snapshots.length>=2}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var g=function(){var e;function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"http://localhost:3001";if(!(this instanceof t))throw TypeError("Cannot call a class as a function");b(this,"serverUrl",void 0),b(this,"socket",void 0),b(this,"callbacks",void 0),b(this,"connectionState",void 0),b(this,"joinData",void 0),b(this,"reconnectAttempts",void 0),b(this,"maxReconnectAttempts",void 0),b(this,"snapshotBuffer",void 0),b(this,"shotSequence",void 0),b(this,"pingStartTime",void 0),b(this,"lastRtt",void 0),b(this,"rttInterval",void 0),b(this,"pendingShots",void 0),this.serverUrl=e,this.socket=null,this.callbacks={},this.connectionState="disconnected",this.joinData=null,this.reconnectAttempts=0,this.maxReconnectAttempts=10,this.shotSequence=0,this.pingStartTime=0,this.lastRtt=50,this.rttInterval=null,this.pendingShots=new Map,this.snapshotBuffer=new y,console.log("[SocketIO] Relay created for server: ".concat(e))}return e=[{key:"setCallbacks",value:function(e){this.callbacks=e}},{key:"connect",value:function(e){console.log("[SocketIO] Connecting to ".concat(this.serverUrl,"...")),console.log("[SocketIO] Join data:",JSON.stringify(e)),this.joinData=e,this.reconnectAttempts=0,this.socket&&this.cleanup(),this.setConnectionState("connecting"),this.socket=(0,u.io)(this.serverUrl,{parser:n("./node_modules/socket.io-msgpack-parser/index.js"),reconnection:!0,reconnectionAttempts:this.maxReconnectAttempts,reconnectionDelay:1e3,reconnectionDelayMax:5e3,randomizationFactor:.5,transports:["websocket","polling"],upgrade:!0,timeout:2e4,forceNew:!0,autoConnect:!0}),this.setupEventHandlers()}},{key:"setupEventHandlers",value:function(){var e=this;if(!this.socket)return void console.error("[SocketIO] Cannot setup handlers: socket is null");var t=this.socket;t.on("connect",function(){console.log("[SocketIO] Connected! Socket ID: ".concat(t.id)),e.reconnectAttempts=0,e.setConnectionState("connected"),e.joinData&&(console.log("[SocketIO] Sending join request for room: ".concat(e.joinData.roomId)),t.emit("join",{roomId:e.joinData.roomId,clientId:e.joinData.clientId,playerName:e.joinData.playerName,ruletype:e.joinData.ruletype||"eightball"})),e.startRttMeasurement()}),t.on("disconnect",function(t){console.log("[SocketIO] Disconnected. Reason: ".concat(t)),e.stopRttMeasurement(),e.setConnectionState("disconnected"),"io server disconnect"===t&&(console.log("[SocketIO] Server disconnected us, attempting reconnect..."),setTimeout(function(){return e.attemptReconnect()},1e3))}),t.on("connect_error",function(t){if(console.error("[SocketIO] Connection error:",t.message),e.reconnectAttempts++,e.reconnectAttempts>=e.maxReconnectAttempts){var n,r;console.error("[SocketIO] Max reconnection attempts reached"),e.setConnectionState("disconnected"),null==(n=(r=e.callbacks).onError)||n.call(r,{message:"Failed to connect to server after multiple attempts",errorCode:"CONNECTION_FAILED"})}}),t.on("reconnect",function(e){console.log("[SocketIO] Reconnected after ".concat(e," attempts"))}),t.on("reconnect_attempt",function(e){console.log("[SocketIO] Reconnection attempt ".concat(e))}),t.on("reconnect_error",function(e){console.error("[SocketIO] Reconnection error:",e.message)}),t.on("reconnect_failed",function(){var t,n;console.error("[SocketIO] Reconnection failed"),null==(t=(n=e.callbacks).onError)||t.call(n,{message:"Could not reconnect to server",errorCode:"RECONNECT_FAILED"})}),t.on("welcome",function(t){var n,r;console.log("[SocketIO] Welcome received for room: ".concat(t.roomId)),console.log("[SocketIO] Room state: ".concat(t.roomState,", Players: ").concat(t.playerCount)),t.players&&console.log("[SocketIO] Current players:",t.players.map(function(e){return e.playerName}).join(", ")),e.snapshotBuffer.syncClock(t.serverTime,e.lastRtt),t.initialState&&e.snapshotBuffer.addSnapshot(t.initialState),null==(n=(r=e.callbacks).onWelcome)||n.call(r,t)}),t.on("snapshot",function(t){var n,r;e.snapshotBuffer.addSnapshot(t),null==(n=(r=e.callbacks).onSnapshot)||n.call(r,t)}),t.on("shotAccepted",function(t){var n,r;console.log("[SocketIO] Shot ".concat(t.sequence," accepted")),e.pendingShots.delete(t.sequence),null==(n=(r=e.callbacks).onShotAccepted)||n.call(r,t)}),t.on("shotRejected",function(t){var n,r;console.warn("[SocketIO] Shot ".concat(t.sequence," rejected: ").concat(t.reason)),e.pendingShots.delete(t.sequence),null==(n=(r=e.callbacks).onShotRejected)||n.call(r,t)}),t.on("stationary",function(t){var n,r;console.log("[SocketIO] Table stationary - final state received"),e.snapshotBuffer.addSnapshot(t.finalState),null==(n=(r=e.callbacks).onStationary)||n.call(r,t)}),t.on("playerJoined",function(t){var n,r;console.log("[SocketIO] Player joined: ".concat(t.playerName||t.clientId)),null==(n=(r=e.callbacks).onPlayerJoined)||n.call(r,t)}),t.on("playerLeft",function(t){var n,r;console.log("[SocketIO] Player left: ".concat(t.clientId)),null==(n=(r=e.callbacks).onPlayerLeft)||n.call(r,t)}),t.on("chat",function(t){var n,r;null==(n=(r=e.callbacks).onChat)||n.call(r,t)}),t.on("error",function(t){var n,r;console.error("[SocketIO] Server error:",t.message),null==(n=(r=e.callbacks).onError)||n.call(r,t)}),t.on("waitingUpdate",function(t){var n,r;console.log("[SocketIO] Waiting update: ".concat(t.secondsLeft,"s remaining")),null==(n=(r=e.callbacks).onWaitingUpdate)||n.call(r,t)}),t.on("gameStart",function(t){var n,r;console.log("[SocketIO] Game started! Players:",t.players.map(function(e){return e.playerName}).join(", ")),null==(n=(r=e.callbacks).onGameStart)||n.call(r,t)}),t.on("waitingTimeout",function(t){var n,r;console.log("[SocketIO] Waiting timeout: ".concat(t.message)),null==(n=(r=e.callbacks).onWaitingTimeout)||n.call(r,t)}),t.on("playerCountUpdate",function(t){var n,r;console.log("[SocketIO] Player count: ".concat(t.count)),null==(n=(r=e.callbacks).onPlayerCountUpdate)||n.call(r,t)}),t.on("turnChange",function(t){var n,r;console.log("[SocketIO] Turn change: ".concat(t.currentPlayerId," (index: ").concat(t.currentPlayerIndex,")")),console.log("[SocketIO] Reason: ".concat(t.reason)),t.ballInHand&&console.log("[SocketIO] Ball in hand".concat(t.behindHeadString?" (behind head string)":"")),null==(n=(r=e.callbacks).onTurnChange)||n.call(r,t)}),t.on("gameOver",function(t){var n,r;console.log("[SocketIO] Game over! Winner: ".concat(t.winnerId)),console.log("[SocketIO] Reason: ".concat(t.reason)),null==(n=(r=e.callbacks).onGameOver)||n.call(r,t)}),t.on("foul",function(t){var n,r;console.log("[SocketIO] Foul by ".concat(t.playerId,": ").concat(t.reason)),null==(n=(r=e.callbacks).onFoul)||n.call(r,t)}),t.on("gamePaused",function(t){var n,r;console.log("[SocketIO] Game paused - ".concat(t.disconnectedPlayerName," disconnected")),console.log("[SocketIO] Seconds to reconnect: ".concat(t.secondsToReconnect)),null==(n=(r=e.callbacks).onGamePaused)||n.call(r,t)}),t.on("gameResumed",function(t){var n,r;console.log("[SocketIO] Game resumed - ".concat(t.reconnectedPlayerName," reconnected")),null==(n=(r=e.callbacks).onGameResumed)||n.call(r,t)}),t.on("reconnectionUpdate",function(t){var n,r;null==(n=(r=e.callbacks).onReconnectionUpdate)||n.call(r,t)}),t.on("forfeit",function(t){var n,r;console.log("[SocketIO] Forfeit: ".concat(t.forfeitPlayerId," - ").concat(t.reason)),console.log("[SocketIO] Winner: ".concat(t.winnerId)),null==(n=(r=e.callbacks).onForfeit)||n.call(r,t)}),t.on("ballPlaced",function(t){var n,r;console.log("[SocketIO] Ball placed by ".concat(t.playerId," at"),t.pos),null==(n=(r=e.callbacks).onBallPlaced)||n.call(r,t)}),t.on("aimUpdate",function(t){var n,r;null==(n=(r=e.callbacks).onAimUpdate)||n.call(r,t)}),t.on("ballPosUpdate",function(t){var n,r;null==(n=(r=e.callbacks).onBallPosUpdate)||n.call(r,t)}),t.on("pong",function(){e.lastRtt=Date.now()-e.pingStartTime,console.log("[SocketIO] RTT: ".concat(e.lastRtt,"ms"))})}},{key:"attemptReconnect",value:function(){this.socket&&this.joinData&&this.reconnectAttempts<this.maxReconnectAttempts&&(console.log("[SocketIO] Attempting manual reconnect..."),this.socket.connect())}},{key:"startRttMeasurement",value:function(){var e=this;this.measureRtt(),this.rttInterval=setInterval(function(){return e.measureRtt()},5e3)}},{key:"stopRttMeasurement",value:function(){this.rttInterval&&(clearInterval(this.rttInterval),this.rttInterval=null)}},{key:"measureRtt",value:function(){this.socket&&this.socket.connected&&(this.pingStartTime=Date.now(),this.socket.emit("ping"))}},{key:"sendHit",value:function(e){if(!this.socket||!this.socket.connected)return console.warn("[SocketIO] Cannot send hit: not connected"),-1;var t=++this.shotSequence;return this.pendingShots.set(t,{aim:e,timestamp:Date.now()}),console.log("[SocketIO] Sending hit, sequence: ".concat(t)),this.socket.emit("hit",{aim:e,sequence:t}),t}},{key:"sendPlaceBall",value:function(e){if(!this.socket||!this.socket.connected)return console.warn("[SocketIO] Cannot send placeBall: not connected"),-1;var t=++this.shotSequence;return console.log("[SocketIO] Sending placeBall, sequence: ".concat(t)),this.socket.emit("placeBall",{pos:e,sequence:t}),t}},{key:"sendAimUpdate",value:function(e,t){this.socket&&this.socket.connected&&this.socket.emit("aimUpdate",{angle:e,pos:t})}},{key:"sendBallPosUpdate",value:function(e){this.socket&&this.socket.connected&&this.socket.emit("ballPosUpdate",{pos:e})}},{key:"requestState",value:function(){this.socket&&this.socket.connected&&(console.log("[SocketIO] Requesting state"),this.socket.emit("requestState"))}},{key:"sendChat",value:function(e){this.socket&&this.socket.connected&&this.socket.emit("chat",{message:e})}},{key:"cleanup",value:function(){this.stopRttMeasurement(),this.socket&&(this.socket.removeAllListeners(),this.socket.disconnect(),this.socket=null),this.snapshotBuffer.reset(),this.pendingShots.clear()}},{key:"disconnect",value:function(){console.log("[SocketIO] Disconnecting..."),this.cleanup(),this.joinData=null,this.setConnectionState("disconnected")}},{key:"setConnectionState",value:function(e){if(this.connectionState!==e){var t,n;console.log("[SocketIO] State change: ".concat(this.connectionState," -> ").concat(e)),this.connectionState=e,null==(t=(n=this.callbacks).onConnectionChange)||t.call(n,e)}}},{key:"getConnectionState",value:function(){return this.connectionState}},{key:"isConnected",value:function(){var e;return(null==(e=this.socket)?void 0:e.connected)===!0}},{key:"getRtt",value:function(){return this.lastRtt}},{key:"hasPendingShot",value:function(){return this.pendingShots.size>0}},{key:"getInterpolatedState",value:function(e){return this.snapshotBuffer.getInterpolatedState(e)}},{key:"isBufferReady",value:function(){return this.snapshotBuffer.isReady()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),w=n("./src/events/stationaryevent.ts");function k(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var x=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");k(this,"container",void 0),k(this,"relay",void 0),k(this,"mode","Aiming"),k(this,"predictionStartTime",0),k(this,"MAX_PREDICTION_TIME_MS",1),k(this,"pendingShotSequence",-1),k(this,"pendingAim",null),k(this,"lastFrameTime",0),k(this,"clientId",""),k(this,"isShooter",!1),k(this,"onModeChange",null),k(this,"onShotConfirmed",null),k(this,"onBallsStationary",null),k(this,"onOpponentShot",null),this.container=e,this.relay=n}return e=[{key:"setClientId",value:function(e){this.clientId=e,console.log("[AuthPlayback] Client ID set:",e)}},{key:"handleShotAccepted",value:function(e){var t,n,r;if(e.shooterId===this.clientId||e.sequence===this.pendingShotSequence){if(this.isShooter=!0,e.sequence!==this.pendingShotSequence)return void console.warn("[AuthPlayback] Received confirmation for unknown shot sequence");console.log("[AuthPlayback] OUR shot accepted by server, switching to authoritative playback"),this.pendingShotSequence=-1,null==(t=this.onShotConfirmed)||t.call(this),this.relay.isBufferReady()&&this.switchToAuthoritativePlayback()}else this.isShooter=!1,console.log("[AuthPlayback] OPPONENT shot accepted, switching to authoritative playback"),null==(n=this.onOpponentShot)||n.call(this,e.aim),this.mode="AuthoritativePlayback",null==(r=this.onModeChange)||r.call(this,this.mode)}},{key:"handleShotRejected",value:function(e){var t;e.sequence===this.pendingShotSequence&&(console.warn("[AuthPlayback] Shot rejected:",e.reason),this.revertToServerState(),this.mode="Aiming",this.pendingShotSequence=-1,null==(t=this.onModeChange)||t.call(this,this.mode))}},{key:"handleStationary",value:function(e){var t,n;console.log("[AuthPlayback] Balls stationary (server)"),this.mode="Aiming",this.isShooter=!1,this.container.table.applyAuthoritativeState(e.finalState,0),this.container.eventQueue.push(new w.T),null==(t=this.onModeChange)||t.call(this,this.mode),null==(n=this.onBallsStationary)||n.call(this)}},{key:"handleSnapshot",value:function(){"LocalPrediction"===this.mode&&this.relay.isBufferReady()&&this.switchToAuthoritativePlayback()}},{key:"submitShot",value:function(e){if("Aiming"!==this.mode)return void console.warn("[AuthPlayback] Cannot submit shot: not in aiming mode");this.isShooter=!0;var t=this.relay.sendHit({angle:e.angle,power:e.power,offset:{x:e.offset.x,y:e.offset.y,z:e.offset.z},pos:{x:e.pos.x,y:e.pos.y,z:e.pos.z}});if(t<0){console.error("[AuthPlayback] Failed to send shot"),this.isShooter=!1;return}this.pendingShotSequence=t,this.pendingAim=e.copy(),this.startLocalPrediction(e)}},{key:"startLocalPrediction",value:function(e){var t;this.mode="LocalPrediction",this.predictionStartTime=performance.now(),this.container.table.cue.aim=e.copy(),this.container.table.hit(),null==(t=this.onModeChange)||t.call(this,this.mode),console.log("[AuthPlayback] Started local prediction")}},{key:"switchToAuthoritativePlayback",value:function(){var e;"AuthoritativePlayback"!==this.mode&&(console.log("[AuthPlayback] Switching to authoritative playback"),this.mode="AuthoritativePlayback",null==(e=this.onModeChange)||e.call(this,this.mode))}},{key:"revertToServerState",value:function(){var e=this.relay.snapshotBuffer.getLatestSnapshot();e&&this.container.table.applyAuthoritativeState(e,0)}},{key:"update",value:function(e){var t=this.lastFrameTime>0?(e-this.lastFrameTime)/1e3:1/60;switch(this.lastFrameTime=e,this.mode){case"Aiming":return!0;case"LocalPrediction":return this.updateLocalPrediction(t);case"AuthoritativePlayback":case"WaitingStationary":return this.updateAuthoritativePlayback(t);default:return!1}}},{key:"updateLocalPrediction",value:function(e){return!(performance.now()-this.predictionStartTime>this.MAX_PREDICTION_TIME_MS&&this.relay.isBufferReady())||(this.switchToAuthoritativePlayback(),this.updateAuthoritativePlayback(e))}},{key:"updateAuthoritativePlayback",value:function(e){var t=this.relay.getInterpolatedState(e);if(!t)if(this.isShooter)return console.log("[AuthPlayback] Shooter: buffer not ready, using local physics"),!0;else return!1;return this.applyInterpolatedState(t),this.processOutcomes(t.outcomes),!0}},{key:"applyInterpolatedState",value:function(e){var t=!0,n=!1,r=void 0;try{for(var i,o=e.balls[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var s=i.value,a=this.container.table.balls[s.id];if(a){var l=a.pos.distanceToSquared(s.pos);l>1?(a.pos.copy(s.pos),a.vel.copy(s.vel)):l>1e-4&&(a.pos.lerp(s.pos,.3),a.vel.lerp(s.vel,.3)),a.rvel.copy(s.rvel),a.state=s.state}}}catch(e){n=!0,r=e}finally{try{t||null==o.return||o.return()}finally{if(n)throw r}}}},{key:"processOutcomes",value:function(e){var t=!0,n=!1,r=void 0;try{for(var i,o=e[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var s=i.value,a={type:s.type,incidentSpeed:s.speed};this.container.table.outcome.push(a)}}catch(e){n=!0,r=e}finally{try{t||null==o.return||o.return()}finally{if(n)throw r}}}},{key:"getMode",value:function(){return this.mode}},{key:"isPlayingBack",value:function(){return"AuthoritativePlayback"===this.mode}},{key:"canShoot",value:function(){return"Aiming"===this.mode}},{key:"getStats",value:function(){return{mode:this.mode,bufferStats:this.relay.snapshotBuffer.getStats(),rtt:this.relay.getRtt(),hasPendingShot:this.relay.hasPendingShot()}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function S(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var P=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");S(this,"overlay",null),S(this,"popup",null),S(this,"timerElement",null),S(this,"messageElement",null),S(this,"playersElement",null),S(this,"isVisible",!1),this.createElements()}return e=[{key:"createElements",value:function(){this.overlay=document.createElement("div"),this.overlay.id="waitingOverlay",this.overlay.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    `,this.popup=document.createElement("div"),this.popup.id="waitingPopup",this.popup.style.cssText=`
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 16px;
      padding: 40px 50px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(100, 200, 255, 0.1);
      border: 1px solid rgba(100, 200, 255, 0.2);
      min-width: 350px;
      animation: popupSlideIn 0.3s ease-out;
    `;var e=document.createElement("style");e.textContent=`
      @keyframes popupSlideIn {
        from {
          transform: translateY(-30px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `,document.head.appendChild(e);var t=document.createElement("div");t.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    `;var n=document.createElement("div");n.style.cssText=`
      width: 24px;
      height: 24px;
      border: 3px solid rgba(100, 200, 255, 0.3);
      border-top-color: #64c8ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    `;var r=document.createElement("h2");r.textContent="Waiting for Opponent",r.style.cssText=`
      color: #fff;
      font-size: 24px;
      font-weight: 600;
      margin: 0;
    `,t.appendChild(n),t.appendChild(r),this.popup.appendChild(t),this.playersElement=document.createElement("div"),this.playersElement.id="waitingPlayers",this.playersElement.style.cssText=`
      margin: 20px 0;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    `,this.popup.appendChild(this.playersElement);var i=document.createElement("div");i.style.cssText=`
      margin: 25px 0;
    `;var o=document.createElement("div");o.textContent="Time remaining",o.style.cssText=`
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
      margin-bottom: 8px;
    `,this.timerElement=document.createElement("span"),this.timerElement.style.cssText=`
      font-size: 48px;
      font-weight: bold;
      color: #64c8ff;
      text-shadow: 0 0 20px rgba(100, 200, 255, 0.5);
    `,this.timerElement.textContent="60";var s=document.createElement("span");s.textContent=" seconds",s.style.cssText=`
      font-size: 16px;
      color: rgba(255, 255, 255, 0.6);
    `,i.appendChild(o),i.appendChild(this.timerElement),i.appendChild(s),this.popup.appendChild(i),this.messageElement=document.createElement("div"),this.messageElement.style.cssText=`
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      margin-top: 15px;
      animation: pulse 2s ease-in-out infinite;
    `,this.messageElement.textContent="Share the game link with your opponent...",this.popup.appendChild(this.messageElement),this.overlay.appendChild(this.popup),document.body.appendChild(this.overlay)}},{key:"show",value:function(){this.overlay&&!this.isVisible&&(this.overlay.style.display="flex",this.isVisible=!0)}},{key:"hide",value:function(){this.overlay&&this.isVisible&&(this.overlay.style.display="none",this.isVisible=!1)}},{key:"updateTimer",value:function(e){this.timerElement&&(this.timerElement.textContent=e.toString(),e<=10?(this.timerElement.style.color="#ff6464",this.timerElement.style.textShadow="0 0 20px rgba(255, 100, 100, 0.5)"):e<=30?(this.timerElement.style.color="#ffcc64",this.timerElement.style.textShadow="0 0 20px rgba(255, 200, 100, 0.5)"):(this.timerElement.style.color="#64c8ff",this.timerElement.style.textShadow="0 0 20px rgba(100, 200, 255, 0.5)"))}},{key:"updatePlayers",value:function(e){var t=this;if(this.playersElement){this.playersElement.innerHTML="";var n=document.createElement("div");if(n.textContent="Players (".concat(e.length,"/2)"),n.style.cssText=`
      color: rgba(255, 255, 255, 0.6);
      font-size: 12px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    `,this.playersElement.appendChild(n),e.forEach(function(e,n){var r=document.createElement("div");r.style.cssText=`
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        margin: 5px 0;
        background: rgba(100, 200, 255, 0.1);
        border-radius: 8px;
        border-left: 3px solid `.concat(0===n?"#64c8ff":"#64ff96",`;
      `);var i=document.createElement("div");i.textContent=e.playerName.charAt(0).toUpperCase(),i.style.cssText=`
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: `.concat(0===n?"linear-gradient(135deg, #64c8ff, #6496ff)":"linear-gradient(135deg, #64ff96, #64ffc8)",`;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #1a1a2e;
      `);var o=document.createElement("span");o.textContent=e.playerName,o.style.cssText=`
        color: #fff;
        font-weight: 500;
      `;var s=document.createElement("span");s.textContent="Ready",s.style.cssText=`
        margin-left: auto;
        color: #64ff96;
        font-size: 12px;
      `,r.appendChild(i),r.appendChild(o),r.appendChild(s),t.playersElement.appendChild(r)}),e.length<2){var r=document.createElement("div");r.style.cssText=`
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        margin: 5px 0;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border-left: 3px solid rgba(255, 255, 255, 0.2);
        border-style: dashed;
      `;var i=document.createElement("div");i.textContent="?",i.style.cssText=`
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255, 255, 255, 0.4);
      `;var o=document.createElement("span");o.textContent="Waiting for opponent...",o.style.cssText=`
        color: rgba(255, 255, 255, 0.4);
        font-style: italic;
      `,r.appendChild(i),r.appendChild(o),this.playersElement.appendChild(r)}}}},{key:"setMessage",value:function(e){this.messageElement&&(this.messageElement.textContent=e)}},{key:"showGameStarting",value:function(){var e=this;if(this.popup){this.popup.innerHTML="";var t=document.createElement("h2");t.textContent="üé± Game Starting!",t.style.cssText=`
      color: #64ff96;
      font-size: 28px;
      margin-bottom: 20px;
    `;var n=document.createElement("div");n.textContent="Both players connected. Get ready to play!",n.style.cssText=`
      color: rgba(255, 255, 255, 0.8);
      font-size: 16px;
    `,this.popup.appendChild(t),this.popup.appendChild(n),setTimeout(function(){return e.hide()},2e3)}}},{key:"showTimeout",value:function(e){if(this.popup){this.popup.innerHTML="";var t=document.createElement("h2");t.textContent="‚è∞ Time's Up",t.style.cssText=`
      color: #ff6464;
      font-size: 28px;
      margin-bottom: 20px;
    `;var n=document.createElement("div");n.textContent=e,n.style.cssText=`
      color: rgba(255, 255, 255, 0.8);
      font-size: 16px;
      margin-bottom: 20px;
    `;var r=document.createElement("button");r.textContent="Return to Lobby",r.style.cssText=`
      background: linear-gradient(135deg, #64c8ff, #6496ff);
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    `,r.onclick=function(){window.location.href="/"},r.onmouseover=function(){r.style.transform="scale(1.05)"},r.onmouseout=function(){r.style.transform="scale(1)"},this.popup.appendChild(t),this.popup.appendChild(n),this.popup.appendChild(r)}}},{key:"destroy",value:function(){this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay),this.overlay=null,this.popup=null,this.timerElement=null,this.messageElement=null,this.playersElement=null}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function T(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var E=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");T(this,"overlay",null),T(this,"popup",null),T(this,"timerElement",null),T(this,"messageElement",null),T(this,"playerNameElement",null),T(this,"isVisible",!1),this.createElements()}return e=[{key:"createElements",value:function(){if(this.overlay=document.createElement("div"),this.overlay.id="disconnectionOverlay",this.overlay.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10001;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    `,this.popup=document.createElement("div"),this.popup.id="disconnectionPopup",this.popup.style.cssText=`
      background: linear-gradient(135deg, #2e1a1a 0%, #3e1616 100%);
      border-radius: 16px;
      padding: 40px 50px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(255, 100, 100, 0.1);
      border: 1px solid rgba(255, 100, 100, 0.3);
      min-width: 350px;
      animation: popupSlideIn 0.3s ease-out;
    `,!document.getElementById("disconnectionPopupStyles")){var e=document.createElement("style");e.id="disconnectionPopupStyles",e.textContent=`
        @keyframes popupSlideIn {
          from {
            transform: translateY(-30px);
            opacity: 0;
          }
          to {
            transform: translateY(0);
            opacity: 1;
          }
        }
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
        @keyframes warningPulse {
          0%, 100% { 
            box-shadow: 0 0 10px rgba(255, 100, 100, 0.3);
          }
          50% { 
            box-shadow: 0 0 30px rgba(255, 100, 100, 0.6);
          }
        }
      `,document.head.appendChild(e)}var t=document.createElement("div");t.style.cssText=`
      margin-bottom: 20px;
    `;var n=document.createElement("div");n.innerHTML=`
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ff6464" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
    `,n.style.cssText=`
      animation: warningPulse 2s ease-in-out infinite;
      display: inline-block;
    `,t.appendChild(n),this.popup.appendChild(t);var r=document.createElement("h2");r.textContent="Connection Lost",r.style.cssText=`
      color: #ff6464;
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 10px 0;
    `,this.popup.appendChild(r);var i=document.createElement("div");i.style.cssText=`
      color: #fff;
      font-size: 16px;
      margin-bottom: 25px;
    `,this.playerNameElement=document.createElement("span"),this.playerNameElement.style.cssText=`
      color: #ffcc64;
      font-weight: 600;
    `,i.appendChild(this.playerNameElement);var o=document.createTextNode(" has disconnected");i.appendChild(o),this.popup.appendChild(i);var s=document.createElement("div");s.style.cssText=`
      margin: 25px 0;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
    `;var a=document.createElement("div");a.textContent="Waiting for reconnection",a.style.cssText=`
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
      margin-bottom: 12px;
    `,this.timerElement=document.createElement("span"),this.timerElement.style.cssText=`
      font-size: 56px;
      font-weight: bold;
      color: #ff6464;
      text-shadow: 0 0 20px rgba(255, 100, 100, 0.5);
    `,this.timerElement.textContent="60";var l=document.createElement("span");l.textContent=" seconds",l.style.cssText=`
      font-size: 16px;
      color: rgba(255, 255, 255, 0.6);
    `,s.appendChild(a),s.appendChild(this.timerElement),s.appendChild(l),this.popup.appendChild(s),this.messageElement=document.createElement("div"),this.messageElement.style.cssText=`
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      margin-top: 15px;
      animation: pulse 2s ease-in-out infinite;
    `,this.messageElement.textContent="Game will resume when player reconnects...",this.popup.appendChild(this.messageElement);var c=document.createElement("div");c.style.cssText=`
      color: rgba(255, 255, 255, 0.4);
      font-size: 12px;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    `,c.textContent="If the player doesn't reconnect in time, they will forfeit.",this.popup.appendChild(c),this.overlay.appendChild(this.popup),document.body.appendChild(this.overlay)}},{key:"show",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:60;this.overlay&&!this.isVisible&&(this.playerNameElement&&(this.playerNameElement.textContent=e),this.updateTimer(t),this.overlay.style.display="flex",this.isVisible=!0)}},{key:"hide",value:function(){this.overlay&&this.isVisible&&(this.overlay.style.display="none",this.isVisible=!1)}},{key:"updateTimer",value:function(e){this.timerElement&&(this.timerElement.textContent=e.toString(),e<=10?(this.timerElement.style.color="#ff3333",this.timerElement.style.textShadow="0 0 30px rgba(255, 50, 50, 0.7)"):e<=30?(this.timerElement.style.color="#ff6464",this.timerElement.style.textShadow="0 0 20px rgba(255, 100, 100, 0.5)"):(this.timerElement.style.color="#ffcc64",this.timerElement.style.textShadow="0 0 20px rgba(255, 200, 100, 0.5)"))}},{key:"setMessage",value:function(e){this.messageElement&&(this.messageElement.textContent=e)}},{key:"showReconnected",value:function(e){var t=this;this.popup&&(this.popup.style.background="linear-gradient(135deg, #1a2e1a 0%, #163e16 100%)",this.popup.style.border="1px solid rgba(100, 255, 100, 0.3)",this.popup.style.boxShadow="0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(100, 255, 100, 0.1)"),this.playerNameElement&&(this.playerNameElement.textContent=e,this.playerNameElement.style.color="#64ff96"),this.setMessage("Reconnected! Game resuming..."),this.timerElement&&(this.timerElement.textContent="‚úì",this.timerElement.style.color="#64ff96",this.timerElement.style.fontSize="72px"),setTimeout(function(){t.hide(),t.resetStyle()},2e3)}},{key:"resetStyle",value:function(){this.popup&&(this.popup.style.background="linear-gradient(135deg, #2e1a1a 0%, #3e1616 100%)",this.popup.style.border="1px solid rgba(255, 100, 100, 0.3)",this.popup.style.boxShadow="0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(255, 100, 100, 0.1)"),this.playerNameElement&&(this.playerNameElement.style.color="#ffcc64"),this.timerElement&&(this.timerElement.style.fontSize="56px")}},{key:"showForfeit",value:function(e){var t=this;this.playerNameElement&&(this.playerNameElement.textContent=e),this.setMessage("Player did not reconnect in time. You win!"),this.timerElement&&(this.timerElement.textContent="üèÜ",this.timerElement.style.fontSize="72px",this.timerElement.style.color="#64ff96"),this.popup&&(this.popup.style.background="linear-gradient(135deg, #1a2e1a 0%, #163e16 100%)",this.popup.style.border="1px solid rgba(100, 255, 100, 0.3)"),setTimeout(function(){t.hide(),t.resetStyle()},5e3)}},{key:"isShowing",value:function(){return this.isVisible}},{key:"destroy",value:function(){this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay),this.overlay=null,this.popup=null,this.timerElement=null,this.messageElement=null,this.playerNameElement=null,this.isVisible=!1}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function R(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var O=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");R(this,"overlay",null),R(this,"popup",null),R(this,"titleElement",null),R(this,"reasonElement",null),R(this,"isVisible",!1),this.createElements()}return e=[{key:"createElements",value:function(){if(this.overlay=document.createElement("div"),this.overlay.id="gameResultOverlay",this.overlay.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10002;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    `,this.popup=document.createElement("div"),this.popup.id="gameResultPopup",this.popup.style.cssText=`
      background: linear-gradient(135deg, #1a2e1a 0%, #163e16 100%);
      border-radius: 20px;
      padding: 50px 60px;
      text-align: center;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6), 0 0 60px rgba(100, 255, 100, 0.15);
      border: 2px solid rgba(100, 255, 100, 0.4);
      min-width: 400px;
      animation: resultPopupSlideIn 0.4s ease-out;
    `,!document.getElementById("gameResultPopupStyles")){var e=document.createElement("style");e.id="gameResultPopupStyles",e.textContent=`
        @keyframes resultPopupSlideIn {
          from {
            transform: scale(0.8) translateY(-50px);
            opacity: 0;
          }
          to {
            transform: scale(1) translateY(0);
            opacity: 1;
          }
        }
        @keyframes trophyBounce {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.1); }
        }
        @keyframes confetti {
          0% { transform: translateY(0) rotate(0deg); opacity: 1; }
          100% { transform: translateY(100px) rotate(720deg); opacity: 0; }
        }
        @keyframes sadShake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-5px); }
          75% { transform: translateX(5px); }
        }
      `,document.head.appendChild(e)}var t=document.createElement("div");t.id="gameResultIcon",t.style.cssText=`
      margin-bottom: 25px;
      font-size: 80px;
    `,this.popup.appendChild(t),this.titleElement=document.createElement("h1"),this.titleElement.style.cssText=`
      font-size: 42px;
      font-weight: 700;
      margin: 0 0 15px 0;
      letter-spacing: 2px;
    `,this.popup.appendChild(this.titleElement),this.reasonElement=document.createElement("div"),this.reasonElement.style.cssText=`
      color: rgba(255, 255, 255, 0.8);
      font-size: 18px;
      margin-bottom: 30px;
      line-height: 1.5;
    `,this.popup.appendChild(this.reasonElement);var n=document.createElement("button");n.textContent="Play Again",n.style.cssText=`
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      border: none;
      border-radius: 30px;
      color: white;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 15px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    `,n.onmouseover=function(){n.style.transform="scale(1.05)",n.style.boxShadow="0 6px 20px rgba(76, 175, 80, 0.6)"},n.onmouseout=function(){n.style.transform="scale(1)",n.style.boxShadow="0 4px 15px rgba(76, 175, 80, 0.4)"},n.onclick=function(){window.location.reload()},this.popup.appendChild(n);var r=document.createElement("button");r.textContent="Exit",r.style.cssText=`
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 30px;
      color: rgba(255, 255, 255, 0.8);
      padding: 15px 40px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    `,r.onmouseover=function(){r.style.borderColor="rgba(255, 255, 255, 0.8)",r.style.color="white"},r.onmouseout=function(){r.style.borderColor="rgba(255, 255, 255, 0.5)",r.style.color="rgba(255, 255, 255, 0.8)"},r.onclick=function(){window.close(),window.location.href="about:blank"},this.popup.appendChild(r),this.overlay.appendChild(this.popup),document.body.appendChild(this.overlay)}},{key:"showWin",value:function(e){if(this.overlay&&this.popup&&this.titleElement&&this.reasonElement){this.popup.style.background="linear-gradient(135deg, #1a2e1a 0%, #163e16 100%)",this.popup.style.borderColor="rgba(100, 255, 100, 0.4)",this.popup.style.boxShadow="0 25px 80px rgba(0, 0, 0, 0.6), 0 0 60px rgba(100, 255, 100, 0.15)";var t=document.getElementById("gameResultIcon");t&&(t.innerHTML="üèÜ",t.style.animation="trophyBounce 0.6s ease-in-out infinite"),this.titleElement.textContent="YOU WIN!",this.titleElement.style.color="#4CAF50",this.titleElement.style.textShadow="0 0 30px rgba(76, 175, 80, 0.5)",this.reasonElement.textContent=e,this.show()}}},{key:"showLose",value:function(e){if(this.overlay&&this.popup&&this.titleElement&&this.reasonElement){this.popup.style.background="linear-gradient(135deg, #2e1a1a 0%, #3e1616 100%)",this.popup.style.borderColor="rgba(255, 100, 100, 0.4)",this.popup.style.boxShadow="0 25px 80px rgba(0, 0, 0, 0.6), 0 0 60px rgba(255, 100, 100, 0.15)";var t=document.getElementById("gameResultIcon");t&&(t.innerHTML="üò¢",t.style.animation="sadShake 0.5s ease-in-out"),this.titleElement.textContent="YOU LOSE",this.titleElement.style.color="#ff6464",this.titleElement.style.textShadow="0 0 30px rgba(255, 100, 100, 0.5)",this.reasonElement.textContent=e,this.show()}}},{key:"show",value:function(){this.overlay&&(this.overlay.style.display="flex",this.isVisible=!0)}},{key:"hide",value:function(){this.overlay&&(this.overlay.style.display="none",this.isVisible=!1)}},{key:"isShowing",value:function(){return this.isVisible}},{key:"dispose",value:function(){this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay),this.overlay=null,this.popup=null,this.titleElement=null,this.reasonElement=null}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),A=n("./src/events/startaimevent.ts"),M=n("./src/events/placeballevent.ts"),C=n("./src/events/watchevent.ts"),I=n("./src/events/abortevent.ts");function _(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var j=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");_(this,"container",void 0),_(this,"canvas3d",void 0),_(this,"tableId",void 0),_(this,"clientId",void 0),_(this,"ruletype",void 0),_(this,"playername",void 0),_(this,"socketRelay",null),_(this,"authoritativePlayback",null),_(this,"useServerAuthoritative",!1),_(this,"serverUrl",""),_(this,"waitingPopup",null),_(this,"disconnectionPopup",null),_(this,"gameResultPopup",null),_(this,"gameStarted",!1),_(this,"gamePaused",!1),_(this,"cushionModel",void 0),_(this,"spectator",void 0),_(this,"assets",void 0),_(this,"now",void 0),this.now=Date.now(),this.playername=null!=(r=n.get("name"))?r:"",this.ruletype=null!=(i=n.get("ruletype"))?i:"eightball",this.canvas3d=e,this.cushionModel=this.cushion(n.get("cushionModel")),this.spectator=n.has("spectator"),this.serverUrl=null!=(o=n.get("server"))?o:"";var r,i,o,s,a,c,u=n.get("gameSessionUuid"),h=n.get("uuid");if(u){if(this.useServerAuthoritative=!0,!this.serverUrl){var p=window.location.protocol,f=window.location.hostname;this.serverUrl="".concat(p,"//").concat(f,":3001")}this.tableId=u,this.clientId=null!=(s=null!=h?h:n.get("clientId"))?s:"default"}else this.useServerAuthoritative=!!this.serverUrl,this.tableId=null!=(a=n.get("tableId"))?a:"default",this.clientId=null!=(c=n.get("clientId"))?c:"default";!this.playername&&this.clientId&&(this.playername=this.clientId),l.N.init(this.clientId,this.playername,this.tableId,this.spectator)}return e=[{key:"cushion",value:function(e){switch(e){case"bounceHan":return s.QV;case"bounceHanBlend":return s.$8;default:return s.Qy}}},{key:"start",value:function(){var e=this;this.assets=new a.s(this.ruletype),this.assets.loadFromWeb(function(){e.onAssetsReady()})}},{key:"onAssetsReady",value:function(){var e=this;if(console.log("".concat(this.playername," assets ready")),this.container=new r.m(this.canvas3d,console.log,this.assets,this.ruletype,new i.s(this.canvas3d),this.playername),this.container.broadcast=function(t){e.broadcast(t)},this.container.table.cushionModel=this.cushionModel,this.spectator){this.container.eventQueue.push(new c.u),this.container.animate(performance.now());return}this.useServerAuthoritative?this.initServerAuthoritative():(this.container.eventQueue.push(new o.W),this.container.animate(performance.now()))}},{key:"initServerAuthoritative",value:function(){var e=this;console.log("Connecting to authoritative server: ".concat(this.serverUrl)),this.container.isSinglePlayer=!1,this.gameStarted=!1,this.container.useServerAuthoritative=!0,this.container.submitAuthoritativeShot=function(t){e.submitAuthoritativeShot(t)},this.container.submitPlaceBall=function(t){var n;null==(n=e.socketRelay)||n.sendPlaceBall(t)},this.container.sendAimUpdate=function(t,n){var r;null==(r=e.socketRelay)||r.sendAimUpdate(t,n)},this.container.sendBallPosUpdate=function(t){var n;null==(n=e.socketRelay)||n.sendBallPosUpdate(t)},this.waitingPopup=new P,this.disconnectionPopup=new E,this.socketRelay=new g(this.serverUrl),this.authoritativePlayback=new x(this.container,this.socketRelay),this.authoritativePlayback.setClientId(this.clientId),this.socketRelay.setCallbacks({onWelcome:function(t){var n,r,i;console.log("Connected to room ".concat(t.roomId),t),e.container.chat.showMessage("Connected to server"),e.container.table.applyAuthoritativeState(t.initialState,0),void 0!==t.isYourTurn&&e.container.setTurnState(t.isYourTurn),"waiting"===t.roomState?(console.log("Room is waiting for opponent, showing popup"),null==(n=e.waitingPopup)||n.show(),t.players&&(null==(r=e.waitingPopup)||r.updatePlayers(t.players))):"playing"===t.roomState&&(console.log("Room already playing"),null==(i=e.waitingPopup)||i.hide(),void 0!==t.isYourTurn&&e.container.setTurnState(t.isYourTurn)),e.startServerAuthoritativeAnimation()},onConnectionChange:function(t){"disconnected"===t?e.container.chat.showMessage("Disconnected from server"):"connecting"===t&&e.container.chat.showMessage("Connecting to server...")},onPlayerJoined:function(t){e.container.chat.showMessage("".concat(t.playerName," joined"))},onPlayerLeft:function(t){e.container.chat.showMessage("Player left")},onChat:function(t){e.container.chat.showMessage("".concat(t.playerName,": ").concat(t.message))},onError:function(t){console.error("Server error:",t.message),e.container.chat.showMessage("Error: ".concat(t.message))},onWaitingUpdate:function(t){var n;null==(n=e.waitingPopup)||n.updateTimer(t.secondsLeft)},onGameStart:function(t){console.log("[GameStart] Game starting!",t),console.log("[GameStart] My clientId:",e.clientId),console.log("[GameStart] currentPlayerId:",t.currentPlayerId),console.log("[GameStart] Current controller:",e.container.controller.constructor.name),e.gameStarted=!0,null==(s=e.waitingPopup)||s.showGameStarting(),t.initialState&&t.initialState.balls&&e.container.table.applyInitialServerState(t.initialState);var n,r,i,o,s,a=t.currentPlayerId===e.clientId,l=null!=(n=null!=(r=t.ballInHand)?r:t.isBreakShot)&&n,c=null!=(i=null!=(o=t.behindHeadString)?o:t.isBreakShot)&&i;console.log("[GameStart] isMyTurn:",a,"ballInHand:",l,"behindHeadString:",c),e.container.setTurnState(a,l,c),e.container.chat.showMessage(a?"Game started! Your turn - break shot!":"Game started! Opponent's turn to break."),a?l?(console.log("[GameStart] Pushing PlaceBallEvent for my turn with ball in hand"),e.container.eventQueue.push(new M.z(null,c)),console.log("[GameStart] EventQueue length:",e.container.eventQueue.length)):(console.log("[GameStart] Pushing StartAimEvent for my turn"),e.container.eventQueue.push(new A.M)):(console.log("[GameStart] Pushing WatchEvent - opponent's turn"),e.container.eventQueue.push(new C.Q(e.container.table.serialise())))},onWaitingTimeout:function(t){var n;console.log("Waiting timeout",t),null==(n=e.waitingPopup)||n.showTimeout(t.message)},onPlayerCountUpdate:function(t){var n,r;null==(n=e.waitingPopup)||n.updatePlayers(t.players),t.count>=2&&(null==(r=e.waitingPopup)||r.setMessage("Opponent joined! Starting game..."))},onTurnChange:function(t){console.log("Turn changed to ".concat(t.currentPlayerId));var n=t.currentPlayerId===e.clientId;e.container.chat.showMessage(n?"Your turn! ".concat(t.reason):"Opponent's turn. ".concat(t.reason)),e.container.setTurnState(n,t.ballInHand,t.behindHeadString),void 0!==t.playerGroup&&console.log("Your group: ".concat(t.playerGroup,", Opponent: ").concat(t.opponentGroup)),n?t.ballInHand?(console.log("[TurnChange] Pushing PlaceBallEvent"),e.container.eventQueue.push(new M.z(null,t.behindHeadString))):(console.log("[TurnChange] Pushing StartAimEvent"),e.container.eventQueue.push(new A.M)):(console.log("[TurnChange] Pushing WatchEvent"),e.container.eventQueue.push(new C.Q(e.container.table.serialise())))},onGameOver:function(t){console.log("Game over! Winner: ".concat(t.winnerId));var n=t.winnerId===e.clientId;e.gameResultPopup||(e.gameResultPopup=new O),n?e.gameResultPopup.showWin(t.reason):e.gameResultPopup.showLose(t.reason),e.container.chat.showMessage(n?"You won! ".concat(t.reason):"You lost. ".concat(t.reason)),e.container.eventQueue.push(new I.h)},onFoul:function(t){console.log("Foul: ".concat(t.reason));var n=t.playerId===e.clientId;e.container.chat.showMessage(n?"Foul! ".concat(t.reason):"Opponent fouled. ".concat(t.reason))},onSnapshot:function(t){var n;null==(n=e.authoritativePlayback)||n.handleSnapshot()},onShotAccepted:function(t){var n;console.log("Shot accepted by server:",t),null==(n=e.authoritativePlayback)||n.handleShotAccepted(t)},onShotRejected:function(t){var n;console.log("Shot rejected by server:",t),null==(n=e.authoritativePlayback)||n.handleShotRejected(t)},onStationary:function(t){var n;console.log("Table stationary from server"),null==(n=e.authoritativePlayback)||n.handleStationary(t)},onGamePaused:function(t){console.log("Game paused - ".concat(t.disconnectedPlayerName," disconnected")),e.gamePaused=!0,e.disconnectionPopup||(e.disconnectionPopup=new E),e.disconnectionPopup.show(t.disconnectedPlayerName,t.secondsToReconnect),e.container.chat.showMessage("".concat(t.disconnectedPlayerName," disconnected - waiting for reconnection..."))},onGameResumed:function(t){console.log("Game resumed - ".concat(t.reconnectedPlayerName," reconnected")),e.gamePaused=!1,e.disconnectionPopup&&e.disconnectionPopup.showReconnected(t.reconnectedPlayerName),e.container.chat.showMessage("".concat(t.reconnectedPlayerName," reconnected! Game resuming..."))},onReconnectionUpdate:function(t){var n;null==(n=e.disconnectionPopup)||n.updateTimer(t.secondsLeft)},onForfeit:function(t){console.log("Forfeit: ".concat(t.forfeitPlayerId)),e.gamePaused=!1;var n=t.winnerId===e.clientId;n&&e.disconnectionPopup&&e.disconnectionPopup.showForfeit("Opponent"),e.container.chat.showMessage(n?"You won! ".concat(t.reason):"You lost. ".concat(t.reason)),e.container.eventQueue.push(new I.h)},onBallPlaced:function(t){console.log("[BallPlaced] Ball placed by ".concat(t.playerId," at"),t.pos),t.snapshot&&e.container.table.applyAuthoritativeState(t.snapshot,0),t.playerId===e.clientId&&(console.log("[BallPlaced] Our ball - transitioning to Aim"),e.container.eventQueue.push(new A.M))},onAimUpdate:function(t){t.playerId!==e.clientId&&(e.container.table.cue.aim.angle=t.angle,e.container.table.cue.aim.pos.set(t.pos.x,t.pos.y,t.pos.z),e.container.table.cue.moveTo(e.container.table.cue.aim.pos))},onBallPosUpdate:function(t){t.playerId!==e.clientId&&(e.container.table.cueball.pos.set(t.pos.x,t.pos.y,t.pos.z),e.container.table.cueball.updateMesh(0),e.container.table.cue.moveTo(e.container.table.cueball.pos))}});var t=new URLSearchParams(window.location.search),n=t.get("gameSessionUuid")||this.tableId,r=t.get("uuid")||this.clientId;this.socketRelay.connect({roomId:n,clientId:r,playerName:this.playername,ruletype:this.ruletype})}},{key:"startServerAuthoritativeAnimation",value:function(){var e=this,t=performance.now(),n=function(r){var i=(r-t)/1e3;t=r;var o=!1;e.authoritativePlayback&&(o=e.authoritativePlayback.update(r)),o&&e.container.advance(i),e.container.table.updateBallMesh(i),e.container.view.update(i,e.container.table.cue.aim),e.container.table.cue.update(i),e.container.sound.processOutcomes(e.container.table.outcome),e.container.processEvents(),e.container.view.render(),requestAnimationFrame(n)};requestAnimationFrame(n)}},{key:"submitAuthoritativeShot",value:function(e){this.authoritativePlayback&&this.authoritativePlayback.submitShot(e)}},{key:"canSubmitShot",value:function(){return(!!this.gameStarted||!this.useServerAuthoritative)&&!this.gamePaused&&(!this.authoritativePlayback||this.authoritativePlayback.canShoot())}},{key:"getPlaybackMode",value:function(){var e,t;return null!=(e=null==(t=this.authoritativePlayback)?void 0:t.getMode())?e:null}},{key:"getNetworkStats",value:function(){var e,t;return null!=(e=null==(t=this.authoritativePlayback)?void 0:t.getStats())?e:null}},{key:"broadcast",value:function(e){}},{key:"offerUpload",value:function(){this.container.chat.showMessage('<a class="pill" target="_blank" href="https://scoreboard-tailuge.vercel.app/hiscore.html'.concat(location.search,'"> upload high score üèÜ</a'))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();new j(document.getElementById("viewP1"),new URLSearchParams(location.search)).start(),"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?console.log("Skipping usage fetch for localhost."):fetch("https://scoreboard-tailuge.vercel.app/api/usage/game",{method:"PUT",mode:"cors"}).then(function(e){e.ok||console.error("HTTP error:",e.status,e.statusText)}).catch(function(e){console.error("Fetch error:",e)})},"./src/model/ball.ts"(e,t,n){n.d(t,{U:()=>u,c:()=>h});var r,i=n("./node_modules/three/build/three.core.js"),o=n("./src/utils/utils.ts"),s=n("./src/model/physics/physics.ts"),a=n("./src/view/ballmesh.ts");function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=((r={}).Stationary="Stationary",r.Rolling="Rolling",r.Sliding="Sliding",r.Falling="Falling",r.InPocket="InPocket",r),h=function(){var e,t;function n(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");c(this,"pos",void 0),c(this,"vel",o.v_.clone()),c(this,"rvel",o.v_.clone()),c(this,"futurePos",o.v_.clone()),c(this,"ballmesh",void 0),c(this,"state","Stationary"),c(this,"pocket",null),c(this,"targetPos",null),c(this,"interpStart",o.v_.clone()),c(this,"interpTimeLeft",0),c(this,"interpTotal",0),c(this,"targetVel",o.v_.clone()),c(this,"id",n.id++),this.pos=e.clone(),this.ballmesh=new a.J(t||0xeeeeee*Math.random(),r,i)}return e=[{key:"setBallNumber",value:function(e){this.ballmesh.setBallNumber(e)}},{key:"update",value:function(e){this.updatePosition(e),"Falling"===this.state&&this.pocket?this.pocket.updateFall(this,e):this.updateVelocity(e)}},{key:"updateMesh",value:function(e){this.ballmesh.updateAll(this,e)}},{key:"updatePosition",value:function(e){if(this.interpTimeLeft>0&&this.targetPos){this.interpTimeLeft=Math.max(0,this.interpTimeLeft-e);var t=this.interpTotal-this.interpTimeLeft,n=this.interpTotal>0?t/this.interpTotal:1;this.pos.copy(this.interpStart).lerp(this.targetPos,n),0===this.interpTimeLeft&&(this.vel.copy(this.targetVel),this.targetPos=null);return}this.pos.addScaledVector(this.vel,e)}},{key:"setServerState",value:function(e){var t,n,r,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.1;if(e.pos){var a,l=e.pos;this.targetPos=new i.Pq0(l.x,l.y,null!=(a=l.z)?a:0),this.interpStart.copy(this.pos),this.interpTimeLeft=s,this.interpTotal=s}else this.targetPos=null,this.interpTimeLeft=0,this.interpTotal=0;e.vel?this.targetVel.set(null!=(t=e.vel.x)?t:0,null!=(n=e.vel.y)?n:0,null!=(r=e.vel.z)?r:0):this.targetVel.copy(o.v_),e.rvel&&this.rvel.copy(e.rvel),e.state&&(this.state=e.state),0===s&&this.targetPos&&(this.pos.copy(this.targetPos),this.vel.copy(this.targetVel),this.targetPos=null,this.interpTimeLeft=0)}},{key:"updateVelocity",value:function(e){this.inMotion()&&(this.isRolling()?(this.state="Rolling",(0,s.lx)(this.vel,this.rvel),this.addDelta(e,(0,s.JD)(this.rvel))):(this.state="Sliding",this.addDelta(e,(0,s.p2)(this.vel,this.rvel))))}},{key:"addDelta",value:function(e,t){t.v.multiplyScalar(e),t.w.multiplyScalar(e),this.passesZero(t)||(this.vel.add(t.v),this.rvel.add(t.w))}},{key:"passesZero",value:function(e){var t=(0,o.rq)(this.vel,e.v),n=(0,o.rq)(this.rvel,e.w);return!!(("Rolling"===this.state?t||n:t&&n)&&.01>Math.abs(this.rvel.z))&&(this.setStationary(),!0)}},{key:"setStationary",value:function(){this.vel.copy(o.v_),this.rvel.copy(o.v_),this.state="Stationary"}},{key:"isRolling",value:function(){return 0!==this.vel.lengthSq()&&0!==this.rvel.lengthSq()&&(0,s.Mq)(this.vel,this.rvel).length()<n.transition}},{key:"onTable",value:function(){return"Falling"!==this.state&&"InPocket"!==this.state}},{key:"inMotion",value:function(){return"Rolling"===this.state||"Sliding"===this.state||this.isFalling()}},{key:"isFalling",value:function(){return"Falling"===this.state}},{key:"futurePosition",value:function(e){return this.futurePos.copy(this.pos).addScaledVector(this.vel,e),this.futurePos}},{key:"fround",value:function(){this.pos.x=Math.fround(this.pos.x),this.pos.y=Math.fround(this.pos.y),this.vel.x=Math.fround(this.vel.x),this.vel.y=Math.fround(this.vel.y),this.rvel.x=Math.fround(this.rvel.x),this.rvel.y=Math.fround(this.rvel.y),this.rvel.z=Math.fround(this.rvel.z)}},{key:"serialise",value:function(){return{pos:this.pos.clone(),id:this.id}}}],t=[{key:"fromSerialised",value:function(e){return n.updateFromSerialised(new n((0,o.t6)(e.pos)),e)}},{key:"updateFromSerialised",value:function(e,t){var n,r;return e.pos.copy(t.pos),e.vel.copy(null!=(n=null==t?void 0:t.vel)?n:o.v_),e.rvel.copy(null!=(r=null==t?void 0:t.rvel)?r:o.v_),e.state="Stationary",e}}],e&&l(n.prototype,e),t&&l(n,t),n}();c(h,"id",0),c(h,"transition",.05)},"./src/model/outcome.ts"(e,t,n){n.d(t,{$:()=>o,P:()=>s});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i,o=((i={}).Pot="Pot",i.Cushion="Cushion",i.Collision="Collision",i.Hit="Hit",i),s=function(){var e;function t(e,n,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"type",void 0),r(this,"timestamp",void 0),r(this,"ballA",null),r(this,"ballB",null),r(this,"incidentSpeed",void 0),this.type=e,this.ballA=n,this.ballB=i,this.incidentSpeed=o,this.timestamp=Date.now()}return e=[{key:"pot",value:function(e,n){return new t("Pot",e,e,n)}},{key:"cushion",value:function(e,n){return new t("Cushion",e,e,n)}},{key:"collision",value:function(e,n,r){return new t("Collision",e,n,r)}},{key:"hit",value:function(e,n){return new t("Hit",e,e,n)}},{key:"isCueBallPotted",value:function(e,t){return t.some(function(t){return"Pot"==t.type&&t.ballA===e})}},{key:"isBallPottedNoFoul",value:function(e,n){return n.some(function(e){return"Pot"==e.type&&null!==e.ballA})&&!t.isCueBallPotted(e,n)}},{key:"pots",value:function(e){return e.filter(function(e){return"Pot"==e.type}).map(function(e){return e.ballA})}},{key:"potCount",value:function(e){return this.pots(e).length}},{key:"onlyRedsPotted",value:function(e){return this.pots(e).every(function(e){return e.id>6})}},{key:"firstCollision",value:function(e){var t=e.filter(function(e){return"Collision"===e.type});return t.length>0?t[0]:void 0}},{key:"isClearTable",value:function(e){var t=e.balls.filter(function(e){return e.onTable()});return 1===t.length&&t[0]===e.cueball}},{key:"isThreeCushionPoint",value:function(e,n){n=t.cueBallFirst(e,n).filter(function(t){return t.ballA===e});var r=new Set,i=0,o=!0,s=!1,a=void 0;try{for(var l,c=n[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value;if("Cushion"===u.type&&i++,"Collision"===u.type&&(r.add(u.ballB),2===r.size))return i>=3}}catch(e){s=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(s)throw a}}return!1}},{key:"cueBallFirst",value:function(e,t){return t.forEach(function(t){"Collision"===t.type&&t.ballB===e&&(t.ballB=t.ballA,t.ballA=e)}),t}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/model/physics/collision.ts"(e,t,n){n.d(t,{F:()=>h});var r,i,o=n("./src/model/ball.ts"),s=n("./node_modules/three/build/three.core.js"),a=n("./src/model/physics/constants.ts"),l=n("./src/utils/utils.ts");function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"normalImpulse",void 0),c(this,"tangentialImpulse",void 0)}return e=[{key:"dynamicFriction",value:function(e){return .01+.108*(0,l.oN)(-1.088*e)}},{key:"updateVelocities",value:function(e,t){var n=h.positionsAtContact(e,t);e.ballmesh.trace.forceTrace(n.a),t.ballmesh.trace.forceTrace(n.b);var r=n.b.sub(n.a).normalize(),i=new s.Pq0(-r.y,r.x,0),o=e.vel.clone().sub(t.vel).add(r.clone().multiplyScalar(-a.R).cross(e.rvel).sub(r.clone().multiplyScalar(a.R).cross(t.rvel))),l=r.dot(o),c=o.addScaledVector(r,-l),u=c.length(),p=i.dot(c),f=this.dynamicFriction(u);this.normalImpulse=-1.99*l/(2/a.m),this.tangentialImpulse=-(.25*Math.min(f*Math.abs(this.normalImpulse)/u,1/7)*p);var d=r.clone().multiplyScalar(this.normalImpulse),m=i.clone().multiplyScalar(this.tangentialImpulse);e.vel.addScaledVector(d,1/a.m).addScaledVector(m,1/a.m),t.vel.addScaledVector(d,-1/a.m).addScaledVector(m,-1/a.m);var v=r.clone().multiplyScalar(-a.R).cross(m),y=r.clone().multiplyScalar(a.R).cross(m);return e.rvel.addScaledVector(v,1/a.I),t.rvel.addScaledVector(y,1/a.I),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),h=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"willCollide",value:function(e,t,n){return(e.inMotion()||t.inMotion())&&e.onTable()&&t.onTable()&&e.futurePosition(n).distanceToSquared(t.futurePosition(n))<4*a.R*a.R}},{key:"collide",value:function(e,n){return t.updateVelocities(e,n)}},{key:"positionsAtContact",value:function(e,t){var n=e.pos.distanceTo(t.pos),r=e.vel.clone().sub(t.vel),i=(n-2*a.R)/r.length()||0;return{a:e.pos.clone().addScaledVector(e.vel,i),b:t.pos.clone().addScaledVector(t.vel,i)}}},{key:"updateVelocities",value:function(e,n){var r=t.model.updateVelocities(e,n);return e.state=o.U.Sliding,n.state=o.U.Sliding,r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r="model",i=new u,r in h?Object.defineProperty(h,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):h[r]=i},"./src/model/physics/constants.ts"(e,t,n){n.d(t,{I:()=>o,Mz:()=>r,PX:()=>A,Qg:()=>k,R:()=>p,Wv:()=>S,Ys:()=>P,Z3:()=>y,_m:()=>v,cM:()=>T,e:()=>f,ee:()=>d,g:()=>s,gT:()=>c,gf:()=>l,jG:()=>w,kL:()=>u,kM:()=>E,ki:()=>O,ko:()=>R,m:()=>h,mu:()=>a,o5:()=>b,oV:()=>m,x3:()=>i,xO:()=>x});var r,i,o,s=9.8,a=.00985,l=.16,c=.85,u=.034,h=.23,p=.03275,f=.86,d=.98,m=.212,v=.14,y=.4,b=Math.sqrt(21)/5;function g(){r=a*h*s*2/3*u,i=7/(5*Math.sqrt(2))*p*a*h*s,o=.4*h*p*p}function w(e){p=e,g()}function k(e){h=e,g()}function x(e){a=e,g()}function S(e){u=e,g()}function P(e){l=e}function T(e){f=e}function E(e){c=e}function R(e){m=e}function O(e){v=e}function A(e){d=e}g()},"./src/model/physics/knuckle.ts"(e,t,n){n.d(t,{O:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/view/pocketgeometry.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");s(this,"pos",void 0),s(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"bounce",value:function(e){var t=e.pos.clone().sub(this.pos).normalize(),n=t.dot(e.vel);return e.vel.addScaledVector(t,-2*r.e*n),e.rvel.multiplyScalar(.5),Math.abs(n)}}],t=[{key:"willBounce",value:function(e,t){return t.distanceTo(e.pos)<r.R+e.radius}},{key:"findBouncing",value:function(e,t){var r=e.futurePosition(t);return i.f.knuckles.find(function(e){return n.willBounce(e,r)})}}],e&&o(n.prototype,e),t&&o(n,t),n}()},"./src/model/physics/mathaven.ts"(e,t,n){n.d(t,{z:()=>s});var r=n("./src/utils/utils.ts"),i=n("./src/model/physics/constants.ts");function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){var e;function t(e,n,r,i,s){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");o(this,"P",0),o(this,"WzI",0),o(this,"vx",void 0),o(this,"vy",void 0),o(this,"œâx",void 0),o(this,"œây",void 0),o(this,"œâz",void 0),o(this,"s",void 0),o(this,"œÜ",void 0),o(this,"s π",void 0),o(this,"œÜ π",void 0),o(this,"i",0),o(this,"N",100),o(this,"M",void 0),o(this,"R",void 0),o(this,"Œºs",void 0),o(this,"Œºw",void 0),o(this,"ee",void 0),this.M=e,this.R=n,this.ee=r,this.Œºs=i,this.Œºw=s}return e=[{key:"updateSlipSpeedsAndAngles",value:function(){var e=this.R,t=this.vx+this.œây*e*i.Z3-this.œâz*e*i.o5,n=-this.vy*i.Z3+this.œâx*e,o=this.vx-this.œây*e,s=this.vy+this.œâx*e;this.s=(0,r.RZ)((0,r.n7)(t,2)+(0,r.n7)(n,2)),this.œÜ=(0,r.FP)(n,t),this.œÜ<0&&(this.œÜ+=2*Math.PI),this.s π=(0,r.RZ)((0,r.n7)(o,2)+(0,r.n7)(s,2)),this.œÜ π=(0,r.FP)(s,o),this.œÜ π<0&&(this.œÜ π+=2*Math.PI)}},{key:"compressionPhase",value:function(){for(var e=Math.max(this.M*this.vy/this.N,.001);this.vy>0;)this.updateSingleStep(e)}},{key:"restitutionPhase",value:function(e){var t=Math.max(e/this.N,.001);for(this.WzI=0;this.WzI<e;)this.updateSingleStep(t)}},{key:"updateSingleStep",value:function(e){if(this.updateSlipSpeedsAndAngles(),this.updateVelocity(e),this.updateAngularVelocity(e),this.updateWorkDone(e),this.i++>10*this.N)throw Error("Solution not found")}},{key:"updateVelocity",value:function(e){var t=this.Œºs,n=this.Œºw,o=this.M;this.vx-=1/o*(n*(0,r.gn)(this.œÜ)+t*(0,r.gn)(this.œÜ π)*(i.Z3+n*(0,r.F8)(this.œÜ)*i.o5))*e,this.vy-=1/o*(i.o5-n*i.Z3*(0,r.F8)(this.œÜ)+t*(0,r.F8)(this.œÜ π)*(i.Z3+n*(0,r.F8)(this.œÜ)*i.o5))*e}},{key:"updateAngularVelocity",value:function(e){var t=this.Œºs,n=this.Œºw,o=this.M,s=this.R;this.œâx+=-(5/(2*o*s))*(n*(0,r.F8)(this.œÜ)+t*(0,r.F8)(this.œÜ π)*(i.Z3+n*(0,r.F8)(this.œÜ)*i.o5))*e,this.œây+=-(5/(2*o*s))*(n*(0,r.gn)(this.œÜ)*i.Z3-t*(0,r.gn)(this.œÜ π)*(i.Z3+n*(0,r.F8)(this.œÜ)*i.o5))*e,this.œâz+=5/(2*o*s)*(n*(0,r.gn)(this.œÜ)*i.o5)*e}},{key:"updateWorkDone",value:function(e){var t=e*Math.abs(this.vy);this.WzI+=t,this.P+=e}},{key:"solvePaper",value:function(e,t,n,i){this.solve(e*(0,r.gn)(t),e*(0,r.F8)(t),-i*(0,r.F8)(t),i*(0,r.gn)(t),n)}},{key:"solve",value:function(e,t,n,r,i){this.vx=e,this.vy=t,this.œâx=n,this.œây=r,this.œâz=i,this.WzI=0,this.P=0,this.i=0,this.compressionPhase();var o=this.ee*this.ee*this.WzI;this.restitutionPhase(o)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/model/physics/physics.ts"(e,t,n){n.d(t,{$8:()=>E,Gp:()=>w,JD:()=>h,Mq:()=>l,QK:()=>f,QV:()=>T,Qy:()=>A,Un:()=>g,c0:()=>b,lx:()=>p,p2:()=>u,s0:()=>y,t6:()=>M,yO:()=>k});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/utils/utils.ts"),o=n("./src/model/physics/constants.ts"),s=n("./src/model/physics/mathaven.ts"),a=new r.Pq0;function l(e,t){return a.copy(e).addScaledVector((0,i.KM)(t),o.R)}var c={v:new r.Pq0,w:new r.Pq0};function u(e,t){var n=l(e,t).setZ(0);return c.v.copy((0,i.xb)(n).multiplyScalar(-o.gf*o.g)),c.w.copy((0,i.xb)((0,i.KM)(n)).multiplyScalar(2.5*o.gf*o.g/o.R)),c.w.setZ(-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(t.z)),c}function h(e){var t=new r.Pq0(e.x,e.y,0).length(),n=5/7*o.x3/(o.m*o.R)/t,i=5/7*o.x3/(o.m*o.R*o.R)/t;return c.v.set(-n*e.y,n*e.x,0),c.w.set(-i*e.x,-i*e.y,-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(e.z)),c}function p(e,t){var n=t.z;t.copy((0,i.KM)(e).multiplyScalar(1/o.R)),t.setZ(n)}function f(e,t,n,r){var o=r(t.clone().applyAxisAngle(i.up,e),n.clone().applyAxisAngle(i.up,e));return o.v.applyAxisAngle(i.up,-e),o.w.applyAxisAngle(i.up,-e),o}Object.freeze(c);var d=Math.asin(.1*o.R/o.R),m=(0,i.F8)(d),v=(0,i.gn)(d);function y(e,t){return new r.Pq0(e.x*m-e.z*v+o.R*t.y,-e.y-o.R*t.z*v+o.R*t.x*m)}function b(e){return e.x*v}function g(e){var t=3.5/o.m;return e.length()/t}function w(e){var t,n=1/o.m,i=.39+.257*(t=new r.Pq0(e/v,0,0)).x-.044*t.x*t.x;return o.gT*((1+i)*e)/n}function k(e,t){var n=w(b(e));return g(y(e,t))<=n}function x(e,t){return{c:b(e),s:y(e,t),A:3.5/o.m,B:1/o.m}}function S(e,t){var n=x(e,t),r=n.c,i=n.s,s=n.A,a=n.B,l=(1+o.e)*(r/a);return R(-i.x/s*m-l*v,i.y/s,i.x/s*v-l*m)}function P(e,t){var n,r=x(e,t),i=r.c,s=r.B,a=(1+o.e)*(i/s),l=.471-.241*Math.atan2(Math.abs((n=e).y),n.x),c=Math.atan2(e.y,e.x),u=Math.cos(c);return R(-l*a*u*v-a*v,l*a*Math.sin(c),l*a*u*v-a*m)}function T(e,t){return k(e,t)?S(e,t):P(e,t)}function E(e,t){var n=S(e,t),r=P(e,t),i=Math.sign(e.y)===Math.sign(t.z)?Math.cos(Math.atan2(e.y,e.x)):1;return{v:r.v.lerp(n.v,i),w:r.w.lerp(n.w,i)}}function R(e,t,n){return{v:new r.Pq0(e/o.m,t/o.m),w:new r.Pq0(-o.R/o.I*t*m,o.R/o.I*(e*m-n*v),o.R/o.I*t*v)}}function O(e,t){var n=new s.z(o.m,o.R,o.ee,o.oV,o._m+.1);n.solve(e.x,e.y,t.x,t.y,t.z);var i=new r.Pq0(n.vx,n.vy,0),a=new r.Pq0(n.œâx,n.œây,n.œâz);return{v:i.sub(e),w:a.sub(t)}}function A(e,t){return f(Math.PI/2,e,t,O)}function M(e,t){var n=Math.atan2(-e.x,e.y),r=2.5*t.length()*(e.length()*o.R)/(o.R*o.R),s=t.clone().normalize();return(0,i.KM)(s).applyAxisAngle(s,n).multiplyScalar(r)}},"./src/model/physics/pocket.ts"(e,t,n){n.d(t,{Z:()=>l});var r=n("./src/model/ball.ts"),i=n("./src/model/physics/constants.ts"),o=n("./src/utils/utils.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");a(this,"pos",void 0),a(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"fall",value:function(e,t){return e.vel.z=-i.g*t,e.state=r.U.Falling,e.pocket=this,e.vel.length()}},{key:"updateFall",value:function(e,t){e.vel.addScaledVector(o.up,-(10*i.R)*t*i.g);var n=e.pos.z;if(e.pos.clone().setZ(0).distanceTo(this.pos)>this.radius-i.R){var s=this.pos.clone().sub(e.pos).normalize().setZ(0);n>-i.R/2&&(e.vel.addScaledVector(s,7*i.R*t*i.g),e.rvel.addScaledVector((0,o.KM)(s),7*t*i.g)),0>e.vel.dot(s)&&(e.ballmesh.trace.forceTrace(e.pos),e.vel.x=s.x*e.vel.length()/2,e.vel.y=s.y*e.vel.length()/2)}var a=this.restingDepth(e);n<a&&0!==e.rvel.length()&&(e.pos.z=a,e.vel.z=-i.R/10,e.rvel.copy(o.v_)),n<a-i.R&&(e.pos.z=a-i.R,e.setStationary(),e.state=r.U.InPocket)}},{key:"restingDepth",value:function(e){return -3*i.R-i.R*e.id/4}}],t=[{key:"willFall",value:function(e,t){return t.distanceTo(e.pos)<e.radius}},{key:"findPocket",value:function(e,t,r){var i=t.futurePosition(r);return e.find(function(e){return n.willFall(e,i)})}}],e&&s(n.prototype,e),t&&s(n,t),n}()},"./src/model/table.ts"(e,t,n){n.d(t,{X:()=>b});var r=n("./src/view/tablegeometry.ts"),i=n("./src/model/physics/physics.ts"),o=n("./src/view/pocketgeometry.ts"),s=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"bounceAny",value:function(e,n){var o=!(arguments.length>2)||void 0===arguments[2]||arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i.$8,a=e.futurePosition(n);if(t.willBounceLong(a,o)){var l=a.y>r.P.tableY?-Math.PI/2:Math.PI/2;return t.bounceIn(l,e,s)}if(t.willBounceShort(a,o)){var c=a.x>r.P.tableX?0:Math.PI;return t.bounceIn(c,e,s)}}},{key:"willBounceShort",value:function(e,n){return n?t.willBounceShortSegment(o.f.pockets.pocketNW.knuckleSW.pos.y,o.f.pockets.pocketSW.knuckleNW.pos.y,e):t.willBounceShortSegment(r.P.Y,-r.P.Y,e)}},{key:"willBounceLong",value:function(e,n){return n?t.willBounceLongSegment(o.f.pockets.pocketNW.knuckleNE.pos.x,o.f.pockets.pocketN.knuckleNW.pos.x,e)||t.willBounceLongSegment(o.f.pockets.pocketN.knuckleNE.pos.x,o.f.pockets.pocketNE.knuckleNW.pos.x,e):t.willBounceLongSegment(-r.P.X,r.P.X,e)}},{key:"willBounceLongSegment",value:function(e,t,n){return n.x>e&&n.x<t&&Math.abs(n.y)>r.P.tableY}},{key:"willBounceShortSegment",value:function(e,t,n){return n.y>t&&n.y<e&&Math.abs(n.x)>r.P.tableX}},{key:"bounceIn",value:function(e,t,n){t.ballmesh.trace.forceTrace(t.futurePos);var r=(0,i.QK)(e,t.vel,t.rvel,n);return t.vel.add(r.v),t.rvel.add(r.w),r.v.length()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),a=n("./src/model/physics/collision.ts"),l=n("./src/model/physics/knuckle.ts"),c=n("./src/model/physics/pocket.ts"),u=n("./src/view/cue.ts"),h=n("./src/model/ball.ts"),p=n("./src/events/aimevent.ts"),f=n("./src/model/outcome.ts"),d=n("./src/utils/utils.ts"),m=n("./src/model/physics/constants.ts");function v(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var b=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");y(this,"balls",void 0),y(this,"cue",new u.s),y(this,"pairs",void 0),y(this,"outcome",[]),y(this,"cueball",void 0),y(this,"cushionModel",i.$8),y(this,"mesh",void 0),this.cueball=e[0],this.initialiseBalls(e)}return e=[{key:"initialiseBalls",value:function(e){this.balls=e,this.pairs=[];for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++)t<n&&this.pairs.push({a:e[t],b:e[n]})}},{key:"updateBallMesh",value:function(e){this.balls.forEach(function(t){t.updateMesh(e)})}},{key:"advance",value:function(e){for(var t=0;!this.prepareAdvanceAll(e);)if(t++>100)throw Error("Depth exceeded resolving collisions");this.balls.forEach(function(t){t.update(e),t.fround()})}},{key:"prepareAdvanceAll",value:function(e){var t=this;return this.pairs.every(function(n){return t.prepareAdvancePair(n.a,n.b,e)})&&this.balls.every(function(n){return t.prepareAdvanceToCushions(n,e)})}},{key:"prepareAdvancePair",value:function(e,t,n){if(a.F.willCollide(e,t,n)){var r=a.F.collide(e,t);return this.outcome.push(f.P.collision(e,t,r)),!1}return!0}},{key:"prepareAdvanceToCushions",value:function(e,t){if(!e.onTable())return!0;var n=e.futurePosition(t);if(Math.abs(n.y)<r.P.tableY&&Math.abs(n.x)<r.P.tableX)return!0;var i=s.bounceAny(e,t,r.P.hasPockets,this.cushionModel);if(i)return this.outcome.push(f.P.cushion(e,i)),!1;var a=l.O.findBouncing(e,t);if(a){var u=a.bounce(e);return this.outcome.push(f.P.cushion(e,u)),!1}var h=c.Z.findPocket(o.f.pocketCenters,e,t);if(h){var p=h.fall(e,t);return this.outcome.push(f.P.pot(e,p)),!1}return!0}},{key:"allStationary",value:function(){return this.balls.every(function(e){return!e.inMotion()})}},{key:"inPockets",value:function(){return this.balls.reduce(function(e,t){return t.onTable()?e:e+1},0)}},{key:"hit",value:function(){this.cue.hit(this.cueball),this.balls.forEach(function(e){e.ballmesh.trace.reset()})}},{key:"serialise",value:function(){return{balls:this.balls.map(function(e){return e.serialise()}),aim:this.cue.aim.copy()}}},{key:"updateFromSerialised",value:function(e){var t=this;e.balls&&e.balls.forEach(function(e){return h.c.updateFromSerialised(t.balls[e.id],e)}),e.aim&&(this.cue.aim=p.w.fromJson(e.aim))}},{key:"applyAuthoritativeState",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.1;e.balls&&e.balls.forEach(function(e){var r=t.balls[e.id];r&&r.setServerState(e,n)}),e.aim&&(this.cue.aim=p.w.fromJson(e.aim))}},{key:"applyInitialServerState",value:function(e){var t=this;e.balls&&e.balls.forEach(function(e){var n=t.balls[e.id];n&&(void 0!==e.ballNumber&&n.setBallNumber(e.ballNumber),n.setServerState(e,0))})}},{key:"shortSerialise",value:function(){return this.balls.map(function(e){return[e.pos.x,e.pos.y]}).reduce(function(e,t){return e.concat(t)},[])}},{key:"updateFromShortSerialised",value:function(e){this.balls.forEach(function(t,n){t.pos.x=e[2*n],t.pos.y=e[2*n+1],t.pos.z=0,t.vel.copy(d.v_),t.rvel.copy(d.v_),t.state=h.U.Stationary})}},{key:"addToScene",value:function(e){this.balls.forEach(function(t){t.ballmesh.addToScene(e)}),e.add(this.cue.mesh),e.add(this.cue.helperMesh),e.add(this.cue.placerMesh)}},{key:"showTraces",value:function(e){this.balls.forEach(function(t){t.ballmesh.trace.line.visible=e,t.ballmesh.trace.reset()})}},{key:"showSpin",value:function(e){this.balls.forEach(function(t){t.ballmesh.spinAxisArrow.visible=e})}},{key:"halt",value:function(){this.balls.forEach(function(e){e.vel.copy(d.v_),e.rvel.copy(d.v_),e.state=h.U.Stationary})}},{key:"roundCueBallPosition",value:function(){var e=this.cueball.pos.clone();this.overlapsAny(e)||this.cueball.pos.copy(e)}},{key:"overlapsAny",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cueball;return this.balls.filter(function(e){return e!==t}).some(function(t){return t.pos.distanceTo(e)<2*m.R})}}],t=[{key:"fromSerialised",value:function(e){var t=new n(e.balls.map(function(e){return h.c.fromSerialised(e)}));return t.updateFromSerialised(e),t}}],e&&v(n.prototype,e),t&&v(n,t),n}()},"./src/network/client/session.ts"(e,t,n){n.d(t,{N:()=>i});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i=function(){var e;function t(e,n,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"clientId",void 0),r(this,"username",void 0),r(this,"tableId",void 0),r(this,"spectator",void 0),this.clientId=e,this.username=n,this.tableId=i,this.spectator=o}return e=[{key:"getInstance",value:function(){if(!t.instance)throw Error("Session not initialized");return t.instance}},{key:"isSpectator",value:function(){return void 0!==t.instance&&t.getInstance().spectator}},{key:"reset",value:function(){t.instance=void 0}},{key:"init",value:function(e,n,r,i){t.instance=new t(e,n,r,i)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r(i,"instance",void 0)},"./src/utils/gltf.ts"(e,t,n){n.d(t,{KP:()=>ex,Ro:()=>eS});var r=n("./node_modules/three/build/three.core.js");let i={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class o{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(e){return new m(e)}),this.register(function(e){return new v(e)}),this.register(function(e){return new w(e)}),this.register(function(e){return new k(e)}),this.register(function(e){return new x(e)}),this.register(function(e){return new S(e)}),this.register(function(e){return new y(e)}),this.register(function(e){return new b(e)}),this.register(function(e){return new g(e)}),this.register(function(e){return new P(e)}),this.register(function(e){return new T(e)}),this.register(function(e){return new E(e)}),this.register(function(e){return new R(e)}),this.register(function(e){return new O(e)})}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,n,r){let i=new d,o=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)o.push(this.pluginCallbacks[e](i));i.setPlugins(o),i.setTextureUtils(this.textureUtils),i.writeAsync(e,t,r).catch(n)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,r,i,t)})}}let s="KHR_mesh_quantization",a={};a[r.hxR]=9728,a[r.pHI]=9984,a[r.Cfg]=9986,a[r.k6q]=9729,a[r.kRr]=9985,a[r.$_I]=9987,a[r.ghU]=33071,a[r.GJx]=10497,a[r.kTW]=33648;let l={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},c=new r.Q1f;function u(e,t){return e.length===t.length&&e.every(function(e,n){return e===t[n]})}function h(e){return 4*Math.ceil(e/4)}function p(e,t=0){let n=h(e.byteLength);if(n!==e.byteLength){let r=new Uint8Array(n);if(r.set(new Uint8Array(e)),0!==t)for(let i=e.byteLength;i<n;i++)r[i]=t;return r.buffer}return e}function f(){return"u"<typeof document&&"u">typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}class d{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+r.sPf}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,n={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);let r=this.buffers,i=this.json;n=this.options;let o=this.extensionsUsed,s=this.extensionsRequired,a=new Blob(r,{type:"application/octet-stream"}),l=Object.keys(o),c=Object.keys(s);if(l.length>0&&(i.extensionsUsed=l),c.length>0&&(i.extensionsRequired=c),i.buffers&&i.buffers.length>0&&(i.buffers[0].byteLength=a.size),!0===n.binary){let e=new FileReader;e.readAsArrayBuffer(a),e.onloadend=function(){var n;let r=p(e.result),o=new DataView(new ArrayBuffer(8));o.setUint32(0,r.byteLength,!0),o.setUint32(4,5130562,!0);let s=p((n=JSON.stringify(i),new TextEncoder().encode(n).buffer),32),a=new DataView(new ArrayBuffer(8));a.setUint32(0,s.byteLength,!0),a.setUint32(4,0x4e4f534a,!0);let l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,0x46546c67,!0),c.setUint32(4,2,!0);let u=12+a.byteLength+s.byteLength+o.byteLength+r.byteLength;c.setUint32(8,u,!0);let h=new Blob([l,a,s,o,r],{type:"application/octet-stream"}),f=new FileReader;f.readAsArrayBuffer(h),f.onloadend=function(){t(f.result)}}}else if(i.buffers&&i.buffers.length>0){let e=new FileReader;e.readAsDataURL(a),e.onloadend=function(){let n=e.result;i.buffers[0].uri=n,t(i)}}else t(i)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;let n=this.options,r=this.extensionsUsed;try{let i=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&i.gltfExtensions){for(let e in void 0===t.extensions&&(t.extensions={}),i.gltfExtensions)t.extensions[e]=i.gltfExtensions[e],r[e]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){let t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;let t=new r.Pq0;for(let n=0,r=e.count;n<r;n++)if(Math.abs(t.fromBufferAttribute(e,n).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);let n=e.clone(),i=new r.Pq0;for(let e=0,t=n.count;e<t;e++)i.fromBufferAttribute(n,e),0===i.x&&0===i.y&&0===i.z?i.setX(1):i.normalize(),n.setXYZ(e,i.x,i.y,i.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1,r={};(0!==t.offset.x||0!==t.offset.y)&&(r.offset=t.offset.toArray(),n=!0),0!==t.rotation&&(r.rotation=t.rotation,n=!0),(1!==t.repeat.x||1!==t.repeat.y)&&(r.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function n(e){return e.colorSpace===r.er$?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}e instanceof r.FvD&&(e=await this.decompressTextureAsync(e)),t instanceof r.FvD&&(t=await this.decompressTextureAsync(t));let i=e?e.image:null,o=t?t.image:null,s=Math.max(i?i.width:0,o?o.width:0),a=Math.max(i?i.height:0,o?o.height:0),l=f();l.width=s,l.height=a;let c=l.getContext("2d",{willReadFrequently:!0});c.fillStyle="#00ffff",c.fillRect(0,0,s,a);let u=c.getImageData(0,0,s,a);if(i){c.drawImage(i,0,0,s,a);let t=n(e),r=c.getImageData(0,0,s,a).data;for(let e=2;e<r.length;e+=4)u.data[e]=256*t(r[e]/256)}if(o){c.drawImage(o,0,0,s,a);let e=n(t),r=c.getImageData(0,0,s,a).data;for(let t=1;t<r.length;t+=4)u.data[t]=256*e(r[t]/256)}c.putImageData(u,0,0);let h=(e||t).clone();return h.source=new r.kLi(l),h.colorSpace=r.jf0,h.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),h}async decompressTextureAsync(e,t=1/0){if(null===this.textureUtils)throw Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){let t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,i,o){let s,a=this.json;switch(!a.bufferViews&&(a.bufferViews=[]),t){case 5120:case 5121:s=1;break;case 5122:case 5123:s=2;break;default:s=4}let l=e.itemSize*s;34962===o&&(l=4*Math.ceil(l/4));let c=h(i*l),u=new DataView(new ArrayBuffer(c)),p=0;for(let o=n;o<n+i;o++){for(let n=0;n<e.itemSize;n++){let i;e.itemSize>4?i=e.array[o*e.itemSize+n]:(0===n?i=e.getX(o):1===n?i=e.getY(o):2===n?i=e.getZ(o):3===n&&(i=e.getW(o)),!0===e.normalized&&(i=r.cj9.normalize(i,e.array))),5126===t?u.setFloat32(p,i,!0):5124===t?u.setInt32(p,i,!0):5125===t?u.setUint32(p,i,!0):5122===t?u.setInt16(p,i,!0):5123===t?u.setUint16(p,i,!0):5120===t?u.setInt8(p,i):5121===t&&u.setUint8(p,i),p+=s}p%l!=0&&(p+=l-p%l)}let f={buffer:this.processBuffer(u.buffer),byteOffset:this.byteOffset,byteLength:c};return void 0!==o&&(f.target=o),34962===o&&(f.byteStride=l),this.byteOffset+=c,a.bufferViews.push(f),{id:a.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){let t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise(function(r){let i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){let e=p(i.result),o={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,r(n.bufferViews.push(o)-1)}})}processAccessor(e,t,n,i){let o,s,a=this.json;if(e.array.constructor===Float32Array)o=5126;else if(e.array.constructor===Int32Array)o=5124;else if(e.array.constructor===Uint32Array)o=5125;else if(e.array.constructor===Int16Array)o=5122;else if(e.array.constructor===Uint16Array)o=5123;else if(e.array.constructor===Int8Array)o=5120;else if(e.array.constructor===Uint8Array)o=5121;else throw Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(void 0===n&&(n=0),(void 0===i||i===1/0)&&(i=e.count),0===i)return null;let l=function(e,t,n){let i={min:Array(e.itemSize).fill(1/0),max:Array(e.itemSize).fill(-1/0)};for(let o=t;o<t+n;o++)for(let t=0;t<e.itemSize;t++){let n;e.itemSize>4?n=e.array[o*e.itemSize+t]:(0===t?n=e.getX(o):1===t?n=e.getY(o):2===t?n=e.getZ(o):3===t&&(n=e.getW(o)),!0===e.normalized&&(n=r.cj9.normalize(n,e.array))),i.min[t]=Math.min(i.min[t],n),i.max[t]=Math.max(i.max[t],n)}return i}(e,n,i);void 0!==t&&(s=e===t.index?34963:34962);let c=this.processBufferView(e,o,n,i,s),u={bufferView:c.id,byteOffset:c.byteOffset,componentType:o,count:i,max:l.max,min:l.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(u.normalized=!0),a.accessors||(a.accessors=[]),a.accessors.push(u)-1}processImage(e,t,n,i="image/png"){if(null!==e){let o=this,s=o.cache,a=o.json,l=o.options,c=o.pending;s.images.has(e)||s.images.set(e,{});let u=s.images.get(e),h=i+":flipY/"+n.toString();if(void 0!==u[h])return u[h];a.images||(a.images=[]);let p={mimeType:i},d=f();d.width=Math.min(e.width,l.maxTextureSize),d.height=Math.min(e.height,l.maxTextureSize);let m=d.getContext("2d",{willReadFrequently:!0});if(!0===n&&(m.translate(0,d.height),m.scale(1,-1)),void 0!==e.data){t!==r.GWd&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>l.maxTextureSize||e.height>l.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let n=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<n.length;t+=4)n[t+0]=e.data[t+0],n[t+1]=e.data[t+1],n[t+2]=e.data[t+2],n[t+3]=e.data[t+3];m.putImageData(new ImageData(n,e.width,e.height),0,0)}else if("u">typeof HTMLImageElement&&e instanceof HTMLImageElement||"u">typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"u">typeof ImageBitmap&&e instanceof ImageBitmap||"u">typeof OffscreenCanvas&&e instanceof OffscreenCanvas)m.drawImage(e,0,0,d.width,d.height);else throw Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");!0===l.binary?c.push((function(e,t){if(!("u">typeof OffscreenCanvas&&e instanceof OffscreenCanvas))return new Promise(n=>e.toBlob(n,t));{let n;return"image/jpeg"===t?n=.92:"image/webp"===t&&(n=.8),e.convertToBlob({type:t,quality:n})}})(d,i).then(e=>o.processBufferViewImage(e)).then(e=>{p.bufferView=e})):p.uri=r.HgN.getDataURL(d,i);let v=a.images.push(p)-1;return u[h]=v,v}throw Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){let t=this.json;t.samplers||(t.samplers=[]);let n={magFilter:a[e.magFilter],minFilter:a[e.minFilter],wrapS:a[e.wrapS],wrapT:a[e.wrapT]};return t.samplers.push(n)-1}async processTextureAsync(e){let t=this.options,n=this.cache,i=this.json;if(n.textures.has(e))return n.textures.get(e);i.textures||(i.textures=[]),e instanceof r.FvD&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let o=e.userData.mimeType;"image/webp"===o&&(o="image/png");let s={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,o)};e.name&&(s.name=e.name),await this._invokeAllAsync(async function(t){t.writeTexture&&await t.writeTexture(e,s)});let a=i.textures.push(s)-1;return n.textures.set(e,a),a}async processMaterialAsync(e){let t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);let i={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");let o=e.color.toArray().concat([e.opacity]);if(u(o,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=o),e.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=e.metalness,i.pbrMetallicRoughness.roughnessFactor=e.roughness):(i.pbrMetallicRoughness.metallicFactor=0,i.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){let t=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),n={index:await this.processTextureAsync(t),texCoord:t.channel};this.applyTextureTransform(n,t),i.pbrMetallicRoughness.metallicRoughnessTexture=n}if(e.map){let t={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),i.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){let t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(i.emissiveFactor=e.emissive.toArray()),e.emissiveMap){let t={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),i.emissiveTexture=t}}if(e.normalMap){let t={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),i.normalTexture=t}if(e.aoMap){let t={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),i.occlusionTexture=t}e.transparent?i.alphaMode="BLEND":e.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=e.alphaTest),e.side===r.$EB&&(i.doubleSided=!0),""!==e.name&&(i.name=e.name),this.serializeUserData(e,i),await this._invokeAllAsync(async function(t){t.writeMaterialAsync&&await t.writeMaterialAsync(e,i)});let s=n.materials.push(i)-1;return t.materials.set(e,s),s}async processMeshAsync(e){let t,n=this.cache,i=this.json,s=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,n=e.material.length;t<n;t++)s.push(e.material[t].uuid);else s.push(e.material.uuid);let a=s.join(":");if(n.meshes.has(a))return n.meshes.get(a);let l=e.geometry;t=e.isLineSegments?1:e.isLineLoop?2:e.isLine?3:e.isPoints?0:e.material.wireframe?1:4;let c={},u={},h=[],p=[],f={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=l.getAttribute("normal");void 0===d||this.isNormalizedNormalAttribute(d)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),l.setAttribute("normal",this.createNormalizedNormalAttribute(d)));let m=null;for(let e in l.attributes){if("morph"===e.slice(0,5))continue;let t=l.attributes[e];if(e=f[e]||e.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),n.attributes.has(this.getUID(t))){u[e]=n.attributes.get(this.getUID(t));continue}m=null;let i=t.array;"JOINTS_0"!==e||i instanceof Uint16Array||i instanceof Uint8Array?(i instanceof Uint32Array||i instanceof Int32Array)&&!e.startsWith("_")&&(console.warn(`GLTFExporter: Attribute "${e}" converted to type FLOAT.`),m=o.Utils.toFloat32BufferAttribute(t)):(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),m=new r.THS(new Uint16Array(i),t.itemSize,t.normalized));let s=this.processAccessor(m||t,l);null!==s&&(e.startsWith("_")||this.detectMeshQuantization(e,t),u[e]=s,n.attributes.set(this.getUID(t),s))}if(void 0!==d&&l.setAttribute("normal",d),0===Object.keys(u).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){let t=[],r=[],i={};if(void 0!==e.morphTargetDictionary)for(let t in e.morphTargetDictionary)i[e.morphTargetDictionary[t]]=t;for(let o=0;o<e.morphTargetInfluences.length;++o){let s={},a=!1;for(let e in l.morphAttributes){if("position"!==e&&"normal"!==e){a||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),a=!0);continue}let t=l.morphAttributes[e][o],r=e.toUpperCase(),i=l.attributes[e];if(n.attributes.has(this.getUID(t,!0))){s[r]=n.attributes.get(this.getUID(t,!0));continue}let c=t.clone();if(!l.morphTargetsRelative)for(let e=0,n=t.count;e<n;e++)for(let n=0;n<t.itemSize;n++)0===n&&c.setX(e,t.getX(e)-i.getX(e)),1===n&&c.setY(e,t.getY(e)-i.getY(e)),2===n&&c.setZ(e,t.getZ(e)-i.getZ(e)),3===n&&c.setW(e,t.getW(e)-i.getW(e));s[r]=this.processAccessor(c,l),n.attributes.set(this.getUID(i,!0),s[r])}p.push(s),t.push(e.morphTargetInfluences[o]),void 0!==e.morphTargetDictionary&&r.push(i[o])}c.weights=t,r.length>0&&(c.extras={},c.extras.targetNames=r)}let v=Array.isArray(e.material);if(v&&0===l.groups.length)return null;let y=!1;if(v&&null===l.index){let e=[];for(let t=0,n=l.attributes.position.count;t<n;t++)e[t]=t;l.setIndex(e),y=!0}let b=v?e.material:[e.material],g=v?l.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,r=g.length;e<r;e++){let r={mode:t,attributes:u};if(this.serializeUserData(l,r),p.length>0&&(r.targets=p),null!==l.index){let t=this.getUID(l.index);(void 0!==g[e].start||void 0!==g[e].count)&&(t+=":"+g[e].start+":"+g[e].count),n.attributes.has(t)?r.indices=n.attributes.get(t):(r.indices=this.processAccessor(l.index,l,g[e].start,g[e].count),n.attributes.set(t,r.indices)),null===r.indices&&delete r.indices}let i=await this.processMaterialAsync(b[g[e].materialIndex]);null!==i&&(r.material=i),h.push(r)}!0===y&&l.setIndex(null),c.primitives=h,i.meshes||(i.meshes=[]),await this._invokeAllAsync(function(t){t.writeMesh&&t.writeMesh(e,c)});let w=i.meshes.push(c)-1;return n.meshes.set(a,w),w}detectMeshQuantization(e,t){let n;if(this.extensionsUsed[s])return;switch(t.array.constructor){case Int8Array:n="byte";break;case Uint8Array:n="unsigned byte";break;case Int16Array:n="short";break;case Uint16Array:n="unsigned short";break;default:return}t.normalized&&(n+=" normalized");let r=e.split("_",1)[0];i[r]&&i[r].includes(n)&&(this.extensionsUsed[s]=!0,this.extensionsRequired[s]=!0)}processCamera(e){let t=this.json;t.cameras||(t.cameras=[]);let n=e.isOrthographicCamera,i={type:n?"orthographic":"perspective"};return n?i.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:i.perspective={aspectRatio:e.aspect,yfov:r.cj9.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(i.name=e.type),t.cameras.push(i)-1}processAnimation(e,t){let n=this.json,i=this.nodeMap;n.animations||(n.animations=[]);let s=(e=o.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,a=[],c=[];for(let e=0;e<s.length;++e){let n,o=s[e],u=r.Nwf.parseTrackName(o.name),h=r.Nwf.findNode(t,u.nodeName),p=l[u.propertyName];if("bones"===u.objectName&&(h=!0===h.isSkinnedMesh?h.skeleton.getBoneByName(u.objectIndex):void 0),!h||!p){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',o.name);continue}let f=o.values.length/o.times.length;p===l.morphTargetInfluences&&(f/=h.morphTargetInfluences.length),!0===o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(n="CUBICSPLINE",f/=3):n=o.getInterpolation()===r.ljd?"STEP":"LINEAR",c.push({input:this.processAccessor(new r.THS(o.times,1)),output:this.processAccessor(new r.THS(o.values,f)),interpolation:n}),a.push({sampler:c.length-1,target:{node:i.get(h),path:p}})}let u={name:e.name||"clip_"+n.animations.length,samplers:c,channels:a};return this.serializeUserData(e,u),n.animations.push(u),n.animations.length-1}processSkin(e){let t=this.json,n=this.nodeMap,i=t.nodes[n.get(e)],o=e.skeleton;if(void 0===o)return null;let s=e.skeleton.bones[0];if(void 0===s)return null;let a=[],l=new Float32Array(16*o.bones.length),c=new r.kn4;for(let t=0;t<o.bones.length;++t)a.push(n.get(o.bones[t])),c.copy(o.boneInverses[t]),c.multiply(e.bindMatrix).toArray(l,16*t);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new r.THS(l,16)),joints:a,skeleton:n.get(s)}),i.skin=t.skins.length-1}async processNodeAsync(e){let t=this.json,n=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);let i={};if(n.trs){let t=e.quaternion.toArray(),n=e.position.toArray(),r=e.scale.toArray();u(t,[0,0,0,1])||(i.rotation=t),u(n,[0,0,0])||(i.translation=n),u(r,[1,1,1])||(i.scale=r)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===u(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){let t=await this.processMeshAsync(e);null!==t&&(i.mesh=t)}else e.isCamera&&(i.camera=this.processCamera(e));e.isSkinnedMesh&&this.skins.push(e);let o=t.nodes.push(i)-1;if(r.set(e,o),e.children.length>0){let t=[];for(let r=0,i=e.children.length;r<i;r++){let i=e.children[r];if(i.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(i);null!==e&&t.push(e)}}t.length>0&&(i.children=t)}return await this._invokeAllAsync(function(t){t.writeNode&&t.writeNode(e,i)}),o}async processSceneAsync(e){let t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);let r={};""!==e.name&&(r.name=e.name),t.scenes.push(r);let i=[];for(let t=0,r=e.children.length;t<r;t++){let r=e.children[t];if(r.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(r);null!==e&&i.push(e)}}i.length>0&&(r.nodes=i),this.serializeUserData(e,r)}async processObjectsAsync(e){let t=new r.Z58;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);await this.processSceneAsync(t)}async processInputAsync(e){let t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync(function(t){t.beforeParse&&t.beforeParse(e)});let n=[];for(let t=0;t<e.length;t++)e[t]instanceof r.Z58?await this.processSceneAsync(e[t]):n.push(e[t]);n.length>0&&await this.processObjectsAsync(n);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);await this._invokeAllAsync(function(t){t.afterParse&&t.afterParse(e)})}async _invokeAllAsync(e){for(let t=0,n=this.plugins.length;t<n;t++)await e(this.plugins[t])}}class m{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);let n=this.writer,r=n.json,i=n.extensionsUsed,o={};e.name&&(o.name=e.name),o.color=e.color.toArray(),o.intensity=e.intensity,e.isDirectionalLight?o.type="directional":e.isPointLight?(o.type="point",e.distance>0&&(o.range=e.distance)):e.isSpotLight&&(o.type="spot",e.distance>0&&(o.range=e.distance),o.spot={},o.spot.innerConeAngle=(1-e.penumbra)*e.angle,o.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||0!==e.target.position.x||0!==e.target.position.y||-1!==e.target.position.z)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},i[this.name]=!0);let s=r.extensions[this.name].lights;s.push(o),t.extensions=t.extensions||{},t.extensions[this.name]={light:s.length-1}}}class v{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;let n=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},n[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class y{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){let t={index:await n.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};n.applyTextureTransform(t,e.clearcoatMap),i.clearcoatTexture=t}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){let t={index:await n.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};n.applyTextureTransform(t,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){let t={index:await n.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};1!==e.clearcoatNormalScale.x&&(t.scale=e.clearcoatNormalScale.x),n.applyTextureTransform(t,e.clearcoatNormalMap),i.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class b{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.dispersion)return;let n=this.writer.extensionsUsed,r={};r.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class g{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){let t={index:await n.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};n.applyTextureTransform(t,e.iridescenceMap),i.iridescenceTexture=t}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){let t={index:await n.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};n.applyTextureTransform(t,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class w{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){let t={index:await n.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};n.applyTextureTransform(t,e.transmissionMap),i.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class k{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){let t={index:await n.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};n.applyTextureTransform(t,e.thicknessMap),i.thicknessTexture=t}e.attenuationDistance!==1/0&&(i.attenuationDistance=e.attenuationDistance),i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class x{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;let n=this.writer.extensionsUsed,r={};r.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class S{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(c)&&!e.specularIntensityMap&&!e.specularColorMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.specularIntensityMap){let t={index:await n.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};n.applyTextureTransform(t,e.specularIntensityMap),i.specularTexture=t}if(e.specularColorMap){let t={index:await n.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};n.applyTextureTransform(t,e.specularColorMap),i.specularColorTexture=t}i.specularFactor=e.specularIntensity,i.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class P{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.sheenRoughnessMap){let t={index:await n.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};n.applyTextureTransform(t,e.sheenRoughnessMap),i.sheenRoughnessTexture=t}if(e.sheenColorMap){let t={index:await n.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};n.applyTextureTransform(t,e.sheenColorMap),i.sheenColorTexture=t}i.sheenRoughnessFactor=e.sheenRoughness,i.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class T{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.anisotropyMap){let t={index:await n.processTextureAsync(e.anisotropyMap)};n.applyTextureTransform(t,e.anisotropyMap),i.anisotropyTexture=t}i.anisotropyStrength=e.anisotropy,i.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class E{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;let n=this.writer.extensionsUsed,r={};r.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class R{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.bumpMap){let t={index:await n.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};n.applyTextureTransform(t,e.bumpMap),i.bumpTexture=t}i.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class O{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;let n=this.writer,i=new Float32Array(3*e.count),o=new Float32Array(4*e.count),s=new Float32Array(3*e.count),a=new r.kn4,l=new r.Pq0,c=new r.PTz,u=new r.Pq0;for(let t=0;t<e.count;t++)e.getMatrixAt(t,a),a.decompose(l,c,u),l.toArray(i,3*t),c.toArray(o,4*t),u.toArray(s,3*t);let h={TRANSLATION:n.processAccessor(new r.THS(i,3)),ROTATION:n.processAccessor(new r.THS(o,4)),SCALE:n.processAccessor(new r.THS(s,3))};e.instanceColor&&(h._COLOR_0=n.processAccessor(e.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:h},n.extensionsUsed[this.name]=!0,n.extensionsRequired[this.name]=!0}}function A(e,t){if(t===r.RJ4)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t!==r.rYR&&t!==r.O49)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e;{let n=e.getIndex();if(null===n){let t=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<r.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}let i=n.count-2,o=[];if(t===r.rYR)for(let e=1;e<=i;e++)o.push(n.getX(0)),o.push(n.getX(e)),o.push(n.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(o.push(n.getX(e)),o.push(n.getX(e+1)),o.push(n.getX(e+2))):(o.push(n.getX(e+2)),o.push(n.getX(e+1)),o.push(n.getX(e)));o.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");let s=e.clone();return s.setIndex(o),s.clearGroups(),s}}o.Utils={insertKeyframe:function(e,t){let n,r=e.getValueSize(),i=new e.TimeBufferType(e.times.length+1),o=new e.ValueBufferType(e.values.length+r),s=e.createInterpolant(new e.ValueBufferType(r));if(0===e.times.length){i[0]=t;for(let e=0;e<r;e++)o[e]=0;n=0}else if(t<e.times[0]){if(.001>Math.abs(e.times[0]-t))return 0;i[0]=t,i.set(e.times,1),o.set(s.evaluate(t),0),o.set(e.values,r),n=0}else if(t>e.times[e.times.length-1]){if(.001>Math.abs(e.times[e.times.length-1]-t))return e.times.length-1;i[i.length-1]=t,i.set(e.times,0),o.set(e.values,0),o.set(s.evaluate(t),e.values.length),n=i.length-1}else for(let a=0;a<e.times.length;a++){if(.001>Math.abs(e.times[a]-t))return a;if(e.times[a]<t&&e.times[a+1]>t){i.set(e.times.slice(0,a+1),0),i[a+1]=t,i.set(e.times.slice(a+1),a+2),o.set(e.values.slice(0,(a+1)*r),0),o.set(s.evaluate(t),(a+1)*r),o.set(e.values.slice((a+1)*r),(a+2)*r),n=a+1;break}}return e.times=i,e.values=o,n},mergeMorphTargetTracks:function(e,t){let n=[],i={},o=e.tracks;for(let e=0;e<o.length;++e){let s,a=o[e],l=r.Nwf.parseTrackName(a.name),c=r.Nwf.findNode(t,l.nodeName);if("morphTargetInfluences"!==l.propertyName||void 0===l.propertyIndex){n.push(a);continue}if(a.createInterpolant!==a.InterpolantFactoryMethodDiscrete&&a.createInterpolant!==a.InterpolantFactoryMethodLinear){if(a.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(a=a.clone()).setInterpolation(r.PJ3)}let u=c.morphTargetInfluences.length,h=c.morphTargetDictionary[l.propertyIndex];if(void 0===h)throw Error("THREE.GLTFExporter: Morph target name not found: "+l.propertyIndex);if(void 0===i[c.uuid]){let e=new(s=a.clone()).ValueBufferType(u*s.times.length);for(let t=0;t<s.times.length;t++)e[t*u+h]=s.values[t];s.name=(l.nodeName||"")+".morphTargetInfluences",s.values=e,i[c.uuid]=s,n.push(s);continue}let p=a.createInterpolant(new a.ValueBufferType(1));s=i[c.uuid];for(let e=0;e<s.times.length;e++)s.values[e*u+h]=p.evaluate(s.times[e]);for(let e=0;e<a.times.length;e++){let t=this.insertKeyframe(s,a.times[e]);s.values[t*u+h]=a.values[e]}}return e.tracks=n,e},toFloat32BufferAttribute:function(e){let t=new r.THS(new Float32Array(e.count*e.itemSize),e.itemSize,!1);if(!e.normalized&&!e.isInterleavedBufferAttribute)return t.array.set(e.array),t;for(let n=0,r=e.count;n<r;n++)for(let r=0;r<e.itemSize;r++)t.setComponent(n,r,e.getComponent(n,r));return t}};class M extends r.aHM{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new L(e)}),this.register(function(e){return new N(e)}),this.register(function(e){return new X(e)}),this.register(function(e){return new W(e)}),this.register(function(e){return new K(e)}),this.register(function(e){return new F(e)}),this.register(function(e){return new U(e)}),this.register(function(e){return new z(e)}),this.register(function(e){return new D(e)}),this.register(function(e){return new B(e)}),this.register(function(e){return new G(e)}),this.register(function(e){return new H(e)}),this.register(function(e){return new V(e)}),this.register(function(e){return new q(e)}),this.register(function(e){return new _(e)}),this.register(function(e){return new Y(e)}),this.register(function(e){return new Q(e)})}load(e,t,n,i){let o,s=this;if(""!==this.resourcePath)o=this.resourcePath;else if(""!==this.path){let t=r.r6x.extractUrlBase(e);o=r.r6x.resolveURL(t,this.path)}else o=r.r6x.extractUrlBase(e);this.manager.itemStart(e);let a=function(t){i?i(t):console.error(t),s.manager.itemError(e),s.manager.itemEnd(e)},l=new r.Y9S(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(n){try{s.parse(n,o,function(n){t(n),s.manager.itemEnd(e)},a)}catch(e){a(e)}},n,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){let i,o={},s={},a=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===Z){try{o[I.KHR_BINARY_GLTF]=new J(e)}catch(e){r&&r(e);return}i=JSON.parse(o[I.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e));else i=e;if(void 0===i.asset||i.asset.version[0]<2){r&&r(Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}let l=new eb(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){let t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),s[t.name]=t,o[t.name]=!0}if(i.extensionsUsed)for(let e=0;e<i.extensionsUsed.length;++e){let t=i.extensionsUsed[e],n=i.extensionsRequired||[];switch(t){case I.KHR_MATERIALS_UNLIT:o[t]=new j;break;case I.KHR_DRACO_MESH_COMPRESSION:o[t]=new $(i,this.dracoLoader);break;case I.KHR_TEXTURE_TRANSFORM:o[t]=new ee;break;case I.KHR_MESH_QUANTIZATION:o[t]=new et;break;default:n.indexOf(t)>=0&&void 0===s[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(o),l.setPlugins(s),l.parse(n,r)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,t,r,i)})}}function C(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}let I={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class _{constructor(e){this.parser=e,this.name=I.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){let e=this.parser,t=this.parser.json.nodes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){let t,n=this.parser,i="light:"+e,o=n.cache.get(i);if(o)return o;let s=n.json,a=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e],l=new r.Q1f(0xffffff);void 0!==a.color&&l.setRGB(a.color[0],a.color[1],a.color[2],r.Zr2);let c=void 0!==a.range?a.range:0;switch(a.type){case"directional":(t=new r.ZyN(l)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new r.HiM(l)).distance=c;break;case"spot":(t=new r.nCl(l)).distance=c,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,t.angle=a.spot.outerConeAngle,t.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return t.position.set(0,0,0),ed(t,a),void 0!==a.intensity&&(t.intensity=a.intensity),t.name=n.createUniqueName(a.name||"light_"+e),o=Promise.resolve(t),n.cache.add(i,o),o}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){let t=this,n=this.parser,r=n.json.nodes[e],i=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then(function(e){return n._getNodeRef(t.cache,i,e)})}}class j{constructor(){this.name=I.KHR_MATERIALS_UNLIT}getMaterialType(){return r.V9B}extendParams(e,t,n){let i=[];e.color=new r.Q1f(1,1,1),e.opacity=1;let o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){let t=o.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],r.Zr2),e.opacity=t[3]}void 0!==o.baseColorTexture&&i.push(n.assignTexture(e,"map",o.baseColorTexture,r.er$))}return Promise.all(i)}}class B{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class L{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];if(void 0!==s.clearcoatFactor&&(t.clearcoat=s.clearcoatFactor),void 0!==s.clearcoatTexture&&o.push(n.assignTexture(t,"clearcoatMap",s.clearcoatTexture)),void 0!==s.clearcoatRoughnessFactor&&(t.clearcoatRoughness=s.clearcoatRoughnessFactor),void 0!==s.clearcoatRoughnessTexture&&o.push(n.assignTexture(t,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),void 0!==s.clearcoatNormalTexture&&(o.push(n.assignTexture(t,"clearcoatNormalMap",s.clearcoatNormalTexture)),void 0!==s.clearcoatNormalTexture.scale)){let e=s.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new r.I9Y(e,e)}return Promise.all(o)}}class N{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_DISPERSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.dispersion=void 0!==r.dispersion?r.dispersion:0,Promise.resolve()}}class H{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&i.push(n.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&i.push(n.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(i)}}class F{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SHEEN}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[];t.sheenColor=new r.Q1f(0,0,0),t.sheenRoughness=0,t.sheen=1;let s=i.extensions[this.name];if(void 0!==s.sheenColorFactor){let e=s.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==s.sheenRoughnessFactor&&(t.sheenRoughness=s.sheenRoughnessFactor),void 0!==s.sheenColorTexture&&o.push(n.assignTexture(t,"sheenColorMap",s.sheenColorTexture,r.er$)),void 0!==s.sheenRoughnessTexture&&o.push(n.assignTexture(t,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(o)}}class U{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&i.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(i)}}class z{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_VOLUME}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];t.thickness=void 0!==s.thicknessFactor?s.thicknessFactor:0,void 0!==s.thicknessTexture&&o.push(n.assignTexture(t,"thicknessMap",s.thicknessTexture)),t.attenuationDistance=s.attenuationDistance||1/0;let a=s.attenuationColor||[1,1,1];return t.attenuationColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),Promise.all(o)}}class D{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IOR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class G{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SPECULAR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];t.specularIntensity=void 0!==s.specularFactor?s.specularFactor:1,void 0!==s.specularTexture&&o.push(n.assignTexture(t,"specularIntensityMap",s.specularTexture));let a=s.specularColorFactor||[1,1,1];return t.specularColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),void 0!==s.specularColorTexture&&o.push(n.assignTexture(t,"specularColorMap",s.specularColorTexture,r.er$)),Promise.all(o)}}class q{constructor(e){this.parser=e,this.name=I.EXT_MATERIALS_BUMP}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return t.bumpScale=void 0!==o.bumpFactor?o.bumpFactor:1,void 0!==o.bumpTexture&&i.push(n.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(i)}}class V{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&i.push(n.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(i)}}class X{constructor(e){this.parser=e,this.name=I.KHR_TEXTURE_BASISU}loadTexture(e){let t=this.parser,n=t.json,r=n.textures[e];if(!r.extensions||!r.extensions[this.name])return null;let i=r.extensions[this.name],o=t.options.ktx2Loader;if(!o)if(!(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return t.loadTextureImage(e,i.source,o)}}class W{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_WEBP}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let o=i.extensions[t],s=r.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class K{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_AVIF}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let o=i.extensions[t],s=r.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class Y{constructor(e){this.name=I.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){let t=this.parser.json,n=t.bufferViews[e];if(!n.extensions||!n.extensions[this.name])return null;{let e=n.extensions[this.name],r=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported)if(!(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return r.then(function(t){let n=e.byteOffset||0,r=e.byteLength||0,o=e.count,s=e.byteStride,a=new Uint8Array(t,n,r);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(o,s,a,e.mode,e.filter).then(function(e){return e.buffer}):i.ready.then(function(){let t=new ArrayBuffer(o*s);return i.decodeGltfBuffer(new Uint8Array(t),o,s,a,e.mode,e.filter),t})})}}}class Q{constructor(e){this.name=I.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){let t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;for(let e of t.meshes[n.mesh].primitives)if(e.mode!==eo.TRIANGLES&&e.mode!==eo.TRIANGLE_STRIP&&e.mode!==eo.TRIANGLE_FAN&&void 0!==e.mode)return null;let i=n.extensions[this.name].attributes,o=[],s={};for(let e in i)o.push(this.parser.getDependency("accessor",i[e]).then(t=>(s[e]=t,s[e])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(e=>{let t=e.pop(),n=t.isGroup?t.children:[t],i=e[0].count,o=[];for(let e of n){let t=new r.kn4,n=new r.Pq0,a=new r.PTz,l=new r.Pq0(1,1,1),c=new r.ZLX(e.geometry,e.material,i);for(let e=0;e<i;e++)s.TRANSLATION&&n.fromBufferAttribute(s.TRANSLATION,e),s.ROTATION&&a.fromBufferAttribute(s.ROTATION,e),s.SCALE&&l.fromBufferAttribute(s.SCALE,e),c.setMatrixAt(e,t.compose(n,a,l));for(let t in s)if("_COLOR_0"===t){let e=s[t];c.instanceColor=new r.uWO(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,s[t]);r.B69.prototype.copy.call(c,e),this.parser.assignFinalMaterial(c),o.push(c)}return t.isGroup?(t.clear(),t.add(...o),t):o[0]}))}}let Z="glTF";class J{constructor(e){this.name=I.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Z)throw Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw Error("THREE.GLTFLoader: Legacy binary file detected.");const r=this.header.length-12,i=new DataView(e,12);let o=0;for(;o<r;){const t=i.getUint32(o,!0);o+=4;const r=i.getUint32(o,!0);if(o+=4,0x4e4f534a===r){const r=new Uint8Array(e,12+o,t);this.content=n.decode(r)}else if(5130562===r){const n=12+o;this.body=e.slice(n,n+t)}o+=t}if(null===this.content)throw Error("THREE.GLTFLoader: JSON content not found.")}}class ${constructor(e,t){if(!t)throw Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=I.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){let n=this.json,i=this.dracoLoader,o=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,a={},l={},c={};for(let e in s)a[eu[e]||e.toLowerCase()]=s[e];for(let t in e.attributes){let r=eu[t]||t.toLowerCase();if(void 0!==s[t]){let i=n.accessors[e.attributes[t]],o=es[i.componentType];c[r]=o.name,l[r]=!0===i.normalized}}return t.getDependency("bufferView",o).then(function(e){return new Promise(function(t,n){i.decodeDracoFile(e,function(e){for(let t in e.attributes){let n=e.attributes[t],r=l[t];void 0!==r&&(n.normalized=r)}t(e)},a,c,r.Zr2,n)})})}}class ee{constructor(){this.name=I.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(void 0===t.texCoord||t.texCoord===e.channel)&&void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class et{constructor(){this.name=I.KHR_MESH_QUANTIZATION}}class en extends r.lGw{constructor(e,t,n,r){super(e,t,n,r)}copySampleValue_(e){let t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=e*r*3+r;for(let e=0;e!==r;e++)t[e]=n[i+e];return t}interpolate_(e,t,n,r){let i=this.resultBuffer,o=this.sampleValues,s=this.valueSize,a=2*s,l=3*s,c=r-t,u=(n-t)/c,h=u*u,p=h*u,f=e*l,d=f-l,m=-2*p+3*h,v=p-h,y=1-m,b=v-h+u;for(let e=0;e!==s;e++){let t=o[d+e+s],n=o[d+e+a]*c,r=o[f+e+s],l=o[f+e]*c;i[e]=y*t+b*n+m*r+v*l}return i}}let er=new r.PTz;class ei extends en{interpolate_(e,t,n,r){let i=super.interpolate_(e,t,n,r);return er.fromArray(i).normalize().toArray(i),i}}let eo={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},es={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ea={9728:r.hxR,9729:r.k6q,9984:r.pHI,9985:r.kRr,9986:r.Cfg,9987:r.$_I},el={33071:r.ghU,33648:r.kTW,10497:r.GJx},ec={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},eu={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},eh={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ep={CUBICSPLINE:void 0,LINEAR:r.PJ3,STEP:r.ljd};function ef(e,t,n){for(let r in n.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=n.extensions[r])}function ed(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function em(e){let t="",n=Object.keys(e).sort();for(let r=0,i=n.length;r<i;r++)t+=n[r]+":"+e[n[r]]+";";return t}function ev(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}let ey=new r.kn4;class eb{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new C,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,i=-1,o=!1,s=-1;if("u">typeof navigator){const e=navigator.userAgent;n=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);i=n&&t?parseInt(t[1],10):-1,s=(o=e.indexOf("Firefox")>-1)?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"u"<typeof createImageBitmap||n&&i<17||o&&s<98?this.textureLoader=new r.Tap(this.options.manager):this.textureLoader=new r.Kzg(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new r.Y9S(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){let n=this,r=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(t){let o={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:n,userData:{}};return ef(i,o,r),ed(o,r),Promise.all(n._invokeAll(function(e){return e.afterRoot&&e.afterRoot(o)})).then(function(){for(let e of o.scenes)e.updateMatrixWorld();e(o)})}).catch(t)}_markDefs(){let e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n].joints;for(let t=0,n=r.length;t<n;t++)e[r[t]].isBone=!0}for(let t=0,r=e.length;t<r;t++){let r=e[t];void 0!==r.mesh&&(this._addNodeRef(this.meshCache,r.mesh),void 0!==r.skin&&(n[r.mesh].isSkinnedMesh=!0)),void 0!==r.camera&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;let r=n.clone(),i=(e,t)=>{let n=this.associations.get(e);for(let[r,o]of(null!=n&&this.associations.set(t,n),e.children.entries()))i(o,t.children[r])};return i(n,r),r.name+="_instance_"+e.uses[t]++,r}_invokeOne(e){let t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){let r=e(t[n]);if(r)return r}return null}_invokeAll(e){let t=Object.values(this.plugins);t.unshift(this);let n=[];for(let r=0;r<t.length;r++){let i=e(t[r]);i&&n.push(i)}return n}getDependency(e,t){let n=e+":"+t,r=this.cache.get(n);if(!r){switch(e){case"scene":r=this.loadScene(t);break;case"node":r=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":r=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":r=this.loadAccessor(t);break;case"bufferView":r=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":r=this.loadBuffer(t);break;case"material":r=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":r=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":r=this.loadSkin(t);break;case"animation":r=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":r=this.loadCamera(t);break;default:if(!(r=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})))throw Error("Unknown type: "+e)}this.cache.add(n,r)}return r}getDependencies(e){let t=this.cache.get(e);if(!t){let n=this;t=Promise.all((this.json[e+("mesh"===e?"es":"s")]||[]).map(function(t,r){return n.getDependency(e,r)})),this.cache.add(e,t)}return t}loadBuffer(e){let t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[I.KHR_BINARY_GLTF].body);let i=this.options;return new Promise(function(e,o){n.load(r.r6x.resolveURL(t.uri,i.path),e,void 0,function(){o(Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){let t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){let n=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+n)})}loadAccessor(e){let t=this,n=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){let e=ec[i.type],t=es[i.componentType],n=!0===i.normalized,o=new t(i.count*e);return Promise.resolve(new r.THS(o,e,n))}let o=[];return void 0!==i.bufferView?o.push(this.getDependency("bufferView",i.bufferView)):o.push(null),void 0!==i.sparse&&(o.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(o).then(function(e){let o,s,a=e[0],l=ec[i.type],c=es[i.componentType],u=c.BYTES_PER_ELEMENT,h=u*l,p=i.byteOffset||0,f=void 0!==i.bufferView?n.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;if(f&&f!==h){let e=Math.floor(p/f),n="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count,h=t.cache.get(n);h||(o=new c(a,e*f,i.count*f/u),h=new r.eB$(o,f/u),t.cache.add(n,h)),s=new r.eHs(h,l,p%f/u,d)}else o=null===a?new c(i.count*l):new c(a,p,i.count*l),s=new r.THS(o,l,d);if(void 0!==i.sparse){let t=ec.SCALAR,n=es[i.sparse.indices.componentType],o=i.sparse.indices.byteOffset||0,u=i.sparse.values.byteOffset||0,h=new n(e[1],o,i.sparse.count*t),p=new c(e[2],u,i.sparse.count*l);null!==a&&(s=new r.THS(s.array.slice(),s.itemSize,s.normalized)),s.normalized=!1;for(let e=0,t=h.length;e<t;e++){let t=h[e];if(s.setX(t,p[e*l]),l>=2&&s.setY(t,p[e*l+1]),l>=3&&s.setZ(t,p[e*l+2]),l>=4&&s.setW(t,p[e*l+3]),l>=5)throw Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}s.normalized=d}return s})}loadTexture(e){let t=this.json,n=this.options,r=t.textures[e].source,i=t.images[r],o=this.textureLoader;if(i.uri){let e=n.manager.getHandler(i.uri);null!==e&&(o=e)}return this.loadTextureImage(e,r,o)}loadTextureImage(e,t,n){let i=this,o=this.json,s=o.textures[e],a=o.images[t],l=(a.uri||a.bufferView)+":"+s.sampler;if(this.textureCache[l])return this.textureCache[l];let c=this.loadImageSource(t,n).then(function(t){t.flipY=!1,t.name=s.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);let n=(o.samplers||{})[s.sampler]||{};return t.magFilter=ea[n.magFilter]||r.k6q,t.minFilter=ea[n.minFilter]||r.$_I,t.wrapS=el[n.wrapS]||r.GJx,t.wrapT=el[n.wrapT]||r.GJx,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==r.hxR&&t.minFilter!==r.k6q,i.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[l]=c,c}loadImageSource(e,t){let n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());let o=n.images[e],s=self.URL||self.webkitURL,a=o.uri||"",l=!1;if(void 0!==o.bufferView)a=this.getDependency("bufferView",o.bufferView).then(function(e){l=!0;let t=new Blob([e],{type:o.mimeType});return a=s.createObjectURL(t)});else if(void 0===o.uri)throw Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");let c=Promise.resolve(a).then(function(e){return new Promise(function(n,o){let s=n;!0===t.isImageBitmapLoader&&(s=function(e){let t=new r.gPd(e);t.needsUpdate=!0,n(t)}),t.load(r.r6x.resolveURL(e,i.path),s,void 0,o)})}).then(function(e){var t;return!0===l&&s.revokeObjectURL(a),ed(e,o),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e});return this.sourceCache[e]=c,c}assignTexture(e,t,n,r){let i=this;return this.getDependency("texture",n.index).then(function(o){if(!o)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((o=o.clone()).channel=n.texCoord),i.extensions[I.KHR_TEXTURE_TRANSFORM]){let e=void 0!==n.extensions?n.extensions[I.KHR_TEXTURE_TRANSFORM]:void 0;if(e){let t=i.associations.get(o);o=i.extensions[I.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),i.associations.set(o,t)}}return void 0!==r&&(o.colorSpace=r),e[t]=o,o})}assignFinalMaterial(e){let t=e.geometry,n=e.material,i=void 0===t.attributes.tangent,o=void 0!==t.attributes.color,s=void 0===t.attributes.normal;if(e.isPoints){let e="PointsMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.BH$,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){let e="LineBasicMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.mrM,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(i||o||s){let e="ClonedMaterial:"+n.uuid+":";i&&(e+="derivative-tangents:"),o&&(e+="vertex-colors:"),s&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),o&&(t.vertexColors=!0),s&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return r._4j}loadMaterial(e){let t,n=this,i=this.json,o=this.extensions,s=i.materials[e],a={},l=s.extensions||{},c=[];if(l[I.KHR_MATERIALS_UNLIT]){let e=o[I.KHR_MATERIALS_UNLIT];t=e.getMaterialType(),c.push(e.extendParams(a,s,n))}else{let i=s.pbrMetallicRoughness||{};if(a.color=new r.Q1f(1,1,1),a.opacity=1,Array.isArray(i.baseColorFactor)){let e=i.baseColorFactor;a.color.setRGB(e[0],e[1],e[2],r.Zr2),a.opacity=e[3]}void 0!==i.baseColorTexture&&c.push(n.assignTexture(a,"map",i.baseColorTexture,r.er$)),a.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,a.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(c.push(n.assignTexture(a,"metalnessMap",i.metallicRoughnessTexture)),c.push(n.assignTexture(a,"roughnessMap",i.metallicRoughnessTexture))),t=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)})))}!0===s.doubleSided&&(a.side=r.$EB);let u=s.alphaMode||"OPAQUE";if("BLEND"===u?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,"MASK"===u&&(a.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"normalMap",s.normalTexture)),a.normalScale=new r.I9Y(1,1),void 0!==s.normalTexture.scale)){let e=s.normalTexture.scale;a.normalScale.set(e,e)}if(void 0!==s.occlusionTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(a.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&t!==r.V9B){let e=s.emissiveFactor;a.emissive=new r.Q1f().setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==s.emissiveTexture&&t!==r.V9B&&c.push(n.assignTexture(a,"emissiveMap",s.emissiveTexture,r.er$)),Promise.all(c).then(function(){let r=new t(a);return s.name&&(r.name=s.name),ed(r,s),n.associations.set(r,{materials:e}),s.extensions&&ef(o,r,s),r})}createUniqueName(e){let t=r.Nwf.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){let t=this,n=this.extensions,i=this.primitiveCache,o=[];for(let s=0,a=e.length;s<a;s++){let a=e[s],l=function(e){let t,n=e.extensions&&e.extensions[I.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+em(n.attributes):e.indices+":"+em(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,r=e.targets.length;n<r;n++)t+=":"+em(e.targets[n]);return t}(a),c=i[l];if(c)o.push(c.promise);else{let e;e=a.extensions&&a.extensions[I.KHR_DRACO_MESH_COMPRESSION]?function(e){return n[I.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(n){return eg(n,e,t)})}(a):eg(new r.LoY,a,t),i[l]={primitive:a,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){let t=this,n=this.json,i=this.extensions,o=n.meshes[e],s=o.primitives,a=[];for(let e=0,t=s.length;e<t;e++){var l;let t=void 0===s[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new r._4j({color:0xffffff,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:r.hB5})),l.DefaultMaterial):this.getDependency("material",s[e].material);a.push(t)}return a.push(t.loadGeometries(s)),Promise.all(a).then(function(n){let a=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let n=0,u=l.length;n<u;n++){let u,h=l[n],p=s[n],f=a[n];if(p.mode===eo.TRIANGLES||p.mode===eo.TRIANGLE_STRIP||p.mode===eo.TRIANGLE_FAN||void 0===p.mode)!0===(u=!0===o.isSkinnedMesh?new r.I46(h,f):new r.eaF(h,f)).isSkinnedMesh&&u.normalizeSkinWeights(),p.mode===eo.TRIANGLE_STRIP?u.geometry=A(u.geometry,r.O49):p.mode===eo.TRIANGLE_FAN&&(u.geometry=A(u.geometry,r.rYR));else if(p.mode===eo.LINES)u=new r.DXC(h,f);else if(p.mode===eo.LINE_STRIP)u=new r.N1A(h,f);else if(p.mode===eo.LINE_LOOP)u=new r.FCc(h,f);else if(p.mode===eo.POINTS)u=new r.ONl(h,f);else throw Error("THREE.GLTFLoader: Primitive mode unsupported: "+p.mode);Object.keys(u.geometry.morphAttributes).length>0&&function(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,r=t.weights.length;n<r;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){let n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,r=n.length;t<r;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}(u,o),u.name=t.createUniqueName(o.name||"mesh_"+e),ed(u,o),p.extensions&&ef(i,u,p),t.assignFinalMaterial(u),c.push(u)}for(let n=0,r=c.length;n<r;n++)t.associations.set(c[n],{meshes:e,primitives:n});if(1===c.length)return o.extensions&&ef(i,c[0],o),c[0];let u=new r.YJl;o.extensions&&ef(i,u,o),t.associations.set(u,{meshes:e});for(let e=0,t=c.length;e<t;e++)u.add(c[e]);return u})}loadCamera(e){let t,n=this.json.cameras[e],i=n[n.type];return i?("perspective"===n.type?t=new r.ubm(r.cj9.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===n.type&&(t=new r.qUd(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),ed(t,n),Promise.resolve(t)):void console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){let t=this.json.skins[e],n=[];for(let e=0,r=t.joints.length;e<r;e++)n.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then(function(e){let n=e.pop(),i=[],o=[];for(let s=0,a=e.length;s<a;s++){let a=e[s];if(a){i.push(a);let e=new r.kn4;null!==n&&e.fromArray(n.array,16*s),o.push(e)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[s])}return new r.EAD(i,o)})}loadAnimation(e){let t=this.json,n=this,i=t.animations[e],o=i.name?i.name:"animation_"+e,s=[],a=[],l=[],c=[],u=[];for(let e=0,t=i.channels.length;e<t;e++){let t=i.channels[e],n=i.samplers[t.sampler],r=t.target,o=r.node,h=void 0!==i.parameters?i.parameters[n.input]:n.input,p=void 0!==i.parameters?i.parameters[n.output]:n.output;void 0!==r.node&&(s.push(this.getDependency("node",o)),a.push(this.getDependency("accessor",h)),l.push(this.getDependency("accessor",p)),c.push(n),u.push(r))}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(u)]).then(function(e){let t=e[0],s=e[1],a=e[2],l=e[3],c=e[4],u=[];for(let e=0,r=t.length;e<r;e++){let r=t[e],i=s[e],o=a[e],h=l[e],p=c[e];if(void 0===r)continue;r.updateMatrix&&r.updateMatrix();let f=n._createAnimationTracks(r,i,o,h,p);if(f)for(let e=0;e<f.length;e++)u.push(f[e])}let h=new r.tz3(o,void 0,u);return ed(h,i),h})}createNodeMesh(e){let t=this.json,n=this,r=t.nodes[e];return void 0===r.mesh?null:n.getDependency("mesh",r.mesh).then(function(e){let t=n._getNodeRef(n.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,n=r.weights.length;t<n;t++)e.morphTargetInfluences[t]=r.weights[t]}),t})}loadNode(e){let t=this.json.nodes[e],n=this._loadNodeShallow(e),r=[],i=t.children||[];for(let e=0,t=i.length;e<t;e++)r.push(this.getDependency("node",i[e]));let o=void 0===t.skin?Promise.resolve(null):this.getDependency("skin",t.skin);return Promise.all([n,Promise.all(r),o]).then(function(e){let t=e[0],n=e[1],r=e[2];null!==r&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(r,ey)});for(let e=0,r=n.length;e<r;e++)t.add(n[e]);return t})}_loadNodeShallow(e){let t=this.json,n=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];let o=t.nodes[e],s=o.name?i.createUniqueName(o.name):"",a=[],l=i._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return l&&a.push(l),void 0!==o.camera&&a.push(i.getDependency("camera",o.camera).then(function(e){return i._getNodeRef(i.cameraCache,o.camera,e)})),i._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){a.push(e)}),this.nodeCache[e]=Promise.all(a).then(function(t){let a;if((a=!0===o.isBone?new r.$Kf:t.length>1?new r.YJl:1===t.length?t[0]:new r.B69)!==t[0])for(let e=0,n=t.length;e<n;e++)a.add(t[e]);if(o.name&&(a.userData.name=o.name,a.name=s),ed(a,o),o.extensions&&ef(n,a,o),void 0!==o.matrix){let e=new r.kn4;e.fromArray(o.matrix),a.applyMatrix4(e)}else void 0!==o.translation&&a.position.fromArray(o.translation),void 0!==o.rotation&&a.quaternion.fromArray(o.rotation),void 0!==o.scale&&a.scale.fromArray(o.scale);if(i.associations.has(a)){if(void 0!==o.mesh&&i.meshCache.refs[o.mesh]>1){let e=i.associations.get(a);i.associations.set(a,{...e})}}else i.associations.set(a,{});return i.associations.get(a).nodes=e,a}),this.nodeCache[e]}loadScene(e){let t=this.extensions,n=this.json.scenes[e],i=this,o=new r.YJl;n.name&&(o.name=i.createUniqueName(n.name)),ed(o,n),n.extensions&&ef(t,o,n);let s=n.nodes||[],a=[];for(let e=0,t=s.length;e<t;e++)a.push(i.getDependency("node",s[e]));return Promise.all(a).then(function(e){for(let t=0,n=e.length;t<n;t++)o.add(e[t]);return i.associations=(e=>{let t=new Map;for(let[e,n]of i.associations)(e instanceof r.imn||e instanceof r.gPd)&&t.set(e,n);return e.traverse(e=>{let n=i.associations.get(e);null!=n&&t.set(e,n)}),t})(o),o})}_createAnimationTracks(e,t,n,i,o){let s,a=[],l=e.name?e.name:e.uuid,c=[];switch(eh[o.path]===eh.weights?e.traverse(function(e){e.morphTargetInfluences&&c.push(e.name?e.name:e.uuid)}):c.push(l),eh[o.path]){case eh.weights:s=r.Hit;break;case eh.rotation:s=r.MBL;break;case eh.translation:case eh.scale:s=r.RiT;break;default:s=1===n.itemSize?r.Hit:r.RiT}let u=void 0!==i.interpolation?ep[i.interpolation]:r.PJ3,h=this._getArrayFromAccessor(n);for(let e=0,n=c.length;e<n;e++){let n=new s(c[e]+"."+eh[o.path],t.array,h,u);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(n),a.push(n)}return a}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){let e=ev(t.constructor),n=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)n[r]=t[r]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof r.MBL?ei:en)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function eg(e,t,n){let i=t.attributes,o=[];for(let t in i){let r=eu[t]||t.toLowerCase();r in e.attributes||o.push(function(t,r){return n.getDependency("accessor",t).then(function(t){e.setAttribute(r,t)})}(i[t],r))}if(void 0!==t.indices&&!e.index){let r=n.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});o.push(r)}return r.ppV.workingColorSpace!==r.Zr2&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${r.ppV.workingColorSpace}" not supported.`),ed(e,t),!function(e,t,n){let i=t.attributes,o=new r.NRn;if(void 0===i.POSITION)return;{let e=n.json.accessors[i.POSITION],t=e.min,s=e.max;if(void 0===t||void 0===s)return console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(o.set(new r.Pq0(t[0],t[1],t[2]),new r.Pq0(s[0],s[1],s[2])),e.normalized){let t=ev(es[e.componentType]);o.min.multiplyScalar(t),o.max.multiplyScalar(t)}}let s=t.targets;if(void 0!==s){let e=new r.Pq0,t=new r.Pq0;for(let r=0,i=s.length;r<i;r++){let i=s[r];if(void 0!==i.POSITION){let r=n.json.accessors[i.POSITION],o=r.min,s=r.max;if(void 0!==o&&void 0!==s){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(s[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(s[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(s[2]))),r.normalized){let e=ev(es[r.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}o.expandByVector(e)}e.boundingBox=o;let a=new r.iyt;o.getCenter(a.center),a.radius=o.min.distanceTo(o.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(o).then(function(){return void 0!==t.targets?function(e,t,n){let r=!1,i=!1,o=!1;for(let e=0,n=t.length;e<n;e++){let n=t[e];if(void 0!==n.POSITION&&(r=!0),void 0!==n.NORMAL&&(i=!0),void 0!==n.COLOR_0&&(o=!0),r&&i&&o)break}if(!r&&!i&&!o)return Promise.resolve(e);let s=[],a=[],l=[];for(let c=0,u=t.length;c<u;c++){let u=t[c];if(r){let t=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;s.push(t)}if(i){let t=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(o){let t=void 0!==u.COLOR_0?n.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l)]).then(function(t){let n=t[0],s=t[1],a=t[2];return r&&(e.morphAttributes.position=n),i&&(e.morphAttributes.normal=s),o&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e})}(e,t.targets,n):e})}var ew=n("./src/model/physics/constants.ts"),ek=console.error;function ex(e){new o().parse(e,function(e){var t,n,r;console.log(e),t=e,n="scene.gltf",(r=document.createElement("a")).setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),r.setAttribute("download",n),document.body.appendChild(r),r.click(),r.remove()},ek)}function eS(e,t){new M().load(e,function(n){n.scene.scale.set(ew.R/.5,ew.R/.5,ew.R/.5),n.scene.matrixAutoUpdate=!1,n.scene.updateMatrix(),n.scene.updateMatrixWorld(),n.scene.name=e,t(n)},function(t){return console.log(e+" "+t.loaded+" bytes loaded")},ek)}},"./src/utils/rack.ts"(e,t,n){n.d(t,{m:()=>c});var r=n("./src/model/ball.ts"),i=n("./src/view/tablegeometry.ts"),o=n("./node_modules/three/build/three.core.js"),s=n("./src/utils/utils.ts"),a=n("./src/model/physics/constants.ts");function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"jitter",value:function(e){return(0,s.ld)(e.clone().add(new o.Pq0(t.noise*(Math.random()-.5),t.noise*(Math.random()-.5),0)))}},{key:"cueBall",value:function(e,n){return new r.c(t.jitter(e),0xfaebd7,!1,n)}},{key:"diamond",value:function(){var e=new o.Pq0(i.P.tableX/2,0,0),n=[];return n.push(t.cueBall(t.spot)),n.push(new r.c(t.jitter(e),0xe0de36)),e.add(t.diagonal),n.push(new r.c(t.jitter(e),0xff9d00)),e.sub(t.across),n.push(new r.c(t.jitter(e),5380369)),e.add(t.diagonal),n.push(new r.c(t.jitter(e),5853696)),e.sub(t.across),n.push(new r.c(t.jitter(e),0xff0000)),e.addScaledVector(t.across,2),n.push(new r.c(t.jitter(e),328965)),e.add(t.diagonal).sub(t.across),n.push(new r.c(t.jitter(e),685250)),e.sub(t.across),n.push(new r.c(t.jitter(e),553728)),e.add(t.diagonal),n.push(new r.c(t.jitter(e),4063388)),n}},{key:"triangle",value:function(){var e=t.trianglePositions(),n=t.cueBall(t.spot),i=e.map(function(e){return new r.c(t.jitter(e))});return i.unshift(n),i.slice(0,5)}},{key:"fullTriangle",value:function(){var e=t.trianglePositions(),n=t.cueBall(t.spot),i=e.map(function(e){return new r.c(t.jitter(e))});return i.unshift(n),i}},{key:"eightBall",value:function(){var e=t.trianglePositions(),n=[];n.push(t.cueBall(t.spot,0));for(var i={1:0xffcc00,2:0xe0de36,3:5380369,4:5853696,5:0xff0000,6:553728,7:0xee7700,8:328965,9:0xff9d00,10:4063388,11:685250,12:0xbd723a,13:0xeede36,14:824932,15:0xffaacc},o=[],s=1;s<=15;s++)8!==s&&o.push(s);for(var a=o.length-1;a>0;a--){var l,c=Math.floor(Math.random()*(a+1));l=[o[c],o[a]],o[a]=l[0],o[c]=l[1]}for(var u=[],h=0,p=0;p<e.length;p++)3===p?u[p]=8:u[p]=o[h++];for(var f=0;f<u.length;f++){var d=u[f],m=i[d],v=d>8;n.push(new r.c(t.jitter(e[f]),m,v,d))}return n}},{key:"trianglePositions",value:function(){var e=[],t=new o.Pq0(i.P.X/2,0,0);return e.push((0,s.t6)(t)),t.add(this.diagonal),e.push((0,s.t6)(t)),t.sub(this.across),e.push((0,s.t6)(t)),t.add(this.diagonal),e.push((0,s.t6)(t)),t.sub(this.across),e.push((0,s.t6)(t)),t.addScaledVector(this.across,2),e.push((0,s.t6)(t)),t.add(this.diagonal),e.push((0,s.t6)(t)),t.sub(this.across),e.push((0,s.t6)(t)),t.sub(this.across),e.push((0,s.t6)(t)),t.sub(this.across),e.push((0,s.t6)(t)),t.add(this.diagonal).sub(this.across),e.push((0,s.t6)(t)),t.add(this.across),e.push((0,s.t6)(t)),t.add(this.across),e.push((0,s.t6)(t)),t.add(this.across),e.push((0,s.t6)(t)),t.add(this.across),e.push((0,s.t6)(t)),e}},{key:"rerack",value:function(e,n){var i=t.trianglePositions(),o=i.shift();n.balls.filter(function(e){return e!==n.cueball}).filter(function(t){return t!==e}).forEach(function(e){e.pos.copy(t.jitter(i.shift())),e.state=r.U.Stationary}),n.overlapsAny(e.pos,e)&&e.pos.copy(o),n.overlapsAny(n.cueball.pos)&&n.cueball.pos.copy(t.spot)}},{key:"three",value:function(){var e=[],n=i.P.X/2,s=i.P.Y/4;return e.push(t.cueBall(t.jitter(new o.Pq0(-n,-s,0)))),e.push(new r.c(t.jitter(new o.Pq0(-n,0,0)),0xe0de36)),e.push(new r.c(t.jitter(new o.Pq0(n,0,0)),0xff0000)),e}},{key:"snooker",value:function(){var e=[],n=i.P.Y/4;e.push(t.cueBall(t.jitter(new o.Pq0(t.baulk,-(.5*n),0))));var s=t.snookerColourPositions();return e.push(new r.c(t.jitter(s[0]),0xeede36)),e.push(new r.c(t.jitter(s[1]),824932)),e.push(new r.c(t.jitter(s[2]),0xbd723a)),e.push(new r.c(t.jitter(s[3]),558062)),e.push(new r.c(t.jitter(s[4]),0xffaacc)),e.push(new r.c(t.jitter(s[5]),65793)),t.trianglePositions().slice(0,15).forEach(function(n){e.push(new r.c(t.jitter(n.add(t.down)),0xee0000))}),e}},{key:"snookerColourPositions",value:function(){var e=i.P.X/2,n=i.P.X-2*i.P.X/11,r=[];return r.push(new o.Pq0(t.baulk,-t.sixth,0)),r.push(new o.Pq0(t.baulk,t.sixth,0)),r.push(new o.Pq0(t.baulk,0,0)),r.push(new o.Pq0(0,0,0)),r.push(new o.Pq0(e,0,0)),r.push(new o.Pq0(n,0,0)),r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();l(c,"noise",.0233*a.R),l(c,"gap",2*a.R+2*c.noise),l(c,"up",new o.Pq0(0,0,-1)),l(c,"spot",new o.Pq0(-i.P.X/2,0,0)),l(c,"across",new o.Pq0(0,c.gap,0)),l(c,"down",new o.Pq0(c.gap,0,0)),l(c,"diagonal",c.across.clone().applyAxisAngle(c.up,Math.PI/3)),l(c,"sixth",2*i.P.Y/6),l(c,"baulk",-1.5*i.P.X*2/5)},"./src/utils/respot.ts"(e,t,n){n.d(t,{k:()=>a});var r=n("./src/model/ball.ts"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts"),s=n("./src/utils/rack.ts"),a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"respot",value:function(e,n){var i=s.m.snookerColourPositions();return i.push(i[e.id-1]),i.reverse(),i.some(function(t){return!n.overlapsAny(t,e)&&(e.pos.copy(t),e.state=r.U.Stationary,!0)})||t.respotBehind(i[0],e,n),e}},{key:"respotBehind",value:function(e,t,n){for(var s=e.clone();s.x<i.P.tableX&&n.overlapsAny(s,t);)s.x+=o.R/8;for(;s.x>-i.P.tableX&&n.overlapsAny(s,t);)s.x-=o.R/8;t.pos.copy(s),t.state=r.U.Stationary}},{key:"closest",value:function(e,t){var n=t.filter(function(e){return e.onTable()}).filter(function(t){return t!==e});if(0!==n.length){var r=function(t){return e.pos.distanceTo(t.pos)};return n.reduce(function(e,t){return r(e)<r(t)?e:t},n[0])}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/utils/utils.ts"(e,t,n){n.d(t,{Dz:()=>f,F8:()=>b,FP:()=>v,KM:()=>l,RZ:()=>w,gn:()=>g,ld:()=>m,n7:()=>y,oN:()=>k,rq:()=>p,t6:()=>s,up:()=>o,v_:()=>i,xb:()=>u});var r=n("./node_modules/three/build/three.core.js"),i=new r.Pq0(0,0,0),o=new r.Pq0(0,0,1);function s(e){return new r.Pq0(e.x,e.y,e.z)}var a=new r.Pq0;function l(e){return a.copy(o).cross(e)}var c=new r.Pq0;function u(e){return c.copy(e).normalize()}var h=new r.Pq0;function p(e,t){return 0>=h.copy(e).add(t).dot(e)}function f(e){return new r.Pq0(1,0,0).applyAxisAngle(o,e)}function d(e){return Math.sign(e)*Math.floor((Math.abs(e)+Number.EPSILON)*1e4)/1e4}function m(e){return e.x=d(e.x),e.y=d(e.y),e.z=d(e.z),e}function v(e,t){return Math.fround(Math.atan2(e,t))}function y(e,t){return Math.fround(Math.pow(e,t))}function b(e){return Math.fround(Math.sin(e))}function g(e){return Math.fround(Math.cos(e))}function w(e){return Math.fround(Math.sqrt(e))}function k(e){return Math.fround(Math.exp(e))}},"./src/view/assets.ts"(e,t,n){n.d(t,{s:()=>v});var r=n("./src/controller/rules/rulefactory.ts"),i=n("./src/utils/gltf.ts"),o=n("./node_modules/three/build/three.core.js");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");s(this,"listener",void 0),s(this,"audioLoader",void 0),s(this,"ballcollision",void 0),s(this,"cue",void 0),s(this,"cushion",void 0),s(this,"pot",void 0),s(this,"success",void 0),s(this,"lastOutcomeTime",0),s(this,"loadAssets",void 0),this.loadAssets=e,e&&(this.listener=new o.Pf$,this.audioLoader=new o.Am1,this.ballcollision=new o.fP5(this.listener),this.load("sounds/ballcollision.ogg",this.ballcollision),this.cue=new o.fP5(this.listener),this.load("sounds/cue.ogg",this.cue),this.cushion=new o.fP5(this.listener),this.load("sounds/cushion.ogg",this.cushion),this.pot=new o.fP5(this.listener),this.load("sounds/pot.ogg",this.pot),this.success=new o.fP5(this.listener),this.load("sounds/success.ogg",this.success))}return e=[{key:"addCameraToListener",value:function(e){e.add(this.listener)}},{key:"load",value:function(e,t){this.audioLoader.load(e,function(e){t.setBuffer(e),t.setLoop(!1)},function(e){},function(e){})}},{key:"play",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this.loadAssets){var r,i,s=o.UtX.getContext();if((null==s?void 0:s.state)==="suspended"){(null==(i=navigator)||null==(r=i.userActivation)?void 0:r.hasBeenActive)&&s.resume();return}e.setVolume(t),e.isPlaying&&e.stop(),e.play(o.cj9.randFloat(0,.01)),e.setDetune(n)}}},{key:"outcomeToSound",value:function(e){"Collision"===e.type&&this.play(this.ballcollision,e.incidentSpeed/80,5*e.incidentSpeed),"Pot"===e.type&&this.play(this.pot,e.incidentSpeed/10,-1e3+10*e.incidentSpeed),"Cushion"===e.type&&this.play(this.cushion,e.incidentSpeed/70),"Hit"===e.type&&this.play(this.cue,e.incidentSpeed/30)}},{key:"processOutcomes",value:function(e){var t=this;e.every(function(e){return!(e.timestamp>t.lastOutcomeTime)||(t.lastOutcomeTime=e.timestamp,t.outcomeToSound(e),!1)})}},{key:"playNotify",value:function(){this.play(this.pot,1)}},{key:"playSuccess",value:function(e){this.play(this.success,.1,100*e-2200)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),l=n("./src/view/tablegeometry.ts"),c=n("./src/view/pocketgeometry.ts"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"logger",function(e){}),h(this,"cloth",new o.tXL({color:4478393,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"cushion",new o.tXL({color:5531065,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"pocket",new o.tXL({color:4478361,wireframe:!1,flatShading:!0,transparent:!0,opacity:.3}))}return e=[{key:"generateTable",value:function(e){var t=this,n=new o.YJl,r=new o.HiM(0xf0f0e8,22);if(r.position.set(0,0,50*u.R),n.add(r),this.addCushions(n,e),e){c.f.knuckles.forEach(function(e){return t.knuckleCylinder(e,n)}),c.f.pocketCenters.forEach(function(e){return t.knuckleCylinder(e,n,t.pocket)});var i=c.f.pockets.pocketNW.pocket,s=c.f.pockets.pocketNW.knuckleNE;this.logger("knuckle-pocket gap = "+(i.pos.distanceTo(s.pos)-i.radius-s.radius))}return n}},{key:"knuckleCylinder",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.cloth;this.cylinder(e.pos,e.radius,.75*u.R/.5,t,n).position.setZ(-(.25*u.R)/.5/2)}},{key:"cylinder",value:function(e,t,n,r,i){var s=new o.Ho_(t,t,n,16),a=new o.eaF(s,i);return a.position.copy(e),a.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),Math.PI/2)),r.add(a),a}},{key:"addCushions",value:function(e,t){var n=10*u.R/.5;this.plane(new o.Pq0(0,0,-u.R-n/2),2*l.P.X,2*l.P.Y,n,e,this.cloth);var r=u.R/.5,i=.75*u.R/.5,s=-(.25*u.R)/.5/2,a=l.P.X,h=l.P.Y,p=Math.abs(c.f.pockets.pocketNW.knuckleNE.pos.x-c.f.pockets.pocketN.knuckleNW.pos.x),f=Math.abs(c.f.pockets.pocketNW.knuckleSW.pos.y-c.f.pockets.pocketSW.knuckleNW.pos.y);t||(p=2*l.P.Y,f=2*l.P.Y+4*u.R),this.plane(new o.Pq0(a+r/2,0,s),r,f,i,e),this.plane(new o.Pq0(-a-r/2,0,s),r,f,i,e),this.plane(new o.Pq0(-a/2,h+r/2,s),p,r,i,e),this.plane(new o.Pq0(-a/2,-h-r/2,s),p,r,i,e),this.plane(new o.Pq0(a/2,h+r/2,s),p,r,i,e),this.plane(new o.Pq0(a/2,-h-r/2,s),p,r,i,e)}},{key:"plane",value:function(e,t,n,r,i){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.cushion,a=new o.iNn(t,n,r),l=new o.eaF(a,s);l.receiveShadow=!0,l.position.copy(e),i.add(l)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();h(p,"mesh",void 0);var f=n("./src/view/cuemesh.ts");function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");m(this,"ready",void 0),m(this,"rules",void 0),m(this,"background",void 0),m(this,"table",void 0),m(this,"cue",void 0),m(this,"ballModels",new Map),m(this,"loadingBalls",0),m(this,"sound",void 0),this.rules=r.V.create(e,null),this.rules.tableGeometry()}return e=[{key:"loadFromWeb",value:function(e){var t=this;if(this.ready=e,this.sound=new a(!0),(0,i.Ro)("models/background.gltf",function(e){t.background=e.scene,t.done()}),(0,i.Ro)(this.rules.asset(),function(e){t.table=e.scene,p.mesh=e.scene.children[0],t.done()}),"eightball"===this.rules.rulename){var n=function(e){(0,i.Ro)("pooltool_pocket/".concat(e,".glb"),function(n){t.ballModels.set(e,n.scene.children[0]),t.loadingBalls--,t.done()})};(0,i.Ro)("pooltool_pocket/cue.glb",function(e){t.cue=e,f.l.mesh=e.scene.children[0],t.ballModels.set(0,e.scene.children[0]),t.done()}),this.loadingBalls=15;for(var r=1;r<=15;r++)n(r)}else(0,i.Ro)("models/cue.gltf",function(e){t.cue=e,f.l.mesh=e.scene.children[0],t.done()})}},{key:"creatLocal",value:function(){this.sound=new a(!1),p.mesh=new p().generateTable(l.P.hasPockets),this.table=p.mesh}},{key:"done",value:function(){var e="eightball"!==this.rules.rulename||0===this.loadingBalls;this.background&&this.table&&this.cue&&e&&this.ready()}}],t=[{key:"localAssets",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=new n(e);return t.creatLocal(),t}}],e&&d(n.prototype,e),t&&d(n,t),n}()},"./src/view/ballmesh.ts"(e,t,n){n.d(t,{J:()=>u});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/model/ball.ts"),o=n("./src/utils/utils.ts"),s=n("./src/model/physics/constants.ts");function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");a(this,"line",void 0),a(this,"geometry",void 0),a(this,"positions",void 0),a(this,"lastPos",new r.Pq0),a(this,"lastVel",new r.Pq0),this.geometry=new r.LoY,this.positions=new Float32Array(3*e),this.geometry.setAttribute("position",new r.THS(this.positions,3)),this.reset();var i=new r.mrM({color:n,opacity:.25,linewidth:3,transparent:!0});this.line=new r.N1A(this.geometry,i),this.line.visible=!1}return e=[{key:"reset",value:function(){this.geometry.setDrawRange(0,0),this.lastVel.setZ(1)}},{key:"forceTrace",value:function(e){this.lastVel.z=1,this.addTraceGiven(e,this.lastVel,1,.1,1)}},{key:"addTrace",value:function(e,t){if(0!==t.length()){var n=this.lastVel.angleTo(t),r=n>Math.PI/32?.01*s.R:s.R,i=this.lastPos.distanceTo(e);this.addTraceGiven(e,t,i,r,n)}}},{key:"addTraceGiven",value:function(e,t,n,r,i){var o=this.geometry.drawRange.count;0!==o&&n<r||(o>1&&i<1e-4&&o--,this.lastPos.copy(e),this.lastVel.copy(t),this.addPoint(e,o))}},{key:"addPoint",value:function(e,t){var n=3*t;n>this.positions.length||(this.positions[n++]=e.x,this.positions[n++]=e.y,this.positions[n]=e.z,this.geometry.setDrawRange(0,t+1),this.line.geometry.attributes.position.needsUpdate=!0)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2?arguments[2]:void 0;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"mesh",void 0),c(this,"shadow",void 0),c(this,"spinAxisArrow",void 0),c(this,"trace",void 0),c(this,"color",void 0),c(this,"isStripe",void 0),c(this,"ballNumber",void 0),c(this,"shadowLightDir",new r.Pq0(-.4,-.6,-1).normalize()),c(this,"shadowOffset",new r.Pq0),c(this,"m",new r.kn4),this.color=new r.Q1f(e),this.isStripe=n,this.ballNumber=i,this.initialiseMesh(e)}return e=[{key:"updateAll",value:function(e,t){this.updatePosition(e.pos),this.updateArrows(e.pos,e.rvel,e.state),0!==e.rvel.lengthSq()&&(this.updateRotation(e.rvel,t),this.trace.addTrace(e.pos,e.vel))}},{key:"updatePosition",value:function(e){this.mesh.position.copy(e);var t=Math.max(0,e.z);this.shadowOffset.set(this.shadowLightDir.x*t*.6,this.shadowLightDir.y*t*.6,0),this.shadow.position.set(e.x+this.shadowOffset.x,e.y+this.shadowOffset.y,.001);var n=Math.max(.4,Math.min(1,1-t/(2*s.R)));this.shadow.scale.set(n,n,1)}},{key:"updateRotation",value:function(e,t){var n=e.length()*t;this.mesh.rotateOnWorldAxis((0,o.xb)(e),n)}},{key:"updateArrows",value:function(e,t,n){this.spinAxisArrow.setLength(s.R+s.R*t.length()/2,s.R,s.R),this.spinAxisArrow.position.copy(e),this.spinAxisArrow.setDirection((0,o.xb)(t)),n==i.U.Rolling?this.spinAxisArrow.setColor(0xcc0000):this.spinAxisArrow.setColor(52224)}},{key:"initialiseMesh",value:function(e){if(void 0!==this.ballNumber&&t.ballModels.has(this.ballNumber)){var n=t.ballModels.get(this.ballNumber);t.sharedGeometries.has(this.ballNumber)||(t.sharedGeometries.set(this.ballNumber,n.geometry),t.sharedMaterials.set(this.ballNumber,n.material));var i=t.sharedGeometries.get(this.ballNumber),a=t.sharedMaterials.get(this.ballNumber);this.mesh=new r.eaF(i,a),this.mesh.name="ball",this.mesh.scale.set(+s.R,+s.R,+s.R)}else{var c=new r.WBB(s.R,1),u=new r.tXL({emissive:0,flatShading:!0,vertexColors:!0,forceSinglePass:!0,shininess:25,specular:5592371});this.addDots(c,e),this.mesh=new r.eaF(c,u),this.mesh.name="ball"}this.updateRotation(new r.Pq0().random(),100);var h=new r.tcD(.9*s.R,9),p=new r.V9B({color:1118498,transparent:!0,opacity:.5});this.shadow=new r.eaF(h,p),this.spinAxisArrow=new r.E0M(o.up,o.v_,2,0,.01,.01),this.spinAxisArrow.visible=!1,this.trace=new l(500,e)}},{key:"addDots",value:function(e,t){var n=this,i=e.attributes.position.count,o=new r.Q1f(t),a=new r.Q1f(0xffffff),l=new r.Q1f(0xaa2222),c=new r.Q1f(0);e.setAttribute("color",new r.THS(new Float32Array(3*i),3));for(var u=e.attributes.color,h=e.attributes.position,p=0;p<i/3;p++){var f=new r.Pq0(h.getX(3*p),h.getY(3*p),h.getZ(3*p)),d=new r.Pq0(h.getX(3*p+1),h.getY(3*p+1),h.getZ(3*p+1)),m=new r.Pq0(h.getX(3*p+2),h.getY(3*p+2),h.getZ(3*p+2)),v=new r.Pq0().addVectors(f,d).add(m).divideScalar(3);this.isStripe?v.z>-(.3*s.R)&&v.z<.3*s.R?this.colorVerticesForFace(p,u,this.scaleNoise(o.r),this.scaleNoise(o.g),this.scaleNoise(o.b)):this.colorVerticesForFace(p,u,a.r,a.g,a.b):this.colorVerticesForFace(p,u,this.scaleNoise(o.r),this.scaleNoise(o.g),this.scaleNoise(o.b))}if(void 0!==this.ballNumber&&this.ballNumber>0&&8!==this.ballNumber){var y=[0,96,111,156,186,195].slice(0,Math.min(this.ballNumber,6)),b=this.isStripe||0xffd700===t?c:l;y.forEach(function(e){n.colorVerticesForFace(e/3,u,b.r,b.g,b.b)})}}},{key:"addToScene",value:function(e){e.add(this.mesh),e.add(this.shadow),e.add(this.spinAxisArrow),e.add(this.trace.line)}},{key:"colorVerticesForFace",value:function(e,t,n,r,i){t.setXYZ(3*e+0,n,r,i),t.setXYZ(3*e+1,n,r,i),t.setXYZ(3*e+2,n,r,i)}},{key:"scaleNoise",value:function(e){return(1-.25*Math.random())*e}},{key:"setBallNumber",value:function(e){if(this.ballNumber!==e){this.ballNumber=e,this.isStripe=e>8,this.color=new r.Q1f(null!=(t=({0:0xfaebd7,1:0xffcc00,2:255,3:0xff0000,4:8388736,5:0xff4500,6:32768,7:9109504,8:0,9:0xffcc00,10:255,11:0xff0000,12:8388736,13:0xff4500,14:32768,15:9109504})[e])?t:0xeeeeee);var t,n=this.mesh.position.clone(),i=this.mesh.parent;i&&i.remove(this.mesh),this.initialiseMesh(this.color.getHex()),this.mesh.position.copy(n),i&&i.add(this.mesh)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();c(u,"ballModels",new Map),c(u,"sharedGeometries",new Map),c(u,"sharedMaterials",new Map)},"./src/view/cameratop.ts"(e,t,n){n.d(t,{v:()=>a});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"viewPoint",value:function(e,n){var s=t.zoomFactor/(2*Math.tan(n*Math.PI/360));if(e>this.portrait){var a=e>t.aspectLimit?2.75*i.P.tableY:2.4*i.P.tableX/e;return new r.Pq0(0,-.01*o.R,s*a)}var l=e>1/t.aspectLimit?4.9*i.P.tableY:1.35*i.P.tableX/e;return new r.Pq0(-.01*o.R,0,s*l)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();s(a,"aspectLimit",1.78),s(a,"portrait",.95),s(a,"fov",20),s(a,"zoomFactor",1)},"./src/view/cue.ts"(e,t,n){n.d(t,{s:()=>p});var r=n("./src/view/tablegeometry.ts"),i=n("./src/utils/utils.ts"),o=n("./src/events/aimevent.ts"),s=n("./src/model/ball.ts"),a=n("./src/model/physics/physics.ts"),l=n("./src/view/cuemesh.ts"),c=n("./node_modules/three/build/three.core.js"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"mesh",void 0),h(this,"helperMesh",void 0),h(this,"placerMesh",void 0),h(this,"offCenterLimit",.3),h(this,"maxPower",160*u.R),h(this,"t",0),h(this,"aimInputs",void 0),h(this,"aim",new o.w),h(this,"length",+r.P.tableX),this.mesh=l.l.createCue(.05*u.R/.5,.15*u.R/.5,this.length),this.helperMesh=l.l.createHelper(),this.placerMesh=l.l.createPlacer()}return e=[{key:"rotateAim",value:function(e,t){this.aim.angle=this.aim.angle+e,this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle,this.aimInputs.showOverlap(),this.avoidCueTouchingOtherBall(t)}},{key:"adjustPower",value:function(e){this.aim.power=Math.min(this.maxPower,this.aim.power+e),this.updateAimInput()}},{key:"setPower",value:function(e){this.aim.power=e*this.maxPower}},{key:"hit",value:function(e){var t=this.aim;this.t=0,e.state=s.U.Sliding,e.vel.copy((0,i.Dz)(t.angle).multiplyScalar(t.power)),e.rvel.copy((0,a.t6)(t.offset,e.vel))}},{key:"aimAtNext",value:function(e,t){if(t){var n=(0,i.xb)(t.pos.clone().sub(e.pos));this.aim.angle=(0,i.FP)(n.y,n.x)}}},{key:"adjustSpin",value:function(e,t){var n=this.aim.offset.clone().clone().add(e);this.setSpin(n,t)}},{key:"setSpin",value:function(e,t){e.length()>this.offCenterLimit&&e.normalize().multiplyScalar(this.offCenterLimit),this.aim.offset.copy(e),this.avoidCueTouchingOtherBall(t),this.updateAimInput()}},{key:"avoidCueTouchingOtherBall",value:function(e){for(var t=0;t++<20&&this.intersectsAnything(e);)this.aim.offset.y+=.1,this.aim.offset.length()>this.offCenterLimit&&this.aim.offset.normalize().multiplyScalar(this.offCenterLimit);t>1&&this.updateAimInput()}},{key:"updateAimInput",value:function(){var e,t,n;null==(e=this.aimInputs)||e.updateVisualState(this.aim.offset.x,this.aim.offset.y),null==(t=this.aimInputs)||t.updatePowerSlider(this.aim.power/this.maxPower),null==(n=this.aimInputs)||n.showOverlap()}},{key:"moveTo",value:function(e){this.aim.pos.copy(e),this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle;var t=this.spinOffset(),n=((0,i.F8)(this.t+Math.PI/2)-1)*2*u.R*(this.aim.power/this.maxPower),r=(0,i.Dz)(this.aim.angle).clone().multiplyScalar(n);this.mesh.position.copy(e.clone().add(t).add(r)),this.helperMesh.position.copy(e),this.placerMesh.position.copy(e),this.placerMesh.rotation.z=this.t}},{key:"update",value:function(e){this.t+=e,this.moveTo(this.aim.pos)}},{key:"placeBallMode",value:function(){this.mesh.visible=!1,this.placerMesh.visible=!0,this.aim.angle=0}},{key:"aimMode",value:function(){this.mesh.visible=!0,this.placerMesh.visible=!1}},{key:"spinOffset",value:function(){return(0,i.KM)((0,i.Dz)(this.aim.angle)).multiplyScalar(2*this.aim.offset.x*u.R).setZ(2*this.aim.offset.y*u.R)}},{key:"intersectsAnything",value:function(e){var t=this.spinOffset(),n=e.cueball.pos.clone().add(t),r=(0,i.xb)((0,i.Dz)(this.aim.angle+Math.PI).setZ(.1)),o=new c.tBo(n,r),s=e.balls.map(function(e){return e.ballmesh.mesh});return e.mesh&&s.push(e.mesh),o.intersectObjects(s,!0).length>0}},{key:"showHelper",value:function(e){this.helperMesh.visible=e}},{key:"toggleHelper",value:function(){this.showHelper(!this.helperMesh.visible)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/view/cuemesh.ts"(e,t,n){n.d(t,{l:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/utils/utils.ts"),o=n("./node_modules/three/build/three.core.js");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"indicateValid",value:function(e){t.placermaterial.color.setHex(e?0xccffcc:0xff0000)}},{key:"createHelper",value:function(){var e=new o.Ho_(r.R,r.R,30*r.R/.5,12,1,!0),t=new o.eaF(e,this.helpermaterial);return t.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(15*r.R/.5,0,-(.01*r.R)/.5)),t.visible=!1,t.renderOrder=-1,t.material.depthTest=!1,t}},{key:"createPlacer",value:function(){var e=new o.Ho_(.01*r.R/.5,r.R,r.R,4),n=new o.eaF(e,t.placermaterial);return n.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(0,0,.7*r.R/.5)),n.visible=!1,n}},{key:"createCue",value:function(e,n,s){var a=new o.Ho_(e,n,s,11),l=new o.eaF(a,t.material);return l.castShadow=!1,l.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),-.17)).applyMatrix4(new o.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(-s/2-r.R,0,s/2*.16918234906699603+.25*r.R)),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();s(a,"mesh",void 0),s(a,"material",new o.tXL({color:8934775,wireframe:!1,flatShading:!1})),s(a,"placermaterial",new o.tXL({color:0xccffcc,wireframe:!1,flatShading:!1,transparent:!0,opacity:.5})),s(a,"helpermaterial",new o.BKk({uniforms:{lightDirection:{value:new o.Pq0(0,0,1)}},vertexShader:`
      varying vec2 vUv;
      varying vec3 vNormal;  
      void main() {
        vNormal = normal;
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
      }
    `,fragmentShader:`
      varying vec2 vUv;
      varying vec3 vNormal;
      uniform vec3 lightDirection;
      void main() {
        float intensity = dot(vNormal, lightDirection);
        vec3 color = vec3(1.0, 1.0, 1.0);
        vec3 finalColor = color * intensity;
        gl_FragColor = vec4(finalColor, 0.05 * (1.0-vUv.y));
      }
    `,wireframe:!1,transparent:!0}))},"./src/view/hud.ts"(e,t,n){function r(e,t,n){return t=l(t),function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e,h()?Reflect.construct(t,n||[],l(e).constructor):t.apply(e,n))}function i(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(h=function(){return!!e})()}n.r(t),n.d(t,{EightBallHud:()=>d,Hud:()=>p,SnookerHud:()=>f});var p=function(){function e(){i(this,e)}return s(e,[{key:"updateBreak",value:function(e){}},{key:"updateGroups",value:function(e){}}]),e}(),f=function(e){function t(){var e;return i(this,t),a(e=r(this,t),"element",void 0),e.element=e.getElement("snookerScore"),e}return c(t,e),s(t,[{key:"updateBreak",value:function(e){this.element&&(e>0?this.element.innerHTML="Break</br>"+e:this.element.innerHTML="")}},{key:"getElement",value:function(e){return document.getElementById(e)}}]),t}(p),d=function(e){function t(){var e;return i(this,t),a(e=r(this,t),"breakElement",void 0),a(e,"groupElement",void 0),e.breakElement=e.getElement("eightBallBreak"),e.groupElement=e.getElement("eightBallGroup"),e.clear(),e}return c(t,e),s(t,[{key:"updateBreak",value:function(e){this.breakElement&&(e>0?this.breakElement.innerHTML="Break: ".concat(e):this.breakElement.innerHTML="")}},{key:"updateGroups",value:function(e){this.groupElement&&(e?"solids"===e?this.groupElement.innerHTML="You: Solids":this.groupElement.innerHTML="You: Stripes":this.groupElement.innerHTML="Table: Open")}},{key:"clear",value:function(){this.updateBreak(0),this.updateGroups(null)}},{key:"getElement",value:function(e){return document.getElementById(e)}}]),t}(p)},"./src/view/pocketgeometry.ts"(e,t,n){n.d(t,{f:()=>c});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/model/physics/knuckle.ts"),o=n("./src/model/physics/pocket.ts"),s=n("./src/view/tablegeometry.ts"),a=n("./src/model/physics/constants.ts");function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"scaleToRadius",value:function(e){t.PX=s.P.tableX+1.6*e,t.PY=s.P.tableY+1.6*e,t.knuckleInset=1.6*e/.5,t.knuckleRadius=.31*e/.5,t.middleKnuckleInset=1.385*e/.5,t.middleKnuckleRadius=.2*e/.5,t.cornerRadius=1.1*e/.5,t.middleRadius=.9*e/.5,t.pocketLayout(e),t.enumerateCenters(),t.enumerateKnuckles()}},{key:"enumerateKnuckles",value:function(){t.knuckles=[t.pockets.pocketNW.knuckleNE,t.pockets.pocketNW.knuckleSW,t.pockets.pocketN.knuckleNW,t.pockets.pocketN.knuckleNE,t.pockets.pocketS.knuckleSW,t.pockets.pocketS.knuckleSE,t.pockets.pocketNE.knuckleNW,t.pockets.pocketNE.knuckleSE,t.pockets.pocketSE.knuckleNE,t.pockets.pocketSE.knuckleSW,t.pockets.pocketSW.knuckleSE,t.pockets.pocketSW.knuckleNW]}},{key:"enumerateCenters",value:function(){t.pocketCenters=[t.pockets.pocketNW.pocket,t.pockets.pocketSW.pocket,t.pockets.pocketN.pocket,t.pockets.pocketS.pocket,t.pockets.pocketNE.pocket,t.pockets.pocketSE.pocket]}},{key:"pocketLayout",value:function(e){t.pockets={pocketNW:{pocket:new o.Z(new r.Pq0(-t.PX,t.PY,0),t.cornerRadius),knuckleNE:new i.O(new r.Pq0(-s.P.X+t.knuckleInset,s.P.Y+t.knuckleRadius,0),t.knuckleRadius),knuckleSW:new i.O(new r.Pq0(-s.P.X-t.knuckleRadius,s.P.Y-t.knuckleInset,0),t.knuckleRadius)},pocketN:{pocket:new o.Z(new r.Pq0(0,t.PY+.7*e/.5,0),t.middleRadius),knuckleNE:new i.O(new r.Pq0(t.middleKnuckleInset,s.P.Y+t.middleKnuckleRadius,0),t.middleKnuckleRadius),knuckleNW:new i.O(new r.Pq0(-t.middleKnuckleInset,s.P.Y+t.middleKnuckleRadius,0),t.middleKnuckleRadius)},pocketS:{pocket:new o.Z(new r.Pq0(0,-t.PY-.7*e/.5,0),t.middleRadius),knuckleSE:new i.O(new r.Pq0(t.middleKnuckleInset,-s.P.Y-t.middleKnuckleRadius,0),t.middleKnuckleRadius),knuckleSW:new i.O(new r.Pq0(-t.middleKnuckleInset,-s.P.Y-t.middleKnuckleRadius,0),t.middleKnuckleRadius)},pocketNE:{pocket:new o.Z(new r.Pq0(t.PX,t.PY,0),t.cornerRadius),knuckleNW:new i.O(new r.Pq0(s.P.X-t.knuckleInset,s.P.Y+t.knuckleRadius,0),t.knuckleRadius),knuckleSE:new i.O(new r.Pq0(s.P.X+t.knuckleRadius,s.P.Y-t.knuckleInset,0),t.knuckleRadius)},pocketSE:{pocket:new o.Z(new r.Pq0(t.PX,-t.PY,0),t.cornerRadius),knuckleNE:new i.O(new r.Pq0(s.P.X+t.knuckleRadius,-s.P.Y+t.knuckleInset,0),t.knuckleRadius),knuckleSW:new i.O(new r.Pq0(s.P.X-t.knuckleInset,-s.P.Y-t.knuckleRadius,0),t.knuckleRadius)},pocketSW:{pocket:new o.Z(new r.Pq0(-t.PX,-t.PY,0),t.cornerRadius),knuckleSE:new i.O(new r.Pq0(-s.P.X+t.knuckleInset,-s.P.Y-t.knuckleRadius,0),t.knuckleRadius),knuckleNW:new i.O(new r.Pq0(-s.P.X-t.knuckleRadius,-s.P.Y+t.knuckleInset,0),t.knuckleRadius)}}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();l(c,"PX",void 0),l(c,"PY",void 0),l(c,"knuckleInset",void 0),l(c,"knuckleRadius",void 0),l(c,"middleKnuckleInset",void 0),l(c,"middleKnuckleRadius",void 0),l(c,"cornerRadius",void 0),l(c,"middleRadius",void 0),l(c,"pockets",void 0),l(c,"knuckles",void 0),l(c,"pocketCenters",void 0),c.scaleToRadius(a.R)},"./src/view/sliders.ts"(e,t,n){n.d(t,{r:()=>o});var r=n("./src/model/physics/constants.ts");function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o=function(){var e;function t(e){var n,o;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");i(this,"style",void 0),i(this,"notify",void 0),this.notify=null!=e?e:function(){},this.style=null!=(n=null==(o=document.getElementById("constants"))?void 0:o.style)?n:{},this.initialiseSlider("R",r.R,r.jG),this.initialiseSlider("m",r.m,r.Qg),this.initialiseSlider("e",r.e,r.cM),this.initialiseSlider("mu",r.mu,r.xO),this.initialiseSlider("muS",r.gf,r.Ys),this.initialiseSlider("muC",r.gT,r.kM),this.initialiseSlider("rho",r.kL,r.Wv),this.initialiseSlider("Œºs",r.oV,r.ko),this.initialiseSlider("Œºw",r._m,r.ki),this.initialiseSlider("ee",r.ee,r.PX)}return e=[{key:"toggleVisibility",value:function(){this.style.visibility="visible"===this.style.visibility?"hidden":"visible"}},{key:"getInputElement",value:function(e){var t;return null!=(t=document.getElementById(e))?t:{}}},{key:"initialiseSlider",value:function(e,t,n){var r=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=this.getInputElement(e);o&&(o.step="0.001",o.min="0.01",o.max="".concat(i),o.value=t,this.showValue(e,t),o.oninput=function(t){var i=parseFloat(t.target.value);n(i),r.showValue(e,i),r.notify()})}},{key:"showValue",value:function(e,t){var n=document.querySelector("label[for=".concat(e,"]"));n&&(n.innerHTML="".concat(e,"=").concat(t))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/view/tablegeometry.ts"(e,t,n){n.d(t,{P:()=>o});var r=n("./src/model/physics/constants.ts");function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"scaleToRadius",value:function(e){t.tableX=43*e,t.tableY=21*e,t.X=t.tableX+e,t.Y=t.tableY+e}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();i(o,"tableX",void 0),i(o,"tableY",void 0),i(o,"X",void 0),i(o,"Y",void 0),i(o,"hasPockets",!0),o.scaleToRadius(r.R)}},e=>{e(e.s="./src/index.ts")}]);